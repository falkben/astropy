


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astropy.tests.runner &#8212; Astropy v5.2.dev94+gb1133d712.d20220509</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
  <meta name="robots" content="noindex, nofollow">
  
  
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>


  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">Astropy v5.2.dev94+gb1133d712.d20220509</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astropy.tests.runner</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implements the Astropy TestRunner which is a thin wrapper around pytest.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">importlib.util</span> <span class="kn">import</span> <span class="n">find_spec</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">from</span> <span class="nn">astropy.config.paths</span> <span class="kn">import</span> <span class="n">set_temp_config</span><span class="p">,</span> <span class="n">set_temp_cache</span>
<span class="kn">from</span> <span class="nn">astropy.utils</span> <span class="kn">import</span> <span class="n">find_current_module</span>
<span class="kn">from</span> <span class="nn">astropy.utils.exceptions</span> <span class="kn">import</span> <span class="n">AstropyWarning</span><span class="p">,</span> <span class="n">AstropyDeprecationWarning</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TestRunner&#39;</span><span class="p">,</span> <span class="s1">&#39;TestRunnerBase&#39;</span><span class="p">,</span> <span class="s1">&#39;keyword&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="keyword"><a class="viewcode-back" href="../../../testhelpers.html#astropy.tests.runner.keyword">[docs]</a><span class="k">class</span> <span class="nc">keyword</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A decorator to mark a method as keyword argument for the ``TestRunner``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    default_value : `object`</span>
<span class="sd">        The default value for the keyword argument. (Default: `None`)</span>

<span class="sd">    priority : `int`</span>
<span class="sd">        keyword argument methods are executed in order of descending priority.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">default_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">keyword</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">keyword</span><span class="o">.</span><span class="n">_default_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span>
        <span class="n">keyword</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span>
        <span class="c1"># Set __doc__ explicitly here rather than using wraps because we want</span>
        <span class="c1"># to keep the function name as keyword so we can inspect it later.</span>
        <span class="n">keyword</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="k">return</span> <span class="n">keyword</span></div>


<div class="viewcode-block" id="TestRunnerBase"><a class="viewcode-back" href="../../../testhelpers.html#astropy.tests.runner.TestRunnerBase">[docs]</a><span class="k">class</span> <span class="nc">TestRunnerBase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class for the TestRunner.</span>

<span class="sd">    A test runner can be constructed by creating a subclass of this class and</span>
<span class="sd">    defining &#39;keyword&#39; methods. These are methods that have the</span>
<span class="sd">    :class:`~astropy.tests.runner.keyword` decorator, these methods are used to</span>
<span class="sd">    construct allowed keyword arguments to the</span>
<span class="sd">    ``run_tests`` method as a way to allow</span>
<span class="sd">    customization of individual keyword arguments (and associated logic)</span>
<span class="sd">    without having to re-implement the whole</span>
<span class="sd">    ``run_tests`` method.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    A simple keyword method::</span>

<span class="sd">        class MyRunner(TestRunnerBase):</span>

<span class="sd">            @keyword(&#39;default_value&#39;):</span>
<span class="sd">            def spam(self, spam, kwargs):</span>
<span class="sd">                \&quot;\&quot;\&quot;</span>
<span class="sd">                spam : `str`</span>
<span class="sd">                    The parameter description for the run_tests docstring.</span>
<span class="sd">                \&quot;\&quot;\&quot;</span>
<span class="sd">                # Return value must be a list with a CLI parameter for pytest.</span>
<span class="sd">                return [&#39;--spam={}&#39;.format(spam)]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Before constructing the class parse all the methods that have been</span>
        <span class="c1"># decorated with ``keyword``.</span>

        <span class="c1"># The objective of this method is to construct a default set of keyword</span>
        <span class="c1"># arguments to the ``run_tests`` method. It does this by inspecting the</span>
        <span class="c1"># methods of the class for functions with the name ``keyword`` which is</span>
        <span class="c1"># the name of the decorator wrapping function. Once it has created this</span>
        <span class="c1"># dictionary, it also formats the docstring of ``run_tests`` to be</span>
        <span class="c1"># comprised of the docstrings for the ``keyword`` methods.</span>

        <span class="c1"># To add a keyword argument to the ``run_tests`` method, define a new</span>
        <span class="c1"># method decorated with ``@keyword`` and with the ``self, name, kwargs``</span>
        <span class="c1"># signature.</span>
        <span class="c1"># Get all &#39;function&#39; members as the wrapped methods are functions</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">)</span>

        <span class="c1"># Filter out anything that&#39;s not got the name &#39;keyword&#39;</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">func</span><span class="p">:</span> <span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;keyword&#39;</span><span class="p">,</span> <span class="n">functions</span><span class="p">)</span>
        <span class="c1"># Sort all keywords based on the priority flag.</span>
        <span class="n">sorted_keywords</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_priority</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">doc_keywords</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">sorted_keywords</span><span class="p">:</span>
            <span class="c1"># Here we test if the function has been overloaded to return</span>
            <span class="c1"># NotImplemented which is the way to disable arguments on</span>
            <span class="c1"># subclasses. If it has been disabled we need to remove it from the</span>
            <span class="c1"># default keywords dict. We do it in the try except block because</span>
            <span class="c1"># we do not have access to an instance of the class, so this is</span>
            <span class="c1"># going to error unless the method is just doing `return</span>
            <span class="c1"># NotImplemented`.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Second argument is False, as it is normally a bool.</span>
                <span class="c1"># The other two are placeholders for objects.</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Construct the default kwargs dict and docstring</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">_default_value</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="n">doc_keywords</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="mi">8</span>
                <span class="n">doc_keywords</span> <span class="o">+=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">doc_keywords</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">run_tests</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">RUN_TESTS_DOCSTRING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="n">doc_keywords</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Update default values with passed kwargs</span>
        <span class="c1"># but don&#39;t modify the defaults</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
        <span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Iterate through the keywords (in order of priority)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">keyword</span><span class="p">],</span> <span class="n">keywords</span><span class="p">)</span>

            <span class="c1"># Allow disabling of options in a subclass</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_tests() got an unexpected keyword argument </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># keyword methods must return a list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> keyword method must return a list&quot;</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">+=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">args</span>

    <span class="n">RUN_TESTS_DOCSTRING</span> <span class="o">=</span> \
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the tests for the package.</span>

<span class="sd">        This method builds arguments for and then calls ``pytest.main``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">{keywords}</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="n">_required_dependencies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pytest&#39;</span><span class="p">,</span> <span class="s1">&#39;pytest_remotedata&#39;</span><span class="p">,</span> <span class="s1">&#39;pytest_doctestplus&#39;</span><span class="p">,</span> <span class="s1">&#39;pytest_astropy_header&#39;</span><span class="p">]</span>
    <span class="n">_missing_dependancy_error</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Test dependencies are missing: </span><span class="si">{module}</span><span class="s2">. You should install the &quot;</span>
        <span class="s2">&quot;&#39;pytest-astropy&#39; package (you may need to update the package if you &quot;</span>
        <span class="s2">&quot;have a previous version installed, e.g., &quot;</span>
        <span class="s2">&quot;&#39;pip install pytest-astropy --upgrade&#39; or the equivalent with conda).&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_has_test_dependencies</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># Using the test runner will not work without these dependencies, but</span>
        <span class="c1"># pytest-openfiles is optional, so it&#39;s not listed here.</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_required_dependencies</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">find_spec</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="c1"># Checking loader accounts for packages that were uninstalled</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_missing_dependancy_error</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># The following option will include eggs inside a .eggs folder in</span>
        <span class="c1"># sys.path when running the tests. This is possible so that when</span>
        <span class="c1"># running pytest, test dependencies installed via e.g.</span>
        <span class="c1"># tests_requires are available here. This is not an advertised option</span>
        <span class="c1"># since it is only for internal use</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;add_local_eggs_to_path&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>

            <span class="c1"># Add each egg to sys.path individually</span>
            <span class="k">for</span> <span class="n">egg</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.eggs&#39;</span><span class="p">,</span> <span class="s1">&#39;*.egg&#39;</span><span class="p">)):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">egg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_test_dependencies</span><span class="p">()</span>  <span class="c1"># pragma: no cover</span>

        <span class="c1"># The docstring for this method is defined as a class variable.</span>
        <span class="c1"># This allows it to be built for each subclass in __new__.</span>

        <span class="c1"># Don&#39;t import pytest until it&#39;s actually needed to run the tests</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="c1"># Raise error for undefined kwargs</span>
        <span class="n">allowed_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">passed_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">passed_kwargs</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">allowed_kwargs</span><span class="p">):</span>
            <span class="n">wrong_kwargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">passed_kwargs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">allowed_kwargs</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_tests() got an unexpected keyword argument </span><span class="si">{</span><span class="n">wrong_kwargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_args</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plugins&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;plugins&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plugins&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s1">&#39;plugins&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Override the config locations to not make a new directory nor use</span>
        <span class="c1"># existing cache or config. Note that we need to do this here in</span>
        <span class="c1"># addition to in conftest.py - for users running tests interactively</span>
        <span class="c1"># in e.g. IPython, conftest.py would get read in too late, so we need</span>
        <span class="c1"># to do it here - but at the same time the code here doesn&#39;t work when</span>
        <span class="c1"># running tests in parallel mode because this uses subprocesses which</span>
        <span class="c1"># don&#39;t know about the temporary config/cache.</span>
        <span class="n">astropy_config</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="s1">&#39;astropy_config&#39;</span><span class="p">)</span>
        <span class="n">astropy_cache</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="s1">&#39;astropy_cache&#39;</span><span class="p">)</span>

        <span class="c1"># Have to use nested with statements for cross-Python support</span>
        <span class="c1"># Note, using these context managers here is superfluous if the</span>
        <span class="c1"># config_dir or cache_dir options to pytest are in use, but it&#39;s</span>
        <span class="c1"># also harmless to nest the contexts</span>
        <span class="k">with</span> <span class="n">set_temp_config</span><span class="p">(</span><span class="n">astropy_config</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">set_temp_cache</span><span class="p">(</span><span class="n">astropy_cache</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">pytest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">plugins</span><span class="o">=</span><span class="n">plugins</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_test_runner_in</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a `TestRunner` to run in the given path, and returns a</span>
<span class="sd">        ``test()`` function which takes the same arguments as</span>
<span class="sd">        ``TestRunner.run_tests``.</span>

<span class="sd">        The returned ``test()`` function will be defined in the module this</span>
<span class="sd">        was called from.  This is used to implement the ``astropy.test()``</span>
<span class="sd">        function (or the equivalent for affiliated packages).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">runner</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run_tests</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">,))</span>
        <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">module</span> <span class="o">=</span> <span class="n">find_current_module</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># A somewhat unusual hack, but delete the attached __wrapped__</span>
        <span class="c1"># attribute--although this is normally used to tell if the function</span>
        <span class="c1"># was wrapped with wraps, on some version of Python this is also</span>
        <span class="c1"># used to determine the signature to display in help() which is</span>
        <span class="c1"># not useful in this case.  We don&#39;t really care in this case if the</span>
        <span class="c1"># function was wrapped either</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s1">&#39;__wrapped__&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">test</span><span class="o">.</span><span class="n">__wrapped__</span>

        <span class="n">test</span><span class="o">.</span><span class="n">__test__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">test</span></div>


<div class="viewcode-block" id="TestRunner"><a class="viewcode-back" href="../../../testhelpers.html#astropy.tests.runner.TestRunner">[docs]</a><span class="k">class</span> <span class="nc">TestRunner</span><span class="p">(</span><span class="n">TestRunnerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test runner for astropy tests</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">packages_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warning</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the path for multiple packages.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packages : str</span>
<span class="sd">            Comma separated string of packages.</span>
<span class="sd">        base_path : str</span>
<span class="sd">            Base path to the source code or documentation.</span>
<span class="sd">        error : str</span>
<span class="sd">            Error message to be raised as ``ValueError``. Individual package</span>
<span class="sd">            name and path can be accessed by ``{name}`` and ``{path}``</span>
<span class="sd">            respectively. No error is raised if `None`. (Default: `None`)</span>
<span class="sd">        warning : str</span>
<span class="sd">            Warning message to be issued. Individual package</span>
<span class="sd">            name and path can be accessed by ``{name}`` and ``{path}``</span>
<span class="sd">            respectively. No warning is issues if `None`. (Default: `None`)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        paths : list of str</span>
<span class="sd">            List of strings of existing package paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">base_path</span><span class="p">,</span> <span class="n">package</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">package</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">info</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">warning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">info</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">paths</span>

    <span class="c1"># Increase priority so this warning is displayed first.</span>
    <span class="nd">@keyword</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coverage</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">coverage</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The coverage option is ignored on run_tests, since it &quot;</span>
                <span class="s2">&quot;can not be made to work in that context.  Use &quot;</span>
                <span class="s2">&quot;&#39;python setup.py test --coverage&#39; instead.&quot;</span><span class="p">,</span>
                <span class="n">AstropyWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># test_path depends on self.package_path so make sure this runs before</span>
    <span class="c1"># test_path.</span>
    <span class="nd">@keyword</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        package : str, optional</span>
<span class="sd">            The name of a specific package to test, e.g. &#39;io.fits&#39; or</span>
<span class="sd">            &#39;utils&#39;. Accepts comma separated string to specify multiple</span>
<span class="sd">            packages. If nothing is specified all default tests are run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">package_path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;package to test is not found: </span><span class="si">{name}</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;(at path </span><span class="si">{path}</span><span class="s1">).&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">package_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages_path</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">,</span>
                                                   <span class="n">error</span><span class="o">=</span><span class="n">error_message</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;test_path&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_path</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">test_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_path</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test_path : str, optional</span>
<span class="sd">            Specify location to test by path. May be a single file or</span>
<span class="sd">            directory. Must be specified absolutely or relative to the</span>
<span class="sd">            calling directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Ensure that the package kwarg has been run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_path</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">test_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.rst&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;docs_path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># This shouldn&#39;t happen from &quot;python setup.py test&quot;</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Can not test .rst files without a docs_path &quot;</span>
                        <span class="s2">&quot;specified.&quot;</span><span class="p">)</span>

                <span class="n">abs_docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;docs_path&#39;</span><span class="p">])</span>
                <span class="n">abs_test_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_docs_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="n">test_path</span><span class="p">))</span>

                <span class="n">common</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">((</span><span class="n">abs_docs_path</span><span class="p">,</span> <span class="n">abs_test_path</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abs_test_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">common</span> <span class="o">==</span> <span class="n">abs_docs_path</span><span class="p">:</span>
                    <span class="c1"># Turn on the doctest_rst plugin</span>
                    <span class="n">all_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--doctest-rst&#39;</span><span class="p">)</span>
                    <span class="n">test_path</span> <span class="o">=</span> <span class="n">abs_test_path</span>

            <span class="c1"># Check that the extensions are in the path and not at the end to</span>
            <span class="c1"># support specifying the name of the test, i.e.</span>
            <span class="c1"># test_quantity.py::test_unit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">test_path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;.py&#39;</span> <span class="ow">in</span> <span class="n">test_path</span> <span class="ow">or</span> <span class="s1">&#39;.rst&#39;</span> <span class="ow">in</span> <span class="n">test_path</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test path must be a directory or a path to &quot;</span>
                                 <span class="s2">&quot;a .py or .rst file&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">all_args</span> <span class="o">+</span> <span class="p">[</span><span class="n">test_path</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        args : str, optional</span>
<span class="sd">            Additional arguments to be passed to ``pytest.main`` in the ``args``</span>
<span class="sd">            keyword argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">def</span> <span class="nf">plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugins</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plugins : list, optional</span>
<span class="sd">            Plugins to be passed to ``pytest.main`` in the ``plugins`` keyword</span>
<span class="sd">            argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Plugins are handled independently by `run_tests` so we define this</span>
        <span class="c1"># keyword just for the docstring</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Convenience option to turn on verbose output from pytest. Passing</span>
<span class="sd">            True is the same as specifying ``-v`` in ``args``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-v&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">pastebin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pastebin</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pastebin : (&#39;failed&#39;, &#39;all&#39;, None), optional</span>
<span class="sd">            Convenience option for turning on pytest pastebin output. Set to</span>
<span class="sd">            &#39;failed&#39; to upload info for failed tests, or &#39;all&#39; to upload info</span>
<span class="sd">            for all tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pastebin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pastebin</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;--pastebin=</span><span class="si">{</span><span class="n">pastebin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pastebin should be &#39;failed&#39; or &#39;all&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remote_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remote_data : {&#39;none&#39;, &#39;astropy&#39;, &#39;any&#39;}, optional</span>
<span class="sd">            Controls whether to run tests marked with @pytest.mark.remote_data. This can be</span>
<span class="sd">            set to run no tests with remote data (``none``), only ones that use</span>
<span class="sd">            data from http://data.astropy.org (``astropy``), or all tests that</span>
<span class="sd">            use remote data (``any``). The default is ``none``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">remote_data</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">remote_data</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span>
        <span class="k">elif</span> <span class="n">remote_data</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">remote_data</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">elif</span> <span class="n">remote_data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;astropy&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The remote_data option should be one of &quot;</span>
                          <span class="s2">&quot;none/astropy/any (found </span><span class="si">{}</span><span class="s2">). For backward-compatibility, &quot;</span>
                          <span class="s2">&quot;assuming &#39;any&#39;, but you should change the option to be &quot;</span>
                          <span class="s2">&quot;one of the supported ones to avoid issues in &quot;</span>
                          <span class="s2">&quot;future.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote_data</span><span class="p">),</span>
                          <span class="n">AstropyDeprecationWarning</span><span class="p">)</span>
            <span class="n">remote_data</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span>

        <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;--remote-data=</span><span class="si">{</span><span class="n">remote_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">pep8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pep8</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pep8 : bool, optional</span>
<span class="sd">            Turn on PEP8 checking via the pytest-pep8 plugin and disable normal</span>
<span class="sd">            tests. Same as specifying ``--pep8 -k pep8`` in ``args``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pep8</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pytest_pep8</span>  <span class="c1"># pylint: disable=W0611</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;PEP8 checking requires pytest-pep8 plugin: &#39;</span>
                                  <span class="s1">&#39;https://pypi.org/project/pytest-pep8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;--pep8&#39;</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;pep8&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pdb : bool, optional</span>
<span class="sd">            Turn on PDB post-mortem analysis for failing tests. Same as</span>
<span class="sd">            specifying ``--pdb`` in ``args``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pdb</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;--pdb&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">open_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_files</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        open_files : bool, optional</span>
<span class="sd">            Fail when any tests leave files open.  Off by default, because</span>
<span class="sd">            this adds extra run time to the test suite.  Requires the</span>
<span class="sd">            ``psutil`` package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">open_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span>
                    <span class="s2">&quot;open file detection may not be used in conjunction with &quot;</span>
                    <span class="s2">&quot;parallel testing.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">psutil</span>  <span class="c1"># pylint: disable=W0611</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span>
                    <span class="s2">&quot;open file detection requested, but psutil package &quot;</span>
                    <span class="s2">&quot;is not installed.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;--open-files&#39;</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking for unclosed files&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parallel : int or &#39;auto&#39;, optional</span>
<span class="sd">            When provided, run the tests in parallel on the specified</span>
<span class="sd">            number of CPUs.  If parallel is ``&#39;auto&#39;``, it will use the all</span>
<span class="sd">            the cores on the machine.  Requires the ``pytest-xdist`` plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parallel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">xdist</span> <span class="kn">import</span> <span class="n">plugin</span> <span class="c1"># noqa</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span>
                    <span class="s2">&quot;running tests in parallel requires the pytest-xdist package&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">parallel</span><span class="p">)]</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">docs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs_path</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        docs_path : str, optional</span>
<span class="sd">            The path to the documentation .rst files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">docs_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;skip_docs&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warning_message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Can not test .rst docs for </span><span class="si">{name}</span><span class="s2">, since &quot;</span>
                                   <span class="s2">&quot;docs path (</span><span class="si">{path}</span><span class="s2">) does not exist.&quot;</span><span class="p">)</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages_path</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span> <span class="n">docs_path</span><span class="p">,</span>
                                           <span class="n">warning</span><span class="o">=</span><span class="n">warning_message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;test_path&#39;</span><span class="p">]:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs_path</span><span class="p">,</span> <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;test_path&#39;</span><span class="p">]:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--doctest-rst&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">paths</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">skip_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_docs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        skip_docs : `bool`, optional</span>
<span class="sd">            When `True`, skips running the doctests in the .rst files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip docs is a bool used by docs_path only.</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@keyword</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        repeat : `int`, optional</span>
<span class="sd">            If set, specifies how many times each test should be run. This is</span>
<span class="sd">            useful for diagnosing sporadic failures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;--repeat=</span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Override run_tests for astropy-specific fixes</span>
    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># This prevents cyclical import problems that make it</span>
        <span class="c1"># impossible to test packages that define Table types on their</span>
        <span class="c1"># own.</span>
        <span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>  <span class="c1"># pylint: disable=W0611</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011–2022, The Astropy Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.5.4. &nbsp;
    Last built 09 May 2022. <br/>
  </p>
</footer>
  </body>
</html>