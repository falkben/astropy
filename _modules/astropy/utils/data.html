


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astropy.utils.data &#8212; Astropy v5.2.dev104+gcdd6a1f81.d20220509</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
  <meta name="robots" content="noindex, nofollow">
  
  
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>


  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">Astropy v5.2.dev104+gcdd6a1f81.d20220509</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astropy.utils.data</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="sd">&quot;&quot;&quot;Functions for accessing, downloading, and caching data files.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="c1"># import ssl moved inside functions using ssl to avoid import failure</span>
<span class="c1"># when running in pyodide/Emscripten</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">ftplib</span>

<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span><span class="p">,</span> <span class="n">gettempdir</span><span class="p">,</span> <span class="n">TemporaryDirectory</span><span class="p">,</span> <span class="n">mkdtemp</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">certifi</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># certifi support is optional; when available it will be used for TLS/SSL</span>
    <span class="c1"># downloads</span>
    <span class="n">certifi</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">import</span> <span class="nn">astropy.config.paths</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">_config</span>
<span class="kn">from</span> <span class="nn">astropy.utils.exceptions</span> <span class="kn">import</span> <span class="n">AstropyWarning</span>
<span class="kn">from</span> <span class="nn">astropy.utils.introspection</span> <span class="kn">import</span> <span class="n">find_current_module</span><span class="p">,</span> <span class="n">resolve_name</span>


<span class="c1"># Order here determines order in the autosummary</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Conf&#39;</span><span class="p">,</span> <span class="s1">&#39;conf&#39;</span><span class="p">,</span>
    <span class="s1">&#39;download_file&#39;</span><span class="p">,</span> <span class="s1">&#39;download_files_in_parallel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_readable_fileobj&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_pkg_data_fileobj&#39;</span><span class="p">,</span> <span class="s1">&#39;get_pkg_data_filename&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_pkg_data_contents&#39;</span><span class="p">,</span> <span class="s1">&#39;get_pkg_data_fileobjs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_pkg_data_filenames&#39;</span><span class="p">,</span> <span class="s1">&#39;get_pkg_data_path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_url&#39;</span><span class="p">,</span> <span class="s1">&#39;is_url_in_cache&#39;</span><span class="p">,</span> <span class="s1">&#39;get_cached_urls&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cache_total_size&#39;</span><span class="p">,</span> <span class="s1">&#39;cache_contents&#39;</span><span class="p">,</span>
    <span class="s1">&#39;export_download_cache&#39;</span><span class="p">,</span> <span class="s1">&#39;import_download_cache&#39;</span><span class="p">,</span> <span class="s1">&#39;import_file_to_cache&#39;</span><span class="p">,</span>
    <span class="s1">&#39;check_download_cache&#39;</span><span class="p">,</span>
    <span class="s1">&#39;clear_download_cache&#39;</span><span class="p">,</span>
    <span class="s1">&#39;compute_hash&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_free_space_in_dir&#39;</span><span class="p">,</span>
    <span class="s1">&#39;check_free_space_in_dir&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_file_contents&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CacheMissingWarning&#39;</span><span class="p">,</span>
    <span class="s2">&quot;CacheDamaged&quot;</span>
<span class="p">]</span>

<span class="n">_dataurls_to_alias</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">_NonClosingBufferedReader</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># NOTE: self.raw will not be closed, but left in the state</span>
            <span class="c1"># it was in at detactment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_NonClosingTextIOWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># NOTE: self.stream will not be closed, but left in the state</span>
            <span class="c1"># it was in at detactment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>


<div class="viewcode-block" id="Conf"><a class="viewcode-back" href="../../../api/astropy.utils.data.Conf.html#astropy.utils.data.Conf">[docs]</a><span class="k">class</span> <span class="nc">Conf</span><span class="p">(</span><span class="n">_config</span><span class="o">.</span><span class="n">ConfigNamespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration parameters for `astropy.utils.data`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataurl</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="s1">&#39;http://data.astropy.org/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Primary URL for astropy remote data site.&#39;</span><span class="p">)</span>
    <span class="n">dataurl_mirror</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="s1">&#39;http://www.astropy.org/astropy-data/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mirror URL for astropy remote data site.&#39;</span><span class="p">)</span>
    <span class="n">default_http_user_agent</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="s1">&#39;astropy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Default User-Agent for HTTP request headers. This can be overwritten &#39;</span>
        <span class="s1">&#39;for a particular call via http_headers option, where available. &#39;</span>
        <span class="s1">&#39;This only provides the default value when not set by https_headers.&#39;</span><span class="p">)</span>
    <span class="n">remote_timeout</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="mf">10.</span><span class="p">,</span>
        <span class="s1">&#39;Time to wait for remote data queries (in seconds).&#39;</span><span class="p">,</span>
        <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;astropy.coordinates.name_resolve.name_resolve_timeout&#39;</span><span class="p">])</span>
    <span class="n">allow_internet</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;If False, prevents any attempt to download from Internet.&#39;</span><span class="p">)</span>
    <span class="n">compute_hash_block_size</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span><span class="p">,</span>  <span class="c1"># 64K</span>
        <span class="s1">&#39;Block size for computing file hashes.&#39;</span><span class="p">)</span>
    <span class="n">download_block_size</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span><span class="p">,</span>  <span class="c1"># 64K</span>
        <span class="s1">&#39;Number of bytes of remote data to download per step.&#39;</span><span class="p">)</span>
    <span class="n">delete_temporary_downloads_at_exit</span> <span class="o">=</span> <span class="n">_config</span><span class="o">.</span><span class="n">ConfigItem</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;If True, temporary download files created when the cache is &#39;</span>
        <span class="s1">&#39;inaccessible will be deleted at the end of the python session.&#39;</span><span class="p">)</span></div>


<span class="n">conf</span> <span class="o">=</span> <span class="n">Conf</span><span class="p">()</span>


<div class="viewcode-block" id="CacheMissingWarning"><a class="viewcode-back" href="../../../api/astropy.utils.data.CacheMissingWarning.html#astropy.utils.data.CacheMissingWarning">[docs]</a><span class="k">class</span> <span class="nc">CacheMissingWarning</span><span class="p">(</span><span class="n">AstropyWarning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This warning indicates the standard cache directory is not accessible, with</span>
<span class="sd">    the first argument providing the warning message. If args[1] is present, it</span>
<span class="sd">    is a filename indicating the path to a temporary file that was created to</span>
<span class="sd">    store a remote data download in the absence of the cache.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="is_url"><a class="viewcode-back" href="../../../api/astropy.utils.data.is_url.html#astropy.utils.data.is_url">[docs]</a><span class="k">def</span> <span class="nf">is_url</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test whether a string is a valid URL for :func:`download_file`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string : str</span>
<span class="sd">        The string to test.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    status : bool</span>
<span class="sd">        String is URL or not.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="c1"># we can&#39;t just check that url.scheme is not an empty string, because</span>
    <span class="c1"># file paths in windows would return a non-empty scheme (e.g. e:\\</span>
    <span class="c1"># returns &#39;e&#39;).</span>
    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span> <span class="s1">&#39;ftp&#39;</span><span class="p">,</span> <span class="s1">&#39;sftp&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">]</span></div>


<span class="c1"># Backward compatibility because some downstream packages allegedly uses it.</span>
<span class="n">_is_url</span> <span class="o">=</span> <span class="n">is_url</span>


<span class="k">def</span> <span class="nf">_is_inside</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent_path</span><span class="p">):</span>
    <span class="c1"># We have to try realpath too to avoid issues with symlinks, but we leave</span>
    <span class="c1"># abspath because some systems like debian have the absolute path (with no</span>
    <span class="c1"># symlinks followed) match, but the real directories in different</span>
    <span class="c1"># locations, so need to try both cases.</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">parent_path</span><span class="p">))</span> \
        <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">parent_path</span><span class="p">))</span>


<div class="viewcode-block" id="get_readable_fileobj"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_readable_fileobj.html#astropy.utils.data.get_readable_fileobj">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">get_readable_fileobj</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remote_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">http_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield a readable, seekable file-like object from a file or URL.</span>

<span class="sd">    This supports passing filenames, URLs, and readable file-like objects,</span>
<span class="sd">    any of which can be compressed in gzip, bzip2 or lzma (xz) if the</span>
<span class="sd">    appropriate compression libraries are provided by the Python installation.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    This function is a context manager, and should be used for example</span>
<span class="sd">    as::</span>

<span class="sd">        with get_readable_fileobj(&#39;file.dat&#39;) as f:</span>
<span class="sd">            contents = f.read()</span>

<span class="sd">    If a URL is provided and the cache is in use, the provided URL will be the</span>
<span class="sd">    name used in the cache. The contents may already be stored in the cache</span>
<span class="sd">    under this URL provided, they may be downloaded from this URL, or they may</span>
<span class="sd">    be downloaded from one of the locations listed in ``sources``. See</span>
<span class="sd">    `~download_file` for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name_or_obj : str or file-like</span>
<span class="sd">        The filename of the file to access (if given as a string), or</span>
<span class="sd">        the file-like object to access.</span>

<span class="sd">        If a file-like object, it must be opened in binary mode.</span>

<span class="sd">    encoding : str, optional</span>
<span class="sd">        When `None` (default), returns a file-like object with a</span>
<span class="sd">        ``read`` method that returns `str` (``unicode``) objects, using</span>
<span class="sd">        `locale.getpreferredencoding` as an encoding.  This matches</span>
<span class="sd">        the default behavior of the built-in `open` when no ``mode``</span>
<span class="sd">        argument is provided.</span>

<span class="sd">        When ``&#39;binary&#39;``, returns a file-like object where its ``read``</span>
<span class="sd">        method returns `bytes` objects.</span>

<span class="sd">        When another string, it is the name of an encoding, and the</span>
<span class="sd">        file-like object&#39;s ``read`` method will return `str` (``unicode``)</span>
<span class="sd">        objects, decoded from binary using the given encoding.</span>

<span class="sd">    cache : bool or &quot;update&quot;, optional</span>
<span class="sd">        Whether to cache the contents of remote URLs. If &quot;update&quot;,</span>
<span class="sd">        check the remote URL for a new version but store the result</span>
<span class="sd">        in the cache.</span>

<span class="sd">    show_progress : bool, optional</span>
<span class="sd">        Whether to display a progress bar if the file is downloaded</span>
<span class="sd">        from a remote server.  Default is `True`.</span>

<span class="sd">    remote_timeout : float</span>
<span class="sd">        Timeout for remote requests in seconds (default is the configurable</span>
<span class="sd">        `astropy.utils.data.Conf.remote_timeout`).</span>

<span class="sd">    sources : list of str, optional</span>
<span class="sd">        If provided, a list of URLs to try to obtain the file from. The</span>
<span class="sd">        result will be stored under the original URL. The original URL</span>
<span class="sd">        will *not* be tried unless it is in this list; this is to prevent</span>
<span class="sd">        long waits for a primary server that is known to be inaccessible</span>
<span class="sd">        at the moment.</span>

<span class="sd">    http_headers : dict or None</span>
<span class="sd">        HTTP request headers to pass into ``urlopen`` if needed. (These headers</span>
<span class="sd">        are ignored if the protocol for the ``name_or_obj``/``sources`` entry</span>
<span class="sd">        is not a remote HTTP URL.) In the default case (None), the headers are</span>
<span class="sd">        ``User-Agent: some_value`` and ``Accept: */*``, where ``some_value``</span>
<span class="sd">        is set by ``astropy.utils.data.conf.default_http_user_agent``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    file : readable file-like</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># close_fds is a list of file handles created by this function</span>
    <span class="c1"># that need to be closed.  We don&#39;t want to always just close the</span>
    <span class="c1"># returned file handle, because it may simply be the file handle</span>
    <span class="c1"># passed in.  In that case it is not the responsibility of this</span>
    <span class="c1"># function to close it: doing so could result in a &quot;double close&quot;</span>
    <span class="c1"># and an &quot;invalid file descriptor&quot; exception.</span>

    <span class="n">close_fds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delete_fds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">remote_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># use configfile default</span>
        <span class="n">remote_timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">remote_timeout</span>

    <span class="c1"># name_or_obj could be an os.PathLike object</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">):</span>
        <span class="n">name_or_obj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">)</span>

    <span class="c1"># Get a file object to the content</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">is_url</span> <span class="o">=</span> <span class="n">_is_url</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_url</span><span class="p">:</span>
            <span class="n">name_or_obj</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
                <span class="n">name_or_obj</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">remote_timeout</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
                <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">)</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">delete_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="n">close_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">name_or_obj</span>

    <span class="c1"># Check if the file object supports random access, and if not,</span>
    <span class="c1"># then wrap it in a BytesIO buffer.  It would be nicer to use a</span>
    <span class="c1"># BufferedReader to avoid reading loading the whole file first,</span>
    <span class="c1"># but that is not compatible with streams or urllib2.urlopen</span>
    <span class="c1"># objects on Python 2.x.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># py.path.LocalPath objects have .read() method but it uses</span>
            <span class="c1"># text mode, which won&#39;t work. .read_binary() does, and</span>
            <span class="c1"># surely other ducks would return binary contents when</span>
            <span class="c1"># called like this.</span>
            <span class="c1"># py.path.LocalPath is what comes from the tmpdir fixture</span>
            <span class="c1"># in pytest.</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read_binary</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># Now read enough bytes to look at signature</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">signature</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x1f\x8b\x08</span><span class="s1">&#39;</span><span class="p">:</span>  <span class="c1"># gzip</span>
        <span class="kn">import</span> <span class="nn">struct</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gzip</span>
            <span class="n">fileobj_new</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># need to check that the file is really gzip</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>  <span class="c1"># invalid gzip file</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj_new</span>
    <span class="k">elif</span> <span class="n">signature</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;BZh&#39;</span><span class="p">:</span>  <span class="c1"># bzip2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">bz2</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">close_fds</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;This Python installation does not provide the bz2 module.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># bz2.BZ2File does not support file objects, only filenames, so we</span>
            <span class="c1"># need to write the data to a temporary file</span>
            <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">fileobj_new</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># need to check that the file is really bzip2</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># invalid bzip2 file</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">close_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileobj_new</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj_new</span>
    <span class="k">elif</span> <span class="n">signature</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xfd</span><span class="s1">7z&#39;</span><span class="p">:</span>  <span class="c1"># xz</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">lzma</span>
            <span class="n">fileobj_new</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMAFile</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># need to check that the file is really xz</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">close_fds</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;This Python installation does not provide the lzma module.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>  <span class="c1"># invalid xz file</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># should we propagate this to the caller to signal bad content?</span>
            <span class="c1"># raise ValueError(e)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileobj_new</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj_new</span>

    <span class="c1"># By this point, we have a file, io.FileIO, gzip.GzipFile, bz2.BZ2File</span>
    <span class="c1"># or lzma.LZMAFile instance opened in binary mode (that is, read</span>
    <span class="c1"># returns bytes).  Now we need to, if requested, wrap it in a</span>
    <span class="c1"># io.TextIOWrapper so read will return unicode based on the</span>
    <span class="c1"># encoding parameter.</span>

    <span class="n">needs_textio_wrapper</span> <span class="o">=</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s1">&#39;binary&#39;</span>

    <span class="k">if</span> <span class="n">needs_textio_wrapper</span><span class="p">:</span>
        <span class="c1"># A bz2.BZ2File can not be wrapped by a TextIOWrapper,</span>
        <span class="c1"># so we decompress it to a temporary file and then</span>
        <span class="c1"># return a handle to that.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">bz2</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">delete_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

                <span class="n">fileobj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">close_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_NonClosingBufferedReader</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_NonClosingTextIOWrapper</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>

        <span class="c1"># Ensure that file is at the start - io.FileIO will for</span>
        <span class="c1"># example not always be at the start:</span>
        <span class="c1"># &gt;&gt;&gt; import io</span>
        <span class="c1"># &gt;&gt;&gt; f = open(&#39;test.fits&#39;, &#39;rb&#39;)</span>
        <span class="c1"># &gt;&gt;&gt; f.read(4)</span>
        <span class="c1"># &#39;SIMP&#39;</span>
        <span class="c1"># &gt;&gt;&gt; f.seek(0)</span>
        <span class="c1"># &gt;&gt;&gt; fileobj = io.FileIO(f.fileno())</span>
        <span class="c1"># &gt;&gt;&gt; fileobj.tell()</span>
        <span class="c1"># 4096L</span>

        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">fileobj</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">close_fds</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">delete_fds</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_file_contents"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_file_contents.html#astropy.utils.data.get_file_contents">[docs]</a><span class="k">def</span> <span class="nf">get_file_contents</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the contents of a filename or file-like object.</span>

<span class="sd">    See  the `get_readable_fileobj` docstring for details on parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    object</span>
<span class="sd">        The content of the file (as requested by ``encoding``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_readable_fileobj</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_pkg_data_fileobj"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_pkg_data_fileobj.html#astropy.utils.data.get_pkg_data_fileobj">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">get_pkg_data_fileobj</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a data file from the standard locations for the package and</span>
<span class="sd">    provides the file as a file-like object that reads bytes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_name : str</span>
<span class="sd">        Name/location of the desired data file.  One of the following:</span>

<span class="sd">            * The name of a data file included in the source</span>
<span class="sd">              distribution.  The path is relative to the module</span>
<span class="sd">              calling this function.  For example, if calling from</span>
<span class="sd">              ``astropy.pkname``, use ``&#39;data/file.dat&#39;`` to get the</span>
<span class="sd">              file in ``astropy/pkgname/data/file.dat``.  Double-dots</span>
<span class="sd">              can be used to go up a level.  In the same example, use</span>
<span class="sd">              ``&#39;../data/file.dat&#39;`` to get ``astropy/data/file.dat``.</span>
<span class="sd">            * If a matching local file does not exist, the Astropy</span>
<span class="sd">              data server will be queried for the file.</span>
<span class="sd">            * A hash like that produced by `compute_hash` can be</span>
<span class="sd">              requested, prefixed by &#39;hash/&#39;</span>
<span class="sd">              e.g. &#39;hash/34c33b3eb0d56eb9462003af249eff28&#39;.  The hash</span>
<span class="sd">              will first be searched for locally, and if not found,</span>
<span class="sd">              the Astropy data server will be queried.</span>

<span class="sd">    package : str, optional</span>
<span class="sd">        If specified, look for a file relative to the given package, rather</span>
<span class="sd">        than the default of looking relative to the calling module&#39;s package.</span>

<span class="sd">    encoding : str, optional</span>
<span class="sd">        When `None` (default), returns a file-like object with a</span>
<span class="sd">        ``read`` method returns `str` (``unicode``) objects, using</span>
<span class="sd">        `locale.getpreferredencoding` as an encoding.  This matches</span>
<span class="sd">        the default behavior of the built-in `open` when no ``mode``</span>
<span class="sd">        argument is provided.</span>

<span class="sd">        When ``&#39;binary&#39;``, returns a file-like object where its ``read``</span>
<span class="sd">        method returns `bytes` objects.</span>

<span class="sd">        When another string, it is the name of an encoding, and the</span>
<span class="sd">        file-like object&#39;s ``read`` method will return `str` (``unicode``)</span>
<span class="sd">        objects, decoded from binary using the given encoding.</span>

<span class="sd">    cache : bool</span>
<span class="sd">        If True, the file will be downloaded and saved locally or the</span>
<span class="sd">        already-cached local copy will be accessed. If False, the</span>
<span class="sd">        file-like object will directly access the resource (e.g. if a</span>
<span class="sd">        remote URL is accessed, an object like that from</span>
<span class="sd">        `urllib.request.urlopen` is returned).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileobj : file-like</span>
<span class="sd">        An object with the contents of the data file available via</span>
<span class="sd">        ``read`` function.  Can be used as part of a ``with`` statement,</span>
<span class="sd">        automatically closing itself after the ``with`` block.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        If a remote file cannot be found.</span>
<span class="sd">    OSError</span>
<span class="sd">        If problems occur writing or reading a local file.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    This will retrieve a data file and its contents for the `astropy.wcs`</span>
<span class="sd">    tests::</span>

<span class="sd">        &gt;&gt;&gt; from astropy.utils.data import get_pkg_data_fileobj</span>
<span class="sd">        &gt;&gt;&gt; with get_pkg_data_fileobj(&#39;data/3d_cd.hdr&#39;,</span>
<span class="sd">        ...                           package=&#39;astropy.wcs.tests&#39;) as fobj:</span>
<span class="sd">        ...     fcontents = fobj.read()</span>
<span class="sd">        ...</span>

<span class="sd">    This next example would download a data file from the astropy data server</span>
<span class="sd">    because the ``allsky/allsky_rosat.fits`` file is not present in the</span>
<span class="sd">    source distribution.  It will also save the file locally so the</span>
<span class="sd">    next time it is accessed it won&#39;t need to be downloaded.::</span>

<span class="sd">        &gt;&gt;&gt; from astropy.utils.data import get_pkg_data_fileobj</span>
<span class="sd">        &gt;&gt;&gt; with get_pkg_data_fileobj(&#39;allsky/allsky_rosat.fits&#39;,</span>
<span class="sd">        ...                           encoding=&#39;binary&#39;) as fobj:  # doctest: +REMOTE_DATA +IGNORE_OUTPUT</span>
<span class="sd">        ...     fcontents = fobj.read()</span>
<span class="sd">        ...</span>
<span class="sd">        Downloading http://data.astropy.org/allsky/allsky_rosat.fits [Done]</span>

<span class="sd">    This does the same thing but does *not* cache it locally::</span>

<span class="sd">        &gt;&gt;&gt; with get_pkg_data_fileobj(&#39;allsky/allsky_rosat.fits&#39;,</span>
<span class="sd">        ...                           encoding=&#39;binary&#39;, cache=False) as fobj:  # doctest: +REMOTE_DATA +IGNORE_OUTPUT</span>
<span class="sd">        ...     fcontents = fobj.read()</span>
<span class="sd">        ...</span>
<span class="sd">        Downloading http://data.astropy.org/allsky/allsky_rosat.fits [Done]</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    get_pkg_data_contents : returns the contents of a file or url as a bytes object</span>
<span class="sd">    get_pkg_data_filename : returns a local name for a file containing the data</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="n">datafn</span> <span class="o">=</span> <span class="n">get_pkg_data_path</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datafn</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Tried to access a data file that&#39;s actually &quot;</span>
                      <span class="s2">&quot;a package data directory&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafn</span><span class="p">):</span>  <span class="c1"># local file</span>
        <span class="k">with</span> <span class="n">get_readable_fileobj</span><span class="p">(</span><span class="n">datafn</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">fileobj</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># remote file</span>
        <span class="k">with</span> <span class="n">get_readable_fileobj</span><span class="p">(</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">dataurl</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">dataurl</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span>
                     <span class="n">conf</span><span class="o">.</span><span class="n">dataurl_mirror</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">],</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="c1"># We read a byte to trigger any URLErrors</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">fileobj</span></div>


<div class="viewcode-block" id="get_pkg_data_filename"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_pkg_data_filename.html#astropy.utils.data.get_pkg_data_filename">[docs]</a><span class="k">def</span> <span class="nf">get_pkg_data_filename</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">remote_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a data file from the standard locations for the package and</span>
<span class="sd">    provides a local filename for the data.</span>

<span class="sd">    This function is similar to `get_pkg_data_fileobj` but returns the</span>
<span class="sd">    file *name* instead of a readable file-like object.  This means</span>
<span class="sd">    that this function must always cache remote files locally, unlike</span>
<span class="sd">    `get_pkg_data_fileobj`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_name : str</span>
<span class="sd">        Name/location of the desired data file.  One of the following:</span>

<span class="sd">            * The name of a data file included in the source</span>
<span class="sd">              distribution.  The path is relative to the module</span>
<span class="sd">              calling this function.  For example, if calling from</span>
<span class="sd">              ``astropy.pkname``, use ``&#39;data/file.dat&#39;`` to get the</span>
<span class="sd">              file in ``astropy/pkgname/data/file.dat``.  Double-dots</span>
<span class="sd">              can be used to go up a level.  In the same example, use</span>
<span class="sd">              ``&#39;../data/file.dat&#39;`` to get ``astropy/data/file.dat``.</span>
<span class="sd">            * If a matching local file does not exist, the Astropy</span>
<span class="sd">              data server will be queried for the file.</span>
<span class="sd">            * A hash like that produced by `compute_hash` can be</span>
<span class="sd">              requested, prefixed by &#39;hash/&#39;</span>
<span class="sd">              e.g. &#39;hash/34c33b3eb0d56eb9462003af249eff28&#39;.  The hash</span>
<span class="sd">              will first be searched for locally, and if not found,</span>
<span class="sd">              the Astropy data server will be queried.</span>

<span class="sd">    package : str, optional</span>
<span class="sd">        If specified, look for a file relative to the given package, rather</span>
<span class="sd">        than the default of looking relative to the calling module&#39;s package.</span>

<span class="sd">    show_progress : bool, optional</span>
<span class="sd">        Whether to display a progress bar if the file is downloaded</span>
<span class="sd">        from a remote server.  Default is `True`.</span>

<span class="sd">    remote_timeout : float</span>
<span class="sd">        Timeout for the requests in seconds (default is the</span>
<span class="sd">        configurable `astropy.utils.data.Conf.remote_timeout`).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        If a remote file cannot be found.</span>
<span class="sd">    OSError</span>
<span class="sd">        If problems occur writing or reading a local file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filename : str</span>
<span class="sd">        A file path on the local file system corresponding to the data</span>
<span class="sd">        requested in ``data_name``.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    This will retrieve the contents of the data file for the `astropy.wcs`</span>
<span class="sd">    tests::</span>

<span class="sd">        &gt;&gt;&gt; from astropy.utils.data import get_pkg_data_filename</span>
<span class="sd">        &gt;&gt;&gt; fn = get_pkg_data_filename(&#39;data/3d_cd.hdr&#39;,</span>
<span class="sd">        ...                            package=&#39;astropy.wcs.tests&#39;)</span>
<span class="sd">        &gt;&gt;&gt; with open(fn) as f:</span>
<span class="sd">        ...     fcontents = f.read()</span>
<span class="sd">        ...</span>

<span class="sd">    This retrieves a data file by hash either locally or from the astropy data</span>
<span class="sd">    server::</span>

<span class="sd">        &gt;&gt;&gt; from astropy.utils.data import get_pkg_data_filename</span>
<span class="sd">        &gt;&gt;&gt; fn = get_pkg_data_filename(&#39;hash/34c33b3eb0d56eb9462003af249eff28&#39;)  # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; with open(fn) as f:</span>
<span class="sd">        ...     fcontents = f.read()</span>
<span class="sd">        ...</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    get_pkg_data_contents : returns the contents of a file or url as a bytes object</span>
<span class="sd">    get_pkg_data_fileobj : returns a file-like object with the data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">remote_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># use configfile default</span>
        <span class="n">remote_timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">remote_timeout</span>

    <span class="k">if</span> <span class="n">data_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;hash/&#39;</span><span class="p">):</span>
        <span class="c1"># first try looking for a local version if a hash is specified</span>
        <span class="n">hashfn</span> <span class="o">=</span> <span class="n">_find_hash_fn</span><span class="p">(</span><span class="n">data_name</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">hashfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">download_file</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">dataurl</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
                                 <span class="n">timeout</span><span class="o">=</span><span class="n">remote_timeout</span><span class="p">,</span>
                                 <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">dataurl</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span>
                                          <span class="n">conf</span><span class="o">.</span><span class="n">dataurl_mirror</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hashfn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">data_name</span><span class="p">)</span>
        <span class="n">datafn</span> <span class="o">=</span> <span class="n">get_pkg_data_path</span><span class="p">(</span><span class="n">fs_path</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datafn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Tried to access a data file that&#39;s actually &quot;</span>
                          <span class="s2">&quot;a package data directory&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafn</span><span class="p">):</span>  <span class="c1"># local file</span>
            <span class="k">return</span> <span class="n">datafn</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># remote file</span>
            <span class="k">return</span> <span class="n">download_file</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">dataurl</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
                                 <span class="n">timeout</span><span class="o">=</span><span class="n">remote_timeout</span><span class="p">,</span>
                                 <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">dataurl</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span>
                                          <span class="n">conf</span><span class="o">.</span><span class="n">dataurl_mirror</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_pkg_data_contents"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_pkg_data_contents.html#astropy.utils.data.get_pkg_data_contents">[docs]</a><span class="k">def</span> <span class="nf">get_pkg_data_contents</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a data file from the standard locations and returns its</span>
<span class="sd">    contents as a bytes object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_name : str</span>
<span class="sd">        Name/location of the desired data file.  One of the following:</span>

<span class="sd">            * The name of a data file included in the source</span>
<span class="sd">              distribution.  The path is relative to the module</span>
<span class="sd">              calling this function.  For example, if calling from</span>
<span class="sd">              ``astropy.pkname``, use ``&#39;data/file.dat&#39;`` to get the</span>
<span class="sd">              file in ``astropy/pkgname/data/file.dat``.  Double-dots</span>
<span class="sd">              can be used to go up a level.  In the same example, use</span>
<span class="sd">              ``&#39;../data/file.dat&#39;`` to get ``astropy/data/file.dat``.</span>
<span class="sd">            * If a matching local file does not exist, the Astropy</span>
<span class="sd">              data server will be queried for the file.</span>
<span class="sd">            * A hash like that produced by `compute_hash` can be</span>
<span class="sd">              requested, prefixed by &#39;hash/&#39;</span>
<span class="sd">              e.g. &#39;hash/34c33b3eb0d56eb9462003af249eff28&#39;.  The hash</span>
<span class="sd">              will first be searched for locally, and if not found,</span>
<span class="sd">              the Astropy data server will be queried.</span>
<span class="sd">            * A URL to some other file.</span>

<span class="sd">    package : str, optional</span>
<span class="sd">        If specified, look for a file relative to the given package, rather</span>
<span class="sd">        than the default of looking relative to the calling module&#39;s package.</span>


<span class="sd">    encoding : str, optional</span>
<span class="sd">        When `None` (default), returns a file-like object with a</span>
<span class="sd">        ``read`` method that returns `str` (``unicode``) objects, using</span>
<span class="sd">        `locale.getpreferredencoding` as an encoding.  This matches</span>
<span class="sd">        the default behavior of the built-in `open` when no ``mode``</span>
<span class="sd">        argument is provided.</span>

<span class="sd">        When ``&#39;binary&#39;``, returns a file-like object where its ``read``</span>
<span class="sd">        method returns `bytes` objects.</span>

<span class="sd">        When another string, it is the name of an encoding, and the</span>
<span class="sd">        file-like object&#39;s ``read`` method will return `str` (``unicode``)</span>
<span class="sd">        objects, decoded from binary using the given encoding.</span>

<span class="sd">    cache : bool</span>
<span class="sd">        If True, the file will be downloaded and saved locally or the</span>
<span class="sd">        already-cached local copy will be accessed. If False, the</span>
<span class="sd">        file-like object will directly access the resource (e.g. if a</span>
<span class="sd">        remote URL is accessed, an object like that from</span>
<span class="sd">        `urllib.request.urlopen` is returned).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    contents : bytes</span>
<span class="sd">        The complete contents of the file as a bytes object.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        If a remote file cannot be found.</span>
<span class="sd">    OSError</span>
<span class="sd">        If problems occur writing or reading a local file.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    get_pkg_data_fileobj : returns a file-like object with the data</span>
<span class="sd">    get_pkg_data_filename : returns a local name for a file containing the data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">get_pkg_data_fileobj</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
                              <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">contents</span></div>


<div class="viewcode-block" id="get_pkg_data_filenames"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_pkg_data_filenames.html#astropy.utils.data.get_pkg_data_filenames">[docs]</a><span class="k">def</span> <span class="nf">get_pkg_data_filenames</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the path of all of the data files in a given directory</span>
<span class="sd">    that match a given glob pattern.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datadir : str</span>
<span class="sd">        Name/location of the desired data files.  One of the following:</span>

<span class="sd">            * The name of a directory included in the source</span>
<span class="sd">              distribution.  The path is relative to the module</span>
<span class="sd">              calling this function.  For example, if calling from</span>
<span class="sd">              ``astropy.pkname``, use ``&#39;data&#39;`` to get the</span>
<span class="sd">              files in ``astropy/pkgname/data``.</span>
<span class="sd">            * Remote URLs are not currently supported.</span>

<span class="sd">    package : str, optional</span>
<span class="sd">        If specified, look for a file relative to the given package, rather</span>
<span class="sd">        than the default of looking relative to the calling module&#39;s package.</span>

<span class="sd">    pattern : str, optional</span>
<span class="sd">        A UNIX-style filename glob pattern to match files.  See the</span>
<span class="sd">        `glob` module in the standard library for more information.</span>
<span class="sd">        By default, matches all files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filenames : iterator of str</span>
<span class="sd">        Paths on the local filesystem in *datadir* matching *pattern*.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    This will retrieve the contents of the data file for the `astropy.wcs`</span>
<span class="sd">    tests::</span>

<span class="sd">        &gt;&gt;&gt; from astropy.utils.data import get_pkg_data_filenames</span>
<span class="sd">        &gt;&gt;&gt; for fn in get_pkg_data_filenames(&#39;data/maps&#39;, &#39;astropy.wcs.tests&#39;,</span>
<span class="sd">        ...                                  &#39;*.hdr&#39;):</span>
<span class="sd">        ...     with open(fn) as f:</span>
<span class="sd">        ...         fcontents = f.read()</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">get_pkg_data_path</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="s2">&quot;Tried to access a data directory that&#39;s actually &quot;</span>
            <span class="s2">&quot;a package data file&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Path not found&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pkg_data_fileobjs"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_pkg_data_fileobjs.html#astropy.utils.data.get_pkg_data_fileobjs">[docs]</a><span class="k">def</span> <span class="nf">get_pkg_data_fileobjs</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns readable file objects for all of the data files in a given</span>
<span class="sd">    directory that match a given glob pattern.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datadir : str</span>
<span class="sd">        Name/location of the desired data files.  One of the following:</span>

<span class="sd">            * The name of a directory included in the source</span>
<span class="sd">              distribution.  The path is relative to the module</span>
<span class="sd">              calling this function.  For example, if calling from</span>
<span class="sd">              ``astropy.pkname``, use ``&#39;data&#39;`` to get the</span>
<span class="sd">              files in ``astropy/pkgname/data``</span>
<span class="sd">            * Remote URLs are not currently supported</span>

<span class="sd">    package : str, optional</span>
<span class="sd">        If specified, look for a file relative to the given package, rather</span>
<span class="sd">        than the default of looking relative to the calling module&#39;s package.</span>

<span class="sd">    pattern : str, optional</span>
<span class="sd">        A UNIX-style filename glob pattern to match files.  See the</span>
<span class="sd">        `glob` module in the standard library for more information.</span>
<span class="sd">        By default, matches all files.</span>

<span class="sd">    encoding : str, optional</span>
<span class="sd">        When `None` (default), returns a file-like object with a</span>
<span class="sd">        ``read`` method that returns `str` (``unicode``) objects, using</span>
<span class="sd">        `locale.getpreferredencoding` as an encoding.  This matches</span>
<span class="sd">        the default behavior of the built-in `open` when no ``mode``</span>
<span class="sd">        argument is provided.</span>

<span class="sd">        When ``&#39;binary&#39;``, returns a file-like object where its ``read``</span>
<span class="sd">        method returns `bytes` objects.</span>

<span class="sd">        When another string, it is the name of an encoding, and the</span>
<span class="sd">        file-like object&#39;s ``read`` method will return `str` (``unicode``)</span>
<span class="sd">        objects, decoded from binary using the given encoding.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileobjs : iterator of file object</span>
<span class="sd">        File objects for each of the files on the local filesystem in</span>
<span class="sd">        *datadir* matching *pattern*.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    This will retrieve the contents of the data file for the `astropy.wcs`</span>
<span class="sd">    tests::</span>

<span class="sd">        &gt;&gt;&gt; from astropy.utils.data import get_pkg_data_filenames</span>
<span class="sd">        &gt;&gt;&gt; for fd in get_pkg_data_fileobjs(&#39;data/maps&#39;, &#39;astropy.wcs.tests&#39;,</span>
<span class="sd">        ...                                 &#39;*.hdr&#39;):</span>
<span class="sd">        ...     fcontents = fd.read()</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">get_pkg_data_filenames</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">,</span>
                                     <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">get_readable_fileobj</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">fd</span></div>


<div class="viewcode-block" id="compute_hash"><a class="viewcode-back" href="../../../api/astropy.utils.data.compute_hash.html#astropy.utils.data.compute_hash">[docs]</a><span class="k">def</span> <span class="nf">compute_hash</span><span class="p">(</span><span class="n">localfn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the MD5 hash for a file.</span>

<span class="sd">    The hash for a data file is used for looking up data files in a unique</span>
<span class="sd">    fashion. This is of particular use for tests; a test may require a</span>
<span class="sd">    particular version of a particular file, in which case it can be accessed</span>
<span class="sd">    via hash to get the appropriate version.</span>

<span class="sd">    Typically, if you wish to write a test that requires a particular data</span>
<span class="sd">    file, you will want to submit that file to the astropy data servers, and</span>
<span class="sd">    use</span>
<span class="sd">    e.g. ``get_pkg_data_filename(&#39;hash/34c33b3eb0d56eb9462003af249eff28&#39;)``,</span>
<span class="sd">    but with the hash for your file in place of the hash in the example.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    localfn : str</span>
<span class="sd">        The path to the file for which the hash should be generated.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hash : str</span>
<span class="sd">        The hex digest of the cryptographic hash for the contents of the</span>
<span class="sd">        ``localfn`` file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">localfn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">compute_hash_block_size</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">compute_hash_block_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_pkg_data_path"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_pkg_data_path.html#astropy.utils.data.get_pkg_data_path">[docs]</a><span class="k">def</span> <span class="nf">get_pkg_data_path</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get path from source-included data directories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *path : str</span>
<span class="sd">        Name/location of the desired data file/directory.</span>
<span class="sd">        May be a tuple of strings for ``os.path`` joining.</span>

<span class="sd">    package : str or None, optional, keyword-only</span>
<span class="sd">        If specified, look for a file relative to the given package, rather</span>
<span class="sd">        than the calling module&#39;s package.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    path : str</span>
<span class="sd">        Name/location of the desired data file/directory.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ImportError</span>
<span class="sd">        Given package or module is not importable.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the local data file is outside of the package&#39;s tree.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">find_current_module</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">finddiff</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;astropy.utils.data&#39;</span><span class="p">,</span> <span class="s1">&#39;contextlib&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># not called from inside an astropy package.  So just pass name</span>
            <span class="c1"># through</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__package__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">__package__</span><span class="p">:</span>
            <span class="c1"># The __package__ attribute may be missing or set to None; see</span>
            <span class="c1"># PEP-366, also astropy issue #1256</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__package__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># package errors if it isn&#39;t a str</span>
        <span class="c1"># so there is no need for checks in the containing if/else</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">resolve_name</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>

    <span class="c1"># module path within package</span>
    <span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Check that file is inside tree.</span>
    <span class="n">rootpkgname</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rootpkg</span> <span class="o">=</span> <span class="n">resolve_name</span><span class="p">(</span><span class="n">rootpkgname</span><span class="p">)</span>
    <span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rootpkg</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_inside</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;attempted to get a local data file outside &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;of the </span><span class="si">{</span><span class="n">rootpkgname</span><span class="si">}</span><span class="s2"> tree.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">full_path</span></div>


<span class="k">def</span> <span class="nf">_find_hash_fn</span><span class="p">(</span><span class="n">hexdigest</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Looks for a local file by hash - returns file name if found and a valid</span>
<span class="sd">    file, otherwise returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cache_contents</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">compute_hash</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">hexdigest</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_free_space_in_dir"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_free_space_in_dir.html#astropy.utils.data.get_free_space_in_dir">[docs]</a><span class="k">def</span> <span class="nf">get_free_space_in_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a path to a directory, returns the amount of free space</span>
<span class="sd">    on that filesystem.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path to a directory.</span>

<span class="sd">    unit : bool or `~astropy.units.Unit`</span>
<span class="sd">        Return the amount of free space as Quantity in the given unit,</span>
<span class="sd">        if provided. Default is `False` for backward-compatibility.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    free_space : int or `~astropy.units.Quantity`</span>
<span class="sd">        The amount of free space on the partition that the directory is on.</span>
<span class="sd">        If ``unit=False``, it is returned as plain integer (in bytes).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="s2">&quot;Can only determine free space associated with directories, &quot;</span>
            <span class="s2">&quot;not files.&quot;</span><span class="p">)</span>
        <span class="c1"># Actually you can on Linux but I want to avoid code that fails</span>
        <span class="c1"># on Windows only.</span>
    <span class="n">free_space</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">free</span>
    <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
        <span class="c1"># TODO: Automatically determine best prefix to use.</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">byte</span>
        <span class="n">free_space</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">free_space</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">byte</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">free_space</span></div>


<div class="viewcode-block" id="check_free_space_in_dir"><a class="viewcode-back" href="../../../api/astropy.utils.data.check_free_space_in_dir.html#astropy.utils.data.check_free_space_in_dir">[docs]</a><span class="k">def</span> <span class="nf">check_free_space_in_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines if a given directory has enough space to hold a file of</span>
<span class="sd">    a given size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path to a directory.</span>

<span class="sd">    size : int or `~astropy.units.Quantity`</span>
<span class="sd">        A proposed filesize. If not a Quantity, assume it is in bytes.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        There is not enough room on the filesystem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">space</span> <span class="o">=</span> <span class="n">get_free_space_in_dir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">space</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">astropy.utils.console</span> <span class="kn">import</span> <span class="n">human_file_size</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough free space in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;to download a </span><span class="si">{</span><span class="n">human_file_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2"> file, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;only </span><span class="si">{</span><span class="n">human_file_size</span><span class="p">(</span><span class="n">space</span><span class="p">)</span><span class="si">}</span><span class="s2"> left&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_ftptlswrapper</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">ftpwrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">FTP_TLS</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">prot_p</span><span class="p">()</span>
        <span class="n">_target</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">_target</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_FTPTLSHandler</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">FTPHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connect_ftp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ftptlswrapper</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span>
                              <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_build_urlopener</span><span class="p">(</span><span class="n">ftp_tls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper for building a `urllib.request.build_opener` which handles TLS/SSL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import ssl here to avoid import failure when running in pyodide/Emscripten</span>
    <span class="kn">import</span> <span class="nn">ssl</span>

    <span class="n">ssl_context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">ssl_context</span><span class="p">)</span> <span class="k">if</span> <span class="n">ssl_context</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">cert_chain</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;certfile&#39;</span> <span class="ow">in</span> <span class="n">ssl_context</span><span class="p">:</span>
        <span class="n">cert_chain</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;certfile&#39;</span><span class="p">:</span> <span class="n">ssl_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;certfile&#39;</span><span class="p">),</span>
            <span class="s1">&#39;keyfile&#39;</span><span class="p">:</span> <span class="n">ssl_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;keyfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">ssl_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="k">elif</span> <span class="s1">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">ssl_context</span> <span class="ow">or</span> <span class="s1">&#39;keyfile&#39;</span> <span class="ow">in</span> <span class="n">ssl_context</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;passing &#39;keyfile&#39; or &#39;password&#39; in the ssl_context argument &quot;</span>
            <span class="s2">&quot;requires passing &#39;certfile&#39; as well&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;cafile&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ssl_context</span> <span class="ow">and</span> <span class="n">certifi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ssl_context</span><span class="p">[</span><span class="s1">&#39;cafile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">certifi</span><span class="o">.</span><span class="n">where</span><span class="p">()</span>

    <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="o">**</span><span class="n">ssl_context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allow_insecure</span><span class="p">:</span>
        <span class="n">ssl_context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ssl_context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>

    <span class="k">if</span> <span class="n">cert_chain</span><span class="p">:</span>
        <span class="n">ssl_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="o">**</span><span class="n">cert_chain</span><span class="p">)</span>

    <span class="n">https_handler</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">HTTPSHandler</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ftp_tls</span><span class="p">:</span>
        <span class="n">urlopener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">_FTPTLSHandler</span><span class="p">(),</span> <span class="n">https_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">urlopener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">https_handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">urlopener</span>


<span class="k">def</span> <span class="nf">_try_url_open</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">http_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ftp_tls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for opening a URL while handling TLS/SSL verification issues.&quot;&quot;&quot;</span>
    <span class="c1"># Import ssl here to avoid import failure when running in pyodide/Emscripten</span>
    <span class="kn">import</span> <span class="nn">ssl</span>

    <span class="c1"># Always try first with a secure connection</span>
    <span class="c1"># _build_urlopener uses lru_cache, so the ssl_context argument must be</span>
    <span class="c1"># converted to a hashshable type (a set of 2-tuples)</span>
    <span class="n">ssl_context</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">ssl_context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ssl_context</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="n">urlopener</span> <span class="o">=</span> <span class="n">_build_urlopener</span><span class="p">(</span><span class="n">ftp_tls</span><span class="o">=</span><span class="n">ftp_tls</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                 <span class="n">allow_insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">urlopener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">reason</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">reason</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;CERTIFICATE_VERIFY_FAILED&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Verification of TLS/SSL certificate at </span><span class="si">{</span><span class="n">source_url</span><span class="si">}</span><span class="s1"> &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;failed: this can mean either the server is &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;misconfigured or your local root CA certificates are &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;out-of-date; in the latter case this can usually be &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;addressed by installing the Python package &quot;certifi&quot; &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;(see the documentation for astropy.utils.data.download_url)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_insecure</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39; or in both cases you can work around this by &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;passing allow_insecure=True, but only if you &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;understand the implications; the original error &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;was: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;. Re-trying with allow_insecure=True.&#39;</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AstropyWarning</span><span class="p">)</span>
                <span class="c1"># Try again with a new urlopener allowing insecure connections</span>
                <span class="n">urlopener</span> <span class="o">=</span> <span class="n">_build_urlopener</span><span class="p">(</span><span class="n">ftp_tls</span><span class="o">=</span><span class="n">ftp_tls</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                                             <span class="n">allow_insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">urlopener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="k">raise</span>


<span class="k">def</span> <span class="nf">_download_file_from_source</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">remote_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">,</span>
                               <span class="n">http_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ftp_tls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">astropy.utils.console</span> <span class="kn">import</span> <span class="n">ProgressBarOrSpinner</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">allow_internet</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;URL </span><span class="si">{</span><span class="n">remote_url</span><span class="si">}</span><span class="s2"> was supposed to be downloaded but &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;allow_internet is </span><span class="si">{</span><span class="n">conf</span><span class="o">.</span><span class="n">allow_internet</span><span class="si">}</span><span class="s2">; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;if this is unexpected check the astropy.cfg file for the option &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;allow_internet&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">remote_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">remote_url</span> <span class="o">=</span> <span class="n">source_url</span>
    <span class="k">if</span> <span class="n">http_headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">http_headers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">ftp_tls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">remote_url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;ftp&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_download_file_from_source</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span>
                                              <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
                                              <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                                              <span class="n">remote_url</span><span class="o">=</span><span class="n">remote_url</span><span class="p">,</span>
                                              <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                              <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
                                              <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">,</span>
                                              <span class="n">ftp_tls</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># e.reason might not be a string, e.g. socket.gaierror</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ftp error: error_perm&quot;</span><span class="p">):</span>
                <span class="n">ftp_tls</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">with</span> <span class="n">_try_url_open</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">,</span>
                       <span class="n">ftp_tls</span><span class="o">=</span><span class="n">ftp_tls</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                       <span class="n">allow_insecure</span><span class="o">=</span><span class="n">allow_insecure</span><span class="p">)</span> <span class="k">as</span> <span class="n">remote</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check_free_space_in_dir</span><span class="p">(</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>
                <span class="n">check_free_space_in_dir</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_progress</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
            <span class="n">progress_stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">source_url</span> <span class="o">==</span> <span class="n">remote_url</span><span class="p">:</span>
            <span class="n">dlmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">remote_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">remote_url</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">source_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="n">ProgressBarOrSpinner</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dlmsg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">progress_stream</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;astropy-download-</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">-&quot;</span><span class="p">,</span>
                                    <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">download_block_size</span><span class="p">)</span>
                    <span class="k">while</span> <span class="n">block</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                        <span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">)</span>
                        <span class="n">block</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">download_block_size</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;File was supposed to be </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> bytes but &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;server provides more, at least </span><span class="si">{</span><span class="n">bytes_read</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;bytes. Download failed.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bytes_read</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">ContentTooShortError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;File was supposed to be </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> bytes but we &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;only got </span><span class="si">{</span><span class="n">bytes_read</span><span class="si">}</span><span class="s2"> bytes. Download failed.&quot;</span><span class="p">,</span>
                            <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">raise</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>


<div class="viewcode-block" id="download_file"><a class="viewcode-back" href="../../../api/astropy.utils.data.download_file.html#astropy.utils.data.download_file">[docs]</a><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">remote_url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">,</span> <span class="n">http_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Downloads a URL and optionally caches the result.</span>

<span class="sd">    It returns the filename of a file containing the URL&#39;s contents.</span>
<span class="sd">    If ``cache=True`` and the file is present in the cache, just</span>
<span class="sd">    returns the filename; if the file had to be downloaded, add it</span>
<span class="sd">    to the cache. If ``cache=&quot;update&quot;`` always download and add it</span>
<span class="sd">    to the cache.</span>

<span class="sd">    The cache is effectively a dictionary mapping URLs to files; by default the</span>
<span class="sd">    file contains the contents of the URL that is its key, but in practice</span>
<span class="sd">    these can be obtained from a mirror (using ``sources``) or imported from</span>
<span class="sd">    the local filesystem (using `~import_file_to_cache` or</span>
<span class="sd">    `~import_download_cache`).  Regardless, each file is regarded as</span>
<span class="sd">    representing the contents of a particular URL, and this URL should be used</span>
<span class="sd">    to look them up or otherwise manipulate them.</span>

<span class="sd">    The files in the cache directory are named according to a cryptographic</span>
<span class="sd">    hash of their URLs (currently MD5, so hackers can cause collisions).</span>
<span class="sd">    The modification times on these files normally indicate when they were</span>
<span class="sd">    last downloaded from the Internet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    remote_url : str</span>
<span class="sd">        The URL of the file to download</span>

<span class="sd">    cache : bool or &quot;update&quot;, optional</span>
<span class="sd">        Whether to cache the contents of remote URLs. If &quot;update&quot;,</span>
<span class="sd">        always download the remote URL in case there is a new version</span>
<span class="sd">        and store the result in the cache.</span>

<span class="sd">    show_progress : bool, optional</span>
<span class="sd">        Whether to display a progress bar during the download (default</span>
<span class="sd">        is `True`). Regardless of this setting, the progress bar is only</span>
<span class="sd">        displayed when outputting to a terminal.</span>

<span class="sd">    timeout : float, optional</span>
<span class="sd">        Timeout for remote requests in seconds (default is the configurable</span>
<span class="sd">        `astropy.utils.data.Conf.remote_timeout`).</span>

<span class="sd">    sources : list of str, optional</span>
<span class="sd">        If provided, a list of URLs to try to obtain the file from. The</span>
<span class="sd">        result will be stored under the original URL. The original URL</span>
<span class="sd">        will *not* be tried unless it is in this list; this is to prevent</span>
<span class="sd">        long waits for a primary server that is known to be inaccessible</span>
<span class="sd">        at the moment. If an empty list is passed, then ``download_file``</span>
<span class="sd">        will not attempt to connect to the Internet, that is, if the file</span>
<span class="sd">        is not in the cache a KeyError will be raised.</span>

<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    http_headers : dict or None</span>
<span class="sd">        HTTP request headers to pass into ``urlopen`` if needed. (These headers</span>
<span class="sd">        are ignored if the protocol for the ``name_or_obj``/``sources`` entry</span>
<span class="sd">        is not a remote HTTP URL.) In the default case (None), the headers are</span>
<span class="sd">        ``User-Agent: some_value`` and ``Accept: */*``, where ``some_value``</span>
<span class="sd">        is set by ``astropy.utils.data.conf.default_http_user_agent``.</span>

<span class="sd">    ssl_context : dict, optional</span>
<span class="sd">        Keyword arguments to pass to `ssl.create_default_context` when</span>
<span class="sd">        downloading from HTTPS or TLS+FTP sources.  This can be used provide</span>
<span class="sd">        alternative paths to root CA certificates.  Additionally, if the key</span>
<span class="sd">        ``&#39;certfile&#39;`` and optionally ``&#39;keyfile&#39;`` and ``&#39;password&#39;`` are</span>
<span class="sd">        included, they are passed to `ssl.SSLContext.load_cert_chain`.  This</span>
<span class="sd">        can be used for performing SSL/TLS client certificate authentication</span>
<span class="sd">        for servers that require it.</span>

<span class="sd">    allow_insecure : bool, optional</span>
<span class="sd">        Allow downloading files over a TLS/SSL connection even when the server</span>
<span class="sd">        certificate verification failed.  When set to `True` the potentially</span>
<span class="sd">        insecure download is allowed to proceed, but an</span>
<span class="sd">        `~astropy.utils.exceptions.AstropyWarning` is issued.  If you are</span>
<span class="sd">        frequently getting certificate verification warnings, consider</span>
<span class="sd">        installing or upgrading `certifi`_ package, which provides frequently</span>
<span class="sd">        updated certificates for common root CAs (i.e., a set similar to those</span>
<span class="sd">        used by web browsers).  If installed, Astropy will use it</span>
<span class="sd">        automatically.</span>

<span class="sd">        .. _certifi: https://pypi.org/project/certifi/</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    local_path : str</span>
<span class="sd">        Returns the local path that the file was download to.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        Whenever there&#39;s a problem getting the remote file.</span>
<span class="sd">    KeyError</span>
<span class="sd">        When a file was requested from the cache but is missing and no</span>
<span class="sd">        sources were provided to obtain it from the Internet.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Because this function returns a filename, another process could run</span>
<span class="sd">    `clear_download_cache` before you actually open the file, leaving</span>
<span class="sd">    you with a filename that no longer points to a usable file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">remote_timeout</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">remote_url</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">http_headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">http_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="o">.</span><span class="n">default_http_user_agent</span><span class="p">,</span>
                        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;*/*&#39;</span><span class="p">}</span>

    <span class="n">missing_cache</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">url_key</span> <span class="o">=</span> <span class="n">remote_url</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_cache</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cache directory cannot be read or created (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">), &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;providing data in temporary file instead.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache value &#39;</span><span class="si">{</span><span class="n">cache</span><span class="si">}</span><span class="s2">&#39; was requested but &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;&#39;update&#39; is the only recognized string; &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;otherwise use a boolean&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">_url_to_dirname</span><span class="p">(</span><span class="n">url_key</span><span class="p">),</span> <span class="s2">&quot;contents&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">source_url</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f_name</span> <span class="o">=</span> <span class="n">_download_file_from_source</span><span class="p">(</span>
                    <span class="n">source_url</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
                    <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                    <span class="n">remote_url</span><span class="o">=</span><span class="n">remote_url</span><span class="p">,</span>
                    <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
                    <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">,</span>
                    <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                    <span class="n">allow_insecure</span><span class="o">=</span><span class="n">allow_insecure</span><span class="p">)</span>
            <span class="c1"># Success!</span>
            <span class="k">break</span>

        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># errno 8 is from SSL &quot;EOF occurred in violation of protocol&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">strerror</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">strerror</span> <span class="o">+</span>
                                     <span class="s1">&#39;. requested URL: &#39;</span>
                                     <span class="o">+</span> <span class="n">remote_url</span><span class="p">)</span>
                <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
            <span class="n">errors</span><span class="p">[</span><span class="n">source_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1"># No success</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No sources listed and file </span><span class="si">{</span><span class="n">remote_url</span><span class="si">}</span><span class="s2"> not in cache! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please include primary URL in sources if you want it to be &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;included as a valid source.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to open any source! Exceptions were </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> \
                <span class="kn">from</span> <span class="nn">errors</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">import_file_to_cache</span><span class="p">(</span><span class="n">url_key</span><span class="p">,</span> <span class="n">f_name</span><span class="p">,</span>
                                        <span class="n">remove_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">replace</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span> <span class="o">==</span> <span class="s1">&#39;update&#39;</span><span class="p">),</span>
                                        <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Cache is readonly, we can&#39;t update it</span>
            <span class="n">missing_cache</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cache directory appears to be read-only (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">), unable to import &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;downloaded file, providing data in temporary file </span><span class="si">{</span><span class="n">f_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;instead.&quot;</span><span class="p">)</span>
        <span class="c1"># FIXME: other kinds of cache problem can occur?</span>

    <span class="k">if</span> <span class="n">missing_cache</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">CacheMissingWarning</span><span class="p">(</span><span class="n">missing_cache</span><span class="p">,</span> <span class="n">f_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">delete_temporary_downloads_at_exit</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">_tempfilestodel</span>
        <span class="n">_tempfilestodel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_url_in_cache"><a class="viewcode-back" href="../../../api/astropy.utils.data.is_url_in_cache.html#astropy.utils.data.is_url_in_cache">[docs]</a><span class="k">def</span> <span class="nf">is_url_in_cache</span><span class="p">(</span><span class="n">url_key</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a download for ``url_key`` is in the cache.</span>

<span class="sd">    The provided ``url_key`` will be the name used in the cache. The contents</span>
<span class="sd">    may have been downloaded from this URL or from a mirror or they may have</span>
<span class="sd">    been provided by the user. See `~download_file` for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url_key : str</span>
<span class="sd">        The URL retrieved</span>
<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    in_cache : bool</span>
<span class="sd">        `True` if a download for ``url_key`` is in the cache, `False` if not</span>
<span class="sd">        or if the cache does not exist at all.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    cache_contents : obtain a dictionary listing everything in the cache</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">_url_to_dirname</span><span class="p">(</span><span class="n">url_key</span><span class="p">),</span> <span class="s2">&quot;contents&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="cache_total_size"><a class="viewcode-back" href="../../../api/astropy.utils.data.cache_total_size.html#astropy.utils.data.cache_total_size">[docs]</a><span class="k">def</span> <span class="nf">cache_total_size</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the total size in bytes of all files in the cache.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dldir</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">size</span></div>


<span class="k">def</span> <span class="nf">_do_download_files_in_parallel</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">astropy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">set_temp_config</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;temp_config&quot;</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">astropy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">set_temp_cache</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;temp_cache&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">download_file</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="download_files_in_parallel"><a class="viewcode-back" href="../../../api/astropy.utils.data.download_files_in_parallel.html#astropy.utils.data.download_files_in_parallel">[docs]</a><span class="k">def</span> <span class="nf">download_files_in_parallel</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span>
                               <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span>
                               <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">multiprocessing_start_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download multiple files in parallel from the given URLs.</span>

<span class="sd">    Blocks until all files have downloaded.  The result is a list of</span>
<span class="sd">    local file paths corresponding to the given urls.</span>

<span class="sd">    The results will be stored in the cache under the values in ``urls`` even</span>
<span class="sd">    if they are obtained from some other location via ``sources``. See</span>
<span class="sd">    `~download_file` for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    urls : list of str</span>
<span class="sd">        The URLs to retrieve.</span>

<span class="sd">    cache : bool or &quot;update&quot;, optional</span>
<span class="sd">        Whether to use the cache (default is `True`). If &quot;update&quot;,</span>
<span class="sd">        always download the remote URLs to see if new data is available</span>
<span class="sd">        and store the result in cache.</span>

<span class="sd">        .. versionchanged:: 4.0</span>
<span class="sd">            The default was changed to ``&quot;update&quot;`` and setting it to</span>
<span class="sd">            ``False`` will print a Warning and set it to ``&quot;update&quot;`` again,</span>
<span class="sd">            because the function will not work properly without cache. Using</span>
<span class="sd">            ``True`` will work as expected.</span>

<span class="sd">        .. versionchanged:: 3.0</span>
<span class="sd">            The default was changed to ``True`` and setting it to ``False``</span>
<span class="sd">            will print a Warning and set it to ``True`` again, because the</span>
<span class="sd">            function will not work properly without cache.</span>

<span class="sd">    show_progress : bool, optional</span>
<span class="sd">        Whether to display a progress bar during the download (default</span>
<span class="sd">        is `True`)</span>

<span class="sd">    timeout : float, optional</span>
<span class="sd">        Timeout for each individual requests in seconds (default is the</span>
<span class="sd">        configurable `astropy.utils.data.Conf.remote_timeout`).</span>

<span class="sd">    sources : dict, optional</span>
<span class="sd">        If provided, for each URL a list of URLs to try to obtain the</span>
<span class="sd">        file from. The result will be stored under the original URL.</span>
<span class="sd">        For any URL in this dictionary, the original URL will *not* be</span>
<span class="sd">        tried unless it is in this list; this is to prevent long waits</span>
<span class="sd">        for a primary server that is known to be inaccessible at the</span>
<span class="sd">        moment.</span>

<span class="sd">    multiprocessing_start_method : str, optional</span>
<span class="sd">        Useful primarily for testing; if in doubt leave it as the default.</span>
<span class="sd">        When using multiprocessing, certain anomalies occur when starting</span>
<span class="sd">        processes with the &quot;spawn&quot; method (the only option on Windows);</span>
<span class="sd">        other anomalies occur with the &quot;fork&quot; method (the default on</span>
<span class="sd">        Linux).</span>

<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    paths : list of str</span>
<span class="sd">        The local file paths corresponding to the downloaded URLs.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If a URL is unreachable, the downloading will grind to a halt and the</span>
<span class="sd">    exception will propagate upward, but an unpredictable number of</span>
<span class="sd">    files will have been successfully downloaded and will remain in</span>
<span class="sd">    the cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.console</span> <span class="kn">import</span> <span class="n">ProgressBar</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">remote_timeout</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
        <span class="c1"># See issue #6662, on windows won&#39;t work because the files are removed</span>
        <span class="c1"># again before they can be used. On *NIX systems it will behave as if</span>
        <span class="c1"># cache was set to True because multiprocessing cannot insert the items</span>
        <span class="c1"># in the list of to-be-removed files. This could be fixed, but really,</span>
        <span class="c1"># just use the cache, with update_cache if appropriate.</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Disabling the cache does not work because of multiprocessing, &#39;</span>
             <span class="s1">&#39;it will be set to ``&quot;update&quot;``. You may need to manually remove &#39;</span>
             <span class="s1">&#39;the cached files with clear_download_cache() afterwards.&#39;</span><span class="p">,</span>
             <span class="n">AstropyWarning</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span>

    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

    <span class="c1"># Combine duplicate URLs</span>
    <span class="n">combined_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">urls</span><span class="p">))</span>
    <span class="n">combined_paths</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">_do_download_files_in_parallel</span><span class="p">,</span>
        <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">remote_url</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
              <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
              <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
              <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
              <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
              <span class="n">temp_cache</span><span class="o">=</span><span class="n">astropy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">set_temp_cache</span><span class="o">.</span><span class="n">_temp_path</span><span class="p">,</span>
              <span class="n">temp_config</span><span class="o">=</span><span class="n">astropy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">set_temp_config</span><span class="o">.</span><span class="n">_temp_path</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">combined_urls</span><span class="p">],</span>
        <span class="n">file</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
        <span class="n">multiprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">multiprocessing_start_method</span><span class="o">=</span><span class="n">multiprocessing_start_method</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_paths</span><span class="p">[</span><span class="n">combined_urls</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">url</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">paths</span></div>


<span class="c1"># This is used by download_file and _deltemps to determine the files to delete</span>
<span class="c1"># when the interpreter exits</span>
<span class="n">_tempfilestodel</span> <span class="o">=</span> <span class="p">[]</span>


<span class="nd">@atexit</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">_deltemps</span><span class="p">():</span>

    <span class="k">global</span> <span class="n">_tempfilestodel</span>

    <span class="k">if</span> <span class="n">_tempfilestodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tempfilestodel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">_tempfilestodel</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># oh well we tried</span>
                    <span class="c1"># could be held open by some process, on Windows</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c1"># couldn&#39;t get rid of it, sorry</span>
                    <span class="c1"># could be held open by some process, on Windows</span>
                    <span class="k">pass</span>


<div class="viewcode-block" id="clear_download_cache"><a class="viewcode-back" href="../../../api/astropy.utils.data.clear_download_cache.html#astropy.utils.data.clear_download_cache">[docs]</a><span class="k">def</span> <span class="nf">clear_download_cache</span><span class="p">(</span><span class="n">hashorurl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clears the data file cache by deleting the local file(s).</span>

<span class="sd">    If a URL is provided, it will be the name used in the cache. The contents</span>
<span class="sd">    may have been downloaded from this URL or from a mirror or they may have</span>
<span class="sd">    been provided by the user. See `~download_file` for details.</span>

<span class="sd">    For the purposes of this function, a file can also be identified by a hash</span>
<span class="sd">    of its contents or by the filename under which the data is stored (as</span>
<span class="sd">    returned by `~download_file`, for example).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hashorurl : str or None</span>
<span class="sd">        If None, the whole cache is cleared.  Otherwise, specify</span>
<span class="sd">        a hash for the cached file that is supposed to be deleted,</span>
<span class="sd">        the full path to a file in the cache that should be deleted,</span>
<span class="sd">        or a URL that should be removed from the cache if present.</span>

<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Problem arose when trying to open the cache</span>
        <span class="c1"># Just a warning, though</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Not clearing data cache - cache inaccessible due to &#39;</span>
        <span class="n">estr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">CacheMissingWarning</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">estr</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hashorurl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Optional: delete old incompatible caches too</span>
            <span class="n">_rmtree</span><span class="p">(</span><span class="n">dldir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_is_url</span><span class="p">(</span><span class="n">hashorurl</span><span class="p">):</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">_url_to_dirname</span><span class="p">(</span><span class="n">hashorurl</span><span class="p">))</span>
            <span class="n">_rmtree</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not a URL, it should be either a filename or a hash</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">hashorurl</span><span class="p">)</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">dldir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;attempted to use clear_download_cache on the path &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> outside the data cache directory </span><span class="si">{</span><span class="n">dldir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;contents&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">]:</span>
                <span class="c1"># It&#39;s a filename not the hash of a URL</span>
                <span class="c1"># so we want to zap the directory containing the</span>
                <span class="c1"># files &quot;url&quot; and &quot;contents&quot;</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="n">_rmtree</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hashorurl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span><span class="o">.</span><span class="n">digest_size</span>
                    <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9a-f]+&quot;</span><span class="p">,</span> <span class="n">hashorurl</span><span class="p">)):</span>
                <span class="c1"># It&#39;s the hash of some file contents, we have to find the right file</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">_find_hash_fn</span><span class="p">(</span><span class="n">hashorurl</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">clear_download_cache</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Not clearing data from cache - problem arose &#39;</span>
        <span class="n">estr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">CacheMissingWarning</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">estr</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds the path to the cache directory and makes them if they don&#39;t exist.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    datadir : str</span>
<span class="sd">        The path to the data cache directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">astropy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">get_cache_dir</span><span class="p">(</span><span class="n">pkgname</span><span class="p">),</span> <span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
                    <span class="k">raise</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data cache directory </span><span class="si">{</span><span class="n">datadir</span><span class="si">}</span><span class="s1"> is not a directory&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">datadir</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Remote data cache could not be accessed due to &#39;</span>
        <span class="n">estr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">CacheMissingWarning</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">estr</span><span class="p">))</span>
        <span class="k">raise</span>


<span class="k">def</span> <span class="nf">_url_to_dirname</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malformed URL: &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="c1"># Make domain names case-insensitive</span>
    <span class="c1"># Also makes the http:// case-insensitive</span>
    <span class="n">urlobj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="n">urlobj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">urlobj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">urlobj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">urlobj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">urlobj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">urlobj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
    <span class="n">url_c</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">(</span><span class="n">urlobj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">url_c</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ReadOnlyDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;This object is read-only.&quot;</span><span class="p">)</span>


<span class="n">_NOTHING</span> <span class="o">=</span> <span class="n">ReadOnlyDict</span><span class="p">({})</span>


<div class="viewcode-block" id="CacheDamaged"><a class="viewcode-back" href="../../../api/astropy.utils.data.CacheDamaged.html#astropy.utils.data.CacheDamaged">[docs]</a><span class="k">class</span> <span class="nc">CacheDamaged</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Record the URL or file that was a problem.</span>
<span class="sd">    Using clear_download_cache on the .bad_file or .bad_url attribute,</span>
<span class="sd">    whichever is not None, should resolve this particular problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">bad_urls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bad_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_urls</span> <span class="o">=</span> <span class="n">bad_urls</span> <span class="k">if</span> <span class="n">bad_urls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_files</span> <span class="o">=</span> <span class="n">bad_files</span> <span class="k">if</span> <span class="n">bad_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="check_download_cache"><a class="viewcode-back" href="../../../api/astropy.utils.data.check_download_cache.html#astropy.utils.data.check_download_cache">[docs]</a><span class="k">def</span> <span class="nf">check_download_cache</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do a consistency check on the cache.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Since v5.0, this function no longer returns anything.</span>

<span class="sd">    Because the cache is shared by all versions of ``astropy`` in all virtualenvs</span>
<span class="sd">    run by your user, possibly concurrently, it could accumulate problems.</span>
<span class="sd">    This could lead to hard-to-debug problems or wasted space. This function</span>
<span class="sd">    detects a number of incorrect conditions, including nonexistent files that</span>
<span class="sd">    are indexed, files that are indexed but in the wrong place, and, if you</span>
<span class="sd">    request it, files whose content does not match the hash that is indexed.</span>

<span class="sd">    This function also returns a list of non-indexed files. A few will be</span>
<span class="sd">    associated with the shelve object; their exact names depend on the backend</span>
<span class="sd">    used but will probably be based on ``urlmap``. The presence of other files</span>
<span class="sd">    probably indicates that something has gone wrong and inaccessible files</span>
<span class="sd">    have accumulated in the cache. These can be removed with</span>
<span class="sd">    :func:`clear_download_cache`, either passing the filename returned here, or</span>
<span class="sd">    with no arguments to empty the entire cache and return it to a</span>
<span class="sd">    reasonable, if empty, state.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pkgname : str, optional</span>
<span class="sd">        The package name to use to locate the download cache, i.e., for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    `~astropy.utils.data.CacheDamaged`</span>
<span class="sd">        To indicate a problem with the cache contents; the exception contains</span>
<span class="sd">        a ``.bad_files`` attribute containing a set of filenames to allow the</span>
<span class="sd">        user to use :func:`clear_download_cache` to remove the offending items.</span>
<span class="sd">    OSError, RuntimeError</span>
<span class="sd">        To indicate some problem with the cache structure. This may need a full</span>
<span class="sd">        :func:`clear_download_cache` to resolve, or may indicate some kind of</span>
<span class="sd">        misconfiguration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bad_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">dldir</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rmtree-&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_tempfilestodel</span><span class="p">:</span>
                    <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache entry </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> not scheduled for deletion&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sf</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;contents&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">sf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sf</span><span class="p">)</span>
                    <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected file f</span><span class="si">{</span><span class="n">sf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">urlf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">urlf</span><span class="p">):</span>
                    <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">urlf</span><span class="p">)</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Problem with URL file f</span><span class="si">{</span><span class="n">urlf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">get_file_contents</span><span class="p">(</span><span class="n">urlf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                        <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malformed URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hashname</span> <span class="o">=</span> <span class="n">_url_to_dirname</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">hashname</span><span class="p">:</span>
                            <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL hashes to </span><span class="si">{</span><span class="n">hashname</span><span class="si">}</span><span class="s2"> but is stored in </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">)):</span>
                    <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is missing contents&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> with hash </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is missing contents&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Left-over non-directory </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> in cache&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bad_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CacheDamaged</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span> <span class="n">bad_files</span><span class="o">=</span><span class="n">bad_files</span><span class="p">)</span></div>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">_SafeTemporaryDirectory</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Temporary directory context manager</span>

<span class="sd">    This will not raise an exception if the temporary directory goes away</span>
<span class="sd">    before it&#39;s supposed to be deleted. Specifically, what is deleted will</span>
<span class="sd">    be the directory *name* produced; if no such directory exists, no</span>
<span class="sd">    exception will be raised.</span>

<span class="sd">    It would be safer to delete it only if it&#39;s really the same directory</span>
<span class="sd">    - checked by file descriptor - and if it&#39;s still called the same thing.</span>
<span class="sd">    But that opens a platform-specific can of worms.</span>

<span class="sd">    It would also be more robust to use ExitStack and TemporaryDirectory,</span>
<span class="sd">    which is more aggressive about removing readonly things.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">d</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;More-atomic rmtree. Ignores missing directory.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;rmtree-&quot;</span><span class="p">,</span>
                            <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;to-zap&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">CacheMissingWarning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to remove directory </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> because a file in it &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is in use and you are on Windows&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">replace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">replace</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="c1"># already there, fine</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTEMPTY</span><span class="p">:</span>
                    <span class="c1"># already there, fine</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>


<div class="viewcode-block" id="import_file_to_cache"><a class="viewcode-back" href="../../../api/astropy.utils.data.import_file_to_cache.html#astropy.utils.data.import_file_to_cache">[docs]</a><span class="k">def</span> <span class="nf">import_file_to_cache</span><span class="p">(</span><span class="n">url_key</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                         <span class="n">remove_original</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">,</span>
                         <span class="o">*</span><span class="p">,</span>
                         <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import the on-disk file specified by filename to the cache.</span>

<span class="sd">    The provided ``url_key`` will be the name used in the cache. The file</span>
<span class="sd">    should contain the contents of this URL, at least notionally (the URL may</span>
<span class="sd">    be temporarily or permanently unavailable). It is using ``url_key`` that</span>
<span class="sd">    users will request these contents from the cache. See :func:`download_file` for</span>
<span class="sd">    details.</span>

<span class="sd">    If ``url_key`` already exists in the cache, it will be updated to point to</span>
<span class="sd">    these imported contents, and its old contents will be deleted from the</span>
<span class="sd">    cache.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url_key : str</span>
<span class="sd">        The key to index the file under. This should probably be</span>
<span class="sd">        the URL where the file was located, though if you obtained</span>
<span class="sd">        it from a mirror you should use the URL of the primary</span>
<span class="sd">        location.</span>
<span class="sd">    filename : str</span>
<span class="sd">        The file whose contents you want to import.</span>
<span class="sd">    remove_original : bool</span>
<span class="sd">        Whether to remove the original file (``filename``) once import is</span>
<span class="sd">        complete.</span>
<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>
<span class="sd">    replace : boolean, optional</span>
<span class="sd">        Whether or not to replace an existing object in the cache, if one exists.</span>
<span class="sd">        If replacement is not requested but the object exists, silently pass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="n">cache_dirname</span> <span class="o">=</span> <span class="n">_url_to_dirname</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span>
    <span class="n">local_dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">cache_dirname</span><span class="p">)</span>
    <span class="n">local_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dirname</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_SafeTemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;temp_dir&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
        <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">)</span>
        <span class="c1"># Make sure we&#39;re on the same filesystem</span>
        <span class="c1"># This will raise an exception if the url_key doesn&#39;t turn into a valid filename</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">),</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">_rmtree</span><span class="p">(</span><span class="n">local_dirname</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">local_dirname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="c1"># already there, fine</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTEMPTY</span><span class="p">:</span>
                    <span class="c1"># already there, fine</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
    <span class="k">if</span> <span class="n">remove_original</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_cached_urls"><a class="viewcode-back" href="../../../api/astropy.utils.data.get_cached_urls.html#astropy.utils.data.get_cached_urls">[docs]</a><span class="k">def</span> <span class="nf">get_cached_urls</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the list of URLs in the cache. Especially useful for looking up what</span>
<span class="sd">    files are stored in your cache when you don&#39;t have internet access.</span>

<span class="sd">    The listed URLs are the keys programs should use to access the file</span>
<span class="sd">    contents, but those contents may have actually been obtained from a mirror.</span>
<span class="sd">    See `~download_file` for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cached_urls : list</span>
<span class="sd">        List of cached URLs.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    cache_contents : obtain a dictionary listing everything in the cache</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cache_contents</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="cache_contents"><a class="viewcode-back" href="../../../api/astropy.utils.data.cache_contents.html#astropy.utils.data.cache_contents">[docs]</a><span class="k">def</span> <span class="nf">cache_contents</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obtain a dict mapping cached URLs to filenames.</span>

<span class="sd">    This dictionary is a read-only snapshot of the state of the cache when this</span>
<span class="sd">    function was called. If other processes are actively working with the</span>
<span class="sd">    cache, it is possible for them to delete files that are listed in this</span>
<span class="sd">    dictionary. Use with some caution if you are working on a system that is</span>
<span class="sd">    busy with many running astropy processes, although the same issues apply to</span>
<span class="sd">    most functions in this module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dldir</span> <span class="o">=</span> <span class="n">_get_download_cache_loc</span><span class="p">(</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_NOTHING</span>
    <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">dldir</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">get_file_contents</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">r</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dldir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;contents&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ReadOnlyDict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="export_download_cache"><a class="viewcode-back" href="../../../api/astropy.utils.data.export_download_cache.html#astropy.utils.data.export_download_cache">[docs]</a><span class="k">def</span> <span class="nf">export_download_cache</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">,</span> <span class="n">urls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exports the cache contents as a ZIP file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename_or_obj : str or file-like</span>
<span class="sd">        Where to put the created ZIP file. Must be something the zipfile</span>
<span class="sd">        module can write to.</span>
<span class="sd">    urls : iterable of str or None</span>
<span class="sd">        The URLs to include in the exported cache. The default is all</span>
<span class="sd">        URLs currently in the cache. If a URL is included in this list</span>
<span class="sd">        but is not currently in the cache, a KeyError will be raised.</span>
<span class="sd">        To ensure that all are in the cache use `~download_file`</span>
<span class="sd">        or `~download_files_in_parallel`.</span>
<span class="sd">    overwrite : bool, optional</span>
<span class="sd">        If filename_or_obj is a filename that exists, it will only be</span>
<span class="sd">        overwritten if this is True.</span>
<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    import_download_cache : import the contents of such a ZIP file</span>
<span class="sd">    import_file_to_cache : import a single file directly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">urls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="n">get_cached_urls</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="k">if</span> <span class="n">overwrite</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[],</span> <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span>
            <span class="c1"># Do not use os.path.join because ZIP files want</span>
            <span class="c1"># &quot;/&quot; on all platforms</span>
            <span class="n">z_fn</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">z_fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="import_download_cache"><a class="viewcode-back" href="../../../api/astropy.utils.data.import_download_cache.html#astropy.utils.data.import_download_cache">[docs]</a><span class="k">def</span> <span class="nf">import_download_cache</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">,</span> <span class="n">urls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="s1">&#39;astropy&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Imports the contents of a ZIP file into the cache.</span>

<span class="sd">    Each member of the ZIP file should be named by a quoted version of the</span>
<span class="sd">    URL whose contents it stores. These names are decoded with</span>
<span class="sd">    :func:`~urllib.parse.unquote`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename_or_obj : str or file-like</span>
<span class="sd">        Where the stored ZIP file is. Must be something the :mod:`~zipfile`</span>
<span class="sd">        module can read from.</span>
<span class="sd">    urls : set of str or list of str or None</span>
<span class="sd">        The URLs to import from the ZIP file. The default is all</span>
<span class="sd">        URLs in the file.</span>
<span class="sd">    update_cache : bool, optional</span>
<span class="sd">        If True, any entry in the ZIP file will overwrite the value in the</span>
<span class="sd">        cache; if False, leave untouched any entry already in the cache.</span>
<span class="sd">    pkgname : `str`, optional</span>
<span class="sd">        The package name to use to locate the download cache. i.e. for</span>
<span class="sd">        ``pkgname=&#39;astropy&#39;`` the default cache location is</span>
<span class="sd">        ``~/.astropy/cache``.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    export_download_cache : export the contents the cache to of such a ZIP file</span>
<span class="sd">    import_file_to_cache : import a single file directly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">,</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">zf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">infolist</span><span class="p">()):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># FIXME(aarchiba): do we want some kind of validation on this URL?</span>
            <span class="c1"># urllib.parse might do something sensible...but what URLs might</span>
            <span class="c1"># they have?</span>
            <span class="c1"># is_url in this file is probably a good check, not just here</span>
            <span class="c1"># but throughout this file.</span>
            <span class="k">if</span> <span class="n">urls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update_cache</span> <span class="ow">and</span> <span class="n">is_url_in_cache</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">f_temp_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">z</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zf</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_zip</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_temp_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_temp</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">f_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">download_block_size</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">block</span><span class="p">:</span>
                    <span class="n">f_temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="n">f_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">download_block_size</span><span class="p">)</span>
            <span class="n">import_file_to_cache</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">f_temp_name</span><span class="p">,</span>
                                 <span class="n">remove_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 20112022, The Astropy Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.5.4. &nbsp;
    Last built 09 May 2022. <br/>
  </p>
</footer>
  </body>
</html>