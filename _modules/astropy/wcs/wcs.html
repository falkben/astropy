


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astropy.wcs.wcs &#8212; Astropy v5.2.dev104+gcdd6a1f81.d20220509</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
  <meta name="robots" content="noindex, nofollow">
  
  
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>


  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">Astropy v5.2.dev104+gcdd6a1f81.d20220509</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >Module code</a> &#187;</li>
      <li><a href="../wcs.html" accesskey="U">astropy.wcs</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astropy.wcs.wcs</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="c1"># Under the hood, there are 3 separate classes that perform different</span>
<span class="c1"># parts of the transformation:</span>
<span class="c1">#</span>
<span class="c1">#    - `~astropy.wcs.Wcsprm`: Is a direct wrapper of the core WCS</span>
<span class="c1">#      functionality in `wcslib`_.  (This includes TPV and TPD</span>
<span class="c1">#      polynomial distortion, but not SIP distortion).</span>
<span class="c1">#</span>
<span class="c1">#    - `~astropy.wcs.Sip`: Handles polynomial distortion as defined in the</span>
<span class="c1">#      `SIP`_ convention.</span>
<span class="c1">#</span>
<span class="c1">#    - `~astropy.wcs.DistortionLookupTable`: Handles `distortion paper`_</span>
<span class="c1">#      lookup tables.</span>
<span class="c1">#</span>
<span class="c1"># Additionally, the class `WCS` aggregates all of these transformations</span>
<span class="c1"># together in a pipeline:</span>
<span class="c1">#</span>
<span class="c1">#    - Detector to image plane correction (by a pair of</span>
<span class="c1">#      `~astropy.wcs.DistortionLookupTable` objects).</span>
<span class="c1">#</span>
<span class="c1">#    - `SIP`_ distortion correction (by an underlying `~astropy.wcs.Sip`</span>
<span class="c1">#      object)</span>
<span class="c1">#</span>
<span class="c1">#    - `distortion paper`_ table-lookup correction (by a pair of</span>
<span class="c1">#      `~astropy.wcs.DistortionLookupTable` objects).</span>
<span class="c1">#</span>
<span class="c1">#    - `wcslib`_ WCS transformation (by a `~astropy.wcs.Wcsprm` object)</span>

<span class="c1"># STDLIB</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">builtins</span>

<span class="c1"># THIRD-</span>
<span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># LOCAL</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">docstrings</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_wcs</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.utils.compat</span> <span class="kn">import</span> <span class="n">possible_filename</span>
<span class="kn">from</span> <span class="nn">astropy.utils.exceptions</span> <span class="kn">import</span> <span class="n">AstropyWarning</span><span class="p">,</span> <span class="n">AstropyUserWarning</span><span class="p">,</span> <span class="n">AstropyDeprecationWarning</span>
<span class="kn">from</span> <span class="nn">astropy.utils.decorators</span> <span class="kn">import</span> <span class="n">deprecated_renamed_argument</span>

<span class="c1"># Mix-in class that provides the APE 14 API</span>
<span class="kn">from</span> <span class="nn">.wcsapi.fitswcs</span> <span class="kn">import</span> <span class="n">FITSWCSAPIMixin</span><span class="p">,</span> <span class="n">SlicedFITSWCS</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FITSFixedWarning&#39;</span><span class="p">,</span> <span class="s1">&#39;WCS&#39;</span><span class="p">,</span> <span class="s1">&#39;find_all_wcs&#39;</span><span class="p">,</span>
           <span class="s1">&#39;DistortionLookupTable&#39;</span><span class="p">,</span> <span class="s1">&#39;Sip&#39;</span><span class="p">,</span> <span class="s1">&#39;Tabprm&#39;</span><span class="p">,</span> <span class="s1">&#39;Wcsprm&#39;</span><span class="p">,</span> <span class="s1">&#39;Auxprm&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Celprm&#39;</span><span class="p">,</span> <span class="s1">&#39;Prjprm&#39;</span><span class="p">,</span> <span class="s1">&#39;Wtbarr&#39;</span><span class="p">,</span> <span class="s1">&#39;WCSBase&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="s1">&#39;WcsError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SingularMatrixError&#39;</span><span class="p">,</span> <span class="s1">&#39;InconsistentAxisTypesError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;InvalidTransformError&#39;</span><span class="p">,</span> <span class="s1">&#39;InvalidCoordinateError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;InvalidPrjParametersError&#39;</span><span class="p">,</span> <span class="s1">&#39;NoSolutionError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;InvalidSubimageSpecificationError&#39;</span><span class="p">,</span> <span class="s1">&#39;NoConvergence&#39;</span><span class="p">,</span>
           <span class="s1">&#39;NonseparableSubimageCoordinateSystemError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;NoWcsKeywordsFoundError&#39;</span><span class="p">,</span> <span class="s1">&#39;InvalidTabularParametersError&#39;</span><span class="p">]</span>


<span class="n">__doctest_skip__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WCS.all_world2pix&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="n">_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;5.8&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;astropy.wcs is built with wcslib </span><span class="si">{0}</span><span class="s2">, but only versions 5.8 and &quot;</span>
            <span class="s2">&quot;later on the 5.x series are known to work.  The version of wcslib &quot;</span>
            <span class="s2">&quot;that ships with astropy may be used.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">_sanity_check</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;astropy.wcs did not pass its sanity check for your build &quot;</span>
            <span class="s2">&quot;on your platform.&quot;</span><span class="p">)</span>

    <span class="n">_WCSSUB_TIME_SUPPORT</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;7.8&quot;</span><span class="p">)</span>
    <span class="n">_WCS_TPD_WARN_LT71</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;7.1&quot;</span><span class="p">)</span>
    <span class="n">_WCS_TPD_WARN_LT74</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;7.4&quot;</span><span class="p">)</span>

    <span class="n">WCSBase</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">_Wcs</span>
    <span class="n">DistortionLookupTable</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">DistortionLookupTable</span>
    <span class="n">Sip</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Sip</span>
    <span class="n">Wcsprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wcsprm</span>
    <span class="n">Auxprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Auxprm</span>
    <span class="n">Celprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Celprm</span>
    <span class="n">Prjprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Prjprm</span>
    <span class="n">Tabprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Tabprm</span>
    <span class="n">Wtbarr</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wtbarr</span>
    <span class="n">WcsError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">WcsError</span>
    <span class="n">SingularMatrixError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">SingularMatrixError</span>
    <span class="n">InconsistentAxisTypesError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">InconsistentAxisTypesError</span>
    <span class="n">InvalidTransformError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">InvalidTransformError</span>
    <span class="n">InvalidCoordinateError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">InvalidCoordinateError</span>
    <span class="n">NoSolutionError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">NoSolutionError</span>
    <span class="n">InvalidSubimageSpecificationError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">InvalidSubimageSpecificationError</span>
    <span class="n">NonseparableSubimageCoordinateSystemError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">NonseparableSubimageCoordinateSystemError</span>
    <span class="n">NoWcsKeywordsFoundError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">NoWcsKeywordsFoundError</span>
    <span class="n">InvalidTabularParametersError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">InvalidTabularParametersError</span>
    <span class="n">InvalidPrjParametersError</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">InvalidPrjParametersError</span>

    <span class="c1"># Copy all the constants from the C extension into this module&#39;s namespace</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_wcs</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;WCSSUB_&#39;</span><span class="p">,</span> <span class="s1">&#39;WCSHDR_&#39;</span><span class="p">,</span> <span class="s1">&#39;WCSHDO_&#39;</span><span class="p">,</span> <span class="s1">&#39;WCSCOMPARE_&#39;</span><span class="p">,</span> <span class="s1">&#39;PRJ_&#39;</span><span class="p">)):</span>
            <span class="nb">locals</span><span class="p">()[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># Set coordinate extraction callback for WCS -TAB:</span>
    <span class="k">def</span> <span class="nf">_load_tab_bintable</span><span class="p">(</span><span class="n">hdulist</span><span class="p">,</span> <span class="n">extnam</span><span class="p">,</span> <span class="n">extver</span><span class="p">,</span> <span class="n">extlev</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[(</span><span class="n">extnam</span><span class="p">,</span> <span class="n">extver</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ttype</span><span class="p">][</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">ndim</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad TDIM&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">_wcs</span><span class="o">.</span><span class="n">set_wtbarr_fitsio_callback</span><span class="p">(</span><span class="n">_load_tab_bintable</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">WCSBase</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">Wcsprm</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">DistortionLookupTable</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">Sip</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">Tabprm</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">Wtbarr</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">WcsError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">SingularMatrixError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">InconsistentAxisTypesError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">InvalidTransformError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">InvalidCoordinateError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">NoSolutionError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">InvalidSubimageSpecificationError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">NonseparableSubimageCoordinateSystemError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">NoWcsKeywordsFoundError</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">InvalidTabularParametersError</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_WCSSUB_TIME_SUPPORT</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_WCS_TPD_WARN_LT71</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_WCS_TPD_WARN_LT74</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># Additional relax bit flags</span>
<span class="n">WCSHDO_SIP</span> <span class="o">=</span> <span class="mh">0x80000</span>

<span class="c1"># Regular expression defining SIP keyword It matches keyword that starts with A</span>
<span class="c1"># or B, optionally followed by P, followed by an underscore then a number in</span>
<span class="c1"># range of 0-19, followed by an underscore and another number in range of 0-19.</span>
<span class="c1"># Keyword optionally ends with a capital letter.</span>
<span class="n">SIP_KW</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;^[AB]P?_1?[0-9]_1?[0-9][A-Z]?$&#39;&#39;&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_keysel</span><span class="p">(</span><span class="n">keysel</span><span class="p">):</span>
    <span class="n">keysel_flags</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">keysel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">keysel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                <span class="n">keysel_flags</span> <span class="o">|=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">WCSHDR_IMGHEAD</span>
            <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
                <span class="n">keysel_flags</span> <span class="o">|=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">WCSHDR_BIMGARR</span>
            <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
                <span class="n">keysel_flags</span> <span class="o">|=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">WCSHDR_PIXLIST</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;keysel must be a list of &#39;image&#39;, &#39;binary&#39; &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;and/or &#39;pixel&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keysel_flags</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">keysel_flags</span>


<div class="viewcode-block" id="NoConvergence"><a class="viewcode-back" href="../../../api/astropy.wcs.NoConvergence.html#astropy.wcs.NoConvergence">[docs]</a><span class="k">class</span> <span class="nc">NoConvergence</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An error class used to report non-convergence and/or divergence</span>
<span class="sd">    of numerical methods. It is used to report errors in the</span>
<span class="sd">    iterative solution used by</span>
<span class="sd">    the :py:meth:`~astropy.wcs.WCS.all_world2pix`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    best_solution : `numpy.ndarray`</span>
<span class="sd">        Best solution achieved by the numerical method.</span>

<span class="sd">    accuracy : `numpy.ndarray`</span>
<span class="sd">        Accuracy of the ``best_solution``.</span>

<span class="sd">    niter : `int`</span>
<span class="sd">        Number of iterations performed by the numerical method</span>
<span class="sd">        to compute ``best_solution``.</span>

<span class="sd">    divergent : None, `numpy.ndarray`</span>
<span class="sd">        Indices of the points in ``best_solution`` array</span>
<span class="sd">        for which the solution appears to be divergent. If the</span>
<span class="sd">        solution does not diverge, ``divergent`` will be set to `None`.</span>

<span class="sd">    slow_conv : None, `numpy.ndarray`</span>
<span class="sd">        Indices of the solutions in ``best_solution`` array</span>
<span class="sd">        for which the solution failed to converge within the</span>
<span class="sd">        specified maximum number of iterations. If there are no</span>
<span class="sd">        non-converging solutions (i.e., if the required accuracy</span>
<span class="sd">        has been achieved for all input data points)</span>
<span class="sd">        then ``slow_conv`` will be set to `None`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">best_solution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">divergent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slow_conv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">best_solution</span> <span class="o">=</span> <span class="n">best_solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="n">niter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divergent</span> <span class="o">=</span> <span class="n">divergent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_conv</span> <span class="o">=</span> <span class="n">slow_conv</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Function received unexpected arguments (</span><span class="si">{}</span><span class="s2">) these &quot;</span>
                          <span class="s2">&quot;are ignored but will raise an Exception in the &quot;</span>
                          <span class="s2">&quot;future.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)),</span>
                          <span class="n">AstropyDeprecationWarning</span><span class="p">)</span></div>


<div class="viewcode-block" id="FITSFixedWarning"><a class="viewcode-back" href="../../../api/astropy.wcs.FITSFixedWarning.html#astropy.wcs.FITSFixedWarning">[docs]</a><span class="k">class</span> <span class="nc">FITSFixedWarning</span><span class="p">(</span><span class="n">AstropyWarning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The warning raised when the contents of the FITS header have been</span>
<span class="sd">    modified to be standards compliant.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="WCS"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS">[docs]</a><span class="k">class</span> <span class="nc">WCS</span><span class="p">(</span><span class="n">FITSWCSAPIMixin</span><span class="p">,</span> <span class="n">WCSBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;WCS objects perform standard WCS transformations, and correct for</span>
<span class="sd">    `SIP`_ and `distortion paper`_ table-lookup transformations, based</span>
<span class="sd">    on the WCS keywords and supplementary data read from a FITS file.</span>

<span class="sd">    See also: https://docs.astropy.org/en/stable/wcs/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : `~astropy.io.fits.Header`, `~astropy.io.fits.hdu.image.PrimaryHDU`, `~astropy.io.fits.hdu.image.ImageHDU`, str, dict-like, or None, optional</span>
<span class="sd">        If *header* is not provided or None, the object will be</span>
<span class="sd">        initialized to default values.</span>

<span class="sd">    fobj : `~astropy.io.fits.HDUList`, optional</span>
<span class="sd">        It is needed when header keywords point to a `distortion</span>
<span class="sd">        paper`_ lookup table stored in a different extension.</span>

<span class="sd">    key : str, optional</span>
<span class="sd">        The name of a particular WCS transform to use.  This may be</span>
<span class="sd">        either ``&#39; &#39;`` or ``&#39;A&#39;``-``&#39;Z&#39;`` and corresponds to the</span>
<span class="sd">        ``\&quot;a\&quot;`` part of the ``CTYPEia`` cards.  *key* may only be</span>
<span class="sd">        provided if *header* is also provided.</span>

<span class="sd">    minerr : float, optional</span>
<span class="sd">        The minimum value a distortion correction must have in order</span>
<span class="sd">        to be applied. If the value of ``CQERRja`` is smaller than</span>
<span class="sd">        *minerr*, the corresponding distortion is not applied.</span>

<span class="sd">    relax : bool or int, optional</span>
<span class="sd">        Degree of permissiveness:</span>

<span class="sd">        - `True` (default): Admit all recognized informal extensions</span>
<span class="sd">          of the WCS standard.</span>

<span class="sd">        - `False`: Recognize only FITS keywords defined by the</span>
<span class="sd">          published WCS standard.</span>

<span class="sd">        - `int`: a bit field selecting specific extensions to accept.</span>
<span class="sd">          See :ref:`astropy:relaxread` for details.</span>

<span class="sd">    naxis : int or sequence, optional</span>
<span class="sd">        Extracts specific coordinate axes using</span>
<span class="sd">        :meth:`~astropy.wcs.Wcsprm.sub`.  If a header is provided, and</span>
<span class="sd">        *naxis* is not ``None``, *naxis* will be passed to</span>
<span class="sd">        :meth:`~astropy.wcs.Wcsprm.sub` in order to select specific</span>
<span class="sd">        axes from the header.  See :meth:`~astropy.wcs.Wcsprm.sub` for</span>
<span class="sd">        more details about this parameter.</span>

<span class="sd">    keysel : sequence of str, optional</span>
<span class="sd">        A sequence of flags used to select the keyword types</span>
<span class="sd">        considered by wcslib.  When ``None``, only the standard image</span>
<span class="sd">        header keywords are considered (and the underlying wcspih() C</span>
<span class="sd">        function is called).  To use binary table image array or pixel</span>
<span class="sd">        list keywords, *keysel* must be set.</span>

<span class="sd">        Each element in the list should be one of the following</span>
<span class="sd">        strings:</span>

<span class="sd">        - &#39;image&#39;: Image header keywords</span>

<span class="sd">        - &#39;binary&#39;: Binary table image array keywords</span>

<span class="sd">        - &#39;pixel&#39;: Pixel list keywords</span>

<span class="sd">        Keywords such as ``EQUIna`` or ``RFRQna`` that are common to</span>
<span class="sd">        binary table image arrays and pixel lists (including</span>
<span class="sd">        ``WCSNna`` and ``TWCSna``) are selected by both &#39;binary&#39; and</span>
<span class="sd">        &#39;pixel&#39;.</span>

<span class="sd">    colsel : sequence of int, optional</span>
<span class="sd">        A sequence of table column numbers used to restrict the WCS</span>
<span class="sd">        transformations considered to only those pertaining to the</span>
<span class="sd">        specified columns.  If `None`, there is no restriction.</span>

<span class="sd">    fix : bool, optional</span>
<span class="sd">        When `True` (default), call `~astropy.wcs.Wcsprm.fix` on</span>
<span class="sd">        the resulting object to fix any non-standard uses in the</span>
<span class="sd">        header.  `FITSFixedWarning` Warnings will be emitted if any</span>
<span class="sd">        changes were made.</span>

<span class="sd">    translate_units : str, optional</span>
<span class="sd">        Specify which potentially unsafe translations of non-standard</span>
<span class="sd">        unit strings to perform.  By default, performs none.  See</span>
<span class="sd">        `WCS.fix` for more information about this parameter.  Only</span>
<span class="sd">        effective when ``fix`` is `True`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    MemoryError</span>
<span class="sd">         Memory allocation failed.</span>

<span class="sd">    ValueError</span>
<span class="sd">         Invalid key.</span>

<span class="sd">    KeyError</span>
<span class="sd">         Key not found in FITS header.</span>

<span class="sd">    ValueError</span>
<span class="sd">         Lookup table distortion present in the header but *fobj* was</span>
<span class="sd">         not provided.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    1. astropy.wcs supports arbitrary *n* dimensions for the core WCS</span>
<span class="sd">       (the transformations handled by WCSLIB).  However, the</span>
<span class="sd">       `distortion paper`_ lookup table and `SIP`_ distortions must be</span>
<span class="sd">       two dimensional.  Therefore, if you try to create a WCS object</span>
<span class="sd">       where the core WCS has a different number of dimensions than 2</span>
<span class="sd">       and that object also contains a `distortion paper`_ lookup</span>
<span class="sd">       table or `SIP`_ distortion, a `ValueError`</span>
<span class="sd">       exception will be raised.  To avoid this, consider using the</span>
<span class="sd">       *naxis* kwarg to select two dimensions from the core WCS.</span>

<span class="sd">    2. The number of coordinate axes in the transformation is not</span>
<span class="sd">       determined directly from the ``NAXIS`` keyword but instead from</span>
<span class="sd">       the highest of:</span>

<span class="sd">           - ``NAXIS`` keyword</span>

<span class="sd">           - ``WCSAXESa`` keyword</span>

<span class="sd">           - The highest axis number in any parameterized WCS keyword.</span>
<span class="sd">             The keyvalue, as well as the keyword, must be</span>
<span class="sd">             syntactically valid otherwise it will not be considered.</span>

<span class="sd">       If none of these keyword types is present, i.e. if the header</span>
<span class="sd">       only contains auxiliary WCS keywords for a particular</span>
<span class="sd">       coordinate representation, then no coordinate description is</span>
<span class="sd">       constructed for it.</span>

<span class="sd">       The number of axes, which is set as the ``naxis`` member, may</span>
<span class="sd">       differ for different coordinate representations of the same</span>
<span class="sd">       image.</span>

<span class="sd">    3. When the header includes duplicate keywords, in most cases the</span>
<span class="sd">       last encountered is used.</span>

<span class="sd">    4. `~astropy.wcs.Wcsprm.set` is called immediately after</span>
<span class="sd">       construction, so any invalid keywords or transformations will</span>
<span class="sd">       be raised by the constructor, not when subsequently calling a</span>
<span class="sd">       transformation method.</span>

<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">minerr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">naxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keysel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colsel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translate_units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">_do_set</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">close_fds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># these parameters are stored to be used when unpickling a WCS object:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;keysel&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">keysel</span><span class="p">),</span>
            <span class="s1">&#39;colsel&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">colsel</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">naxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">naxis</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">wcsprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wcsprm</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                 <span class="n">relax</span><span class="o">=</span><span class="n">relax</span><span class="p">,</span> <span class="n">naxis</span><span class="o">=</span><span class="n">naxis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">=</span> <span class="n">wcsprm</span><span class="o">.</span><span class="n">naxis</span>
            <span class="c1"># Set some reasonable defaults.</span>
            <span class="n">det2im</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cpdis</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">sip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keysel_flags</span> <span class="o">=</span> <span class="n">_parse_keysel</span><span class="p">(</span><span class="n">keysel</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">is_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">possible_filename</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="ow">and</span>
                               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">is_path</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">is_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Can not provide both a FITS filename to &quot;</span>
                            <span class="s2">&quot;argument 1 and a FITS file object to argument 2&quot;</span><span class="p">)</span>
                    <span class="n">fobj</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="n">close_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">_ImageBaseHDU</span><span class="p">):</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">header</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Accept any dict-like object</span>
                    <span class="n">orig_header</span> <span class="o">=</span> <span class="n">header</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">dict_key</span> <span class="ow">in</span> <span class="n">orig_header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">header</span><span class="p">[</span><span class="n">dict_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_header</span><span class="p">[</span><span class="n">dict_key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;header must be a string, an astropy.io.fits.Header &quot;</span>
                        <span class="s2">&quot;object, or a dict-like object&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
                <span class="n">header_string</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header_string</span> <span class="o">=</span> <span class="n">header</span>

            <span class="c1"># Importantly, header is a *copy* of the passed-in header</span>
            <span class="c1"># because we will be modifying it</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">header_string</span> <span class="o">=</span> <span class="n">header_string</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_string</span>
                <span class="n">header_string</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fobj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;&#39;fobj&#39; must be either None or an &quot;</span>
                                     <span class="s2">&quot;astropy.io.fits.HDUList object.&quot;</span><span class="p">)</span>

            <span class="n">est_naxis</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_sip_kw</span><span class="p">(</span><span class="n">tmp_header</span><span class="p">)</span>
                <span class="n">tmp_header_bytes</span> <span class="o">=</span> <span class="n">tmp_header</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_header_bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">tmp_header_bytes</span> <span class="o">=</span> <span class="n">tmp_header_bytes</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">tmp_wcsprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wcsprm</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">tmp_header_bytes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                         <span class="n">relax</span><span class="o">=</span><span class="n">relax</span><span class="p">,</span> <span class="n">keysel</span><span class="o">=</span><span class="n">keysel_flags</span><span class="p">,</span>
                                         <span class="n">colsel</span><span class="o">=</span><span class="n">colsel</span><span class="p">,</span> <span class="n">warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">hdulist</span><span class="o">=</span><span class="n">fobj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">naxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tmp_wcsprm</span> <span class="o">=</span> <span class="n">tmp_wcsprm</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">naxis</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">est_naxis</span> <span class="o">=</span> <span class="n">tmp_wcsprm</span><span class="o">.</span><span class="n">naxis</span> <span class="k">if</span> <span class="n">tmp_wcsprm</span><span class="o">.</span><span class="n">naxis</span> <span class="k">else</span> <span class="mi">2</span>

            <span class="k">except</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">NoWcsKeywordsFoundError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">=</span> <span class="n">est_naxis</span>

            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header_string</span><span class="p">)</span>

            <span class="n">det2im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_det2im_kw</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">minerr</span><span class="p">)</span>
            <span class="n">cpdis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_distortion_kw</span><span class="p">(</span>
                <span class="n">header</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;CPDIS&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">minerr</span><span class="p">)</span>
            <span class="n">sip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_sip_kw</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">wcskey</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_sip_kw</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

            <span class="n">header_string</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
            <span class="n">header_string</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;END&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">77</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">header_string</span> <span class="o">=</span> <span class="n">header_string</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_string</span>
                <span class="n">header_string</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">wcsprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wcsprm</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header_bytes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                     <span class="n">relax</span><span class="o">=</span><span class="n">relax</span><span class="p">,</span> <span class="n">keysel</span><span class="o">=</span><span class="n">keysel_flags</span><span class="p">,</span>
                                     <span class="n">colsel</span><span class="o">=</span><span class="n">colsel</span><span class="p">,</span> <span class="n">hdulist</span><span class="o">=</span><span class="n">fobj</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">NoWcsKeywordsFoundError</span><span class="p">:</span>
                <span class="c1"># The header may have SIP or distortions, but no core</span>
                <span class="c1"># WCS.  That isn&#39;t an error -- we want a &quot;default&quot;</span>
                <span class="c1"># (identity) core Wcs transformation in that case.</span>
                <span class="k">if</span> <span class="n">colsel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wcsprm</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wcsprm</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                         <span class="n">relax</span><span class="o">=</span><span class="n">relax</span><span class="p">,</span> <span class="n">keysel</span><span class="o">=</span><span class="n">keysel_flags</span><span class="p">,</span>
                                         <span class="n">colsel</span><span class="o">=</span><span class="n">colsel</span><span class="p">,</span> <span class="n">hdulist</span><span class="o">=</span><span class="n">fobj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="k">if</span> <span class="n">naxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wcsprm</span> <span class="o">=</span> <span class="n">wcsprm</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">naxis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">=</span> <span class="n">wcsprm</span><span class="o">.</span><span class="n">naxis</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">wcsprm</span><span class="o">.</span><span class="n">naxis</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">det2im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">det2im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cpdis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cpdis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">sip</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">FITS WCS distortion paper lookup tables and SIP distortions only work</span>
<span class="sd">in 2 dimensions.  However, WCSLIB has detected {} dimensions in the</span>
<span class="sd">core WCS keywords.  To use core WCS in conjunction with FITS WCS</span>
<span class="sd">distortion paper lookup tables or SIP distortion, you must select or</span>
<span class="sd">reduce these to 2 dimensions using the naxis kwarg.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wcsprm</span><span class="o">.</span><span class="n">naxis</span><span class="p">))</span>

            <span class="n">header_naxis</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header_naxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">header_naxis</span> <span class="o">&lt;</span> <span class="n">wcsprm</span><span class="o">.</span><span class="n">naxis</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The WCS transformation has more axes (</span><span class="si">{:d}</span><span class="s2">) than the &quot;</span>
                    <span class="s2">&quot;image it is associated with (</span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">wcsprm</span><span class="o">.</span><span class="n">naxis</span><span class="p">,</span> <span class="n">header_naxis</span><span class="p">),</span> <span class="n">FITSFixedWarning</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_naxis</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">WCSBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sip</span><span class="p">,</span> <span class="n">cpdis</span><span class="p">,</span> <span class="n">wcsprm</span><span class="p">,</span> <span class="n">det2im</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">FITSFixedWarning</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">translate_units</span><span class="o">=</span><span class="n">translate_units</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">translate_units</span><span class="o">=</span><span class="n">translate_units</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_do_set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">close_fds</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_bounds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
        <span class="n">WCSBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">new_copy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="p">,</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpdis1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpdis2</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det2im1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2im2</span><span class="p">))</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_copy</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

        <span class="n">new_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="n">naxis</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="n">WCSBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">new_copy</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="p">,</span> <span class="n">memo</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpdis1</span><span class="p">,</span> <span class="n">memo</span><span class="p">),</span>
                          <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpdis2</span><span class="p">,</span> <span class="n">memo</span><span class="p">)),</span>
                         <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="n">memo</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det2im1</span><span class="p">,</span> <span class="n">memo</span><span class="p">),</span>
                          <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det2im2</span><span class="p">,</span> <span class="n">memo</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_copy</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_copy</span>

<div class="viewcode-block" id="WCS.copy"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a shallow copy of the object.</span>

<span class="sd">        Convenience method so user doesn&#39;t have to import the</span>
<span class="sd">        :mod:`copy` stdlib module.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Use `deepcopy` instead of `copy` unless you know why you need a</span>
<span class="sd">            shallow copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="WCS.deepcopy"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.deepcopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a deep copy of the object.</span>

<span class="sd">        Convenience method so user doesn&#39;t have to import the</span>
<span class="sd">        :mod:`copy` stdlib module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="WCS.sub"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.sub">[docs]</a>    <span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c1"># We need to know which axes have been dropped, but there is no easy</span>
        <span class="c1"># way to do this with the .sub function, so instead we assign UUIDs to</span>
        <span class="c1"># the CNAME parameters in copy.wcs. We can later access the original</span>
        <span class="c1"># CNAME properties from self.wcs.</span>
        <span class="n">cname_uuid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span><span class="p">)]</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cname</span> <span class="o">=</span> <span class="n">cname_uuid</span>

        <span class="c1"># Subset the WCS</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">naxis</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span>

        <span class="c1"># Construct a list of dimensions from the original WCS in the order</span>
        <span class="c1"># in which they appear in the final WCS.</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">cname_uuid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span> <span class="k">if</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">cname_uuid</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">copy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cname</span><span class="p">]</span>

        <span class="c1"># Restore the original CNAMEs</span>
        <span class="n">copy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cname</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span>

        <span class="c1"># Subset pixel_shape and pixel_bounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_shape</span><span class="p">:</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">pixel_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="kc">None</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_bounds</span><span class="p">:</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">pixel_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">copy</span></div>

    <span class="k">if</span> <span class="n">_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sub</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">Wcsprm</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="k">def</span> <span class="nf">_fix_scamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove SCAMP&#39;s PVi_m distortion parameters if SIP distortion parameters</span>
<span class="sd">        are also present. Some projects (e.g., Palomar Transient Factory)</span>
<span class="sd">        convert SCAMP&#39;s distortion parameters (which abuse the PVi_m cards) to</span>
<span class="sd">        SIP. However, wcslib gets confused by the presence of both SCAMP and</span>
<span class="sd">        SIP distortion parameters.</span>

<span class="sd">        See https://github.com/astropy/astropy/issues/299.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Nothing to be done if no WCS attached</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Nothing to be done if no PV parameters attached</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_pv</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pv</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Nothing to be done if axes don&#39;t use SIP distortion parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Nothing to be done if any radial terms are present...</span>
        <span class="c1"># Loop over list to find any radial terms.</span>
        <span class="c1"># Certain values of the `j&#39; index are used for storing</span>
        <span class="c1"># radial terms; refer to Equation (1) in</span>
        <span class="c1"># &lt;http://web.ipac.caltech.edu/staff/shupe/reprints/SIP_to_PV_SPIE2012.pdf&gt;.</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
        <span class="c1"># Loop over distinct values of `i&#39; index</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">pv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># Get all values of `j&#39; index for this value of `i&#39; index</span>
            <span class="n">js</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][</span><span class="n">pv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
            <span class="c1"># Find max value of `j&#39; index</span>
            <span class="n">max_j</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">39</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_j</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">js</span><span class="p">:</span>
                    <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">set_pv</span><span class="p">([])</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Removed redundant SCAMP distortion parameters &quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;because SIP parameters are also present&quot;</span><span class="p">,</span> <span class="n">FITSFixedWarning</span><span class="p">)</span>

<div class="viewcode-block" id="WCS.fix"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.fix">[docs]</a>    <span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">translate_units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">naxis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the fix operations from wcslib, and warn about any</span>
<span class="sd">        changes it has made.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        translate_units : str, optional</span>
<span class="sd">            Specify which potentially unsafe translations of</span>
<span class="sd">            non-standard unit strings to perform.  By default,</span>
<span class="sd">            performs none.</span>

<span class="sd">            Although ``&quot;S&quot;`` is commonly used to represent seconds,</span>
<span class="sd">            its translation to ``&quot;s&quot;`` is potentially unsafe since the</span>
<span class="sd">            standard recognizes ``&quot;S&quot;`` formally as Siemens, however</span>
<span class="sd">            rarely that may be used.  The same applies to ``&quot;H&quot;`` for</span>
<span class="sd">            hours (Henry), and ``&quot;D&quot;`` for days (Debye).</span>

<span class="sd">            This string controls what to do in such cases, and is</span>
<span class="sd">            case-insensitive.</span>

<span class="sd">            - If the string contains ``&quot;s&quot;``, translate ``&quot;S&quot;`` to</span>
<span class="sd">              ``&quot;s&quot;``.</span>

<span class="sd">            - If the string contains ``&quot;h&quot;``, translate ``&quot;H&quot;`` to</span>
<span class="sd">              ``&quot;h&quot;``.</span>

<span class="sd">            - If the string contains ``&quot;d&quot;``, translate ``&quot;D&quot;`` to</span>
<span class="sd">              ``&quot;d&quot;``.</span>

<span class="sd">            Thus ``&#39;&#39;`` doesn&#39;t do any unsafe translations, whereas</span>
<span class="sd">            ``&#39;shd&#39;`` does all of them.</span>

<span class="sd">        naxis : int array, optional</span>
<span class="sd">            Image axis lengths.  If this array is set to zero or</span>
<span class="sd">            ``None``, then `~astropy.wcs.Wcsprm.cylfix` will not be</span>
<span class="sd">            invoked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fix_scamp</span><span class="p">()</span>
            <span class="n">fixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">translate_units</span><span class="p">,</span> <span class="n">naxis</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">fixes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;No change&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;datfix&#39;</span> <span class="ow">and</span> <span class="s1">&#39;1858-11-17&#39;</span> <span class="ow">in</span> <span class="n">val</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">mjdref</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; made the change &#39;</span><span class="si">{1}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
                        <span class="n">FITSFixedWarning</span><span class="p">)</span></div>

<div class="viewcode-block" id="WCS.calc_footprint"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.calc_footprint">[docs]</a>    <span class="k">def</span> <span class="nf">calc_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">undistort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the footprint of the image on the sky.</span>

<span class="sd">        A footprint is defined as the positions of the corners of the</span>
<span class="sd">        image on the sky after all available distortions have been</span>
<span class="sd">        applied.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : `~astropy.io.fits.Header` object, optional</span>
<span class="sd">            Used to get ``NAXIS1`` and ``NAXIS2``</span>
<span class="sd">            header and axes are mutually exclusive, alternative ways</span>
<span class="sd">            to provide the same information.</span>

<span class="sd">        undistort : bool, optional</span>
<span class="sd">            If `True`, take SIP and distortion lookup table into</span>
<span class="sd">            account</span>

<span class="sd">        axes : (int, int), optional</span>
<span class="sd">            If provided, use the given sequence as the shape of the</span>
<span class="sd">            image.  Otherwise, use the ``NAXIS1`` and ``NAXIS2``</span>
<span class="sd">            keywords from the header that was used to create this</span>
<span class="sd">            `WCS` object.</span>

<span class="sd">        center : bool, optional</span>
<span class="sd">            If `True` use the center of the pixel, otherwise use the corner.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coord : (4, 2) array of (*x*, *y*) coordinates.</span>
<span class="sd">            The order is clockwise starting with the bottom left corner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># classes that inherit from WCS and define naxis1/2</span>
                    <span class="c1"># do not require a header parameter</span>
                    <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_shape</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Need a valid header in order to calculate footprint</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">AstropyUserWarning</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">naxis1</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">naxis2</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">naxis1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">naxis2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Image size could not be determined.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">naxis1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">naxis2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">naxis1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">naxis2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">naxis1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">undistort</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_det2im_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `distortion paper`_ type lookup table for detector to</span>
<span class="sd">        image plane correction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">axiscorr</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;AXISCORR&#39;</span><span class="p">]</span>
            <span class="n">d2imdis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_d2im_old_format</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">axiscorr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d2imdis</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;D2IMDIS&#39;</span>
        <span class="n">d_kw</span> <span class="o">=</span> <span class="s1">&#39;D2IM&#39;</span>
        <span class="n">err_kw</span> <span class="o">=</span> <span class="s1">&#39;D2IMERR&#39;</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">d_error</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">err_kw</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d_error</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="n">distortion</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distortion</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">dis</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">distortion</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dis</span> <span class="o">==</span> <span class="s1">&#39;lookup&#39;</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">distortion</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">),</span> <span class="p">(</span>
                        <span class="s1">&#39;An astropy.io.fits.HDUList&#39;</span>
                        <span class="s1">&#39;is required for Lookup table distortion.&#39;</span><span class="p">)</span>
                    <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_kw</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">dp_extver_key</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">+</span> <span class="s1">&#39;.EXTVER&#39;</span>
                    <span class="k">if</span> <span class="n">dp_extver_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                        <span class="n">d_extver</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_extver_key</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_extver_key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_extver</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">dp_axis_key</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;.AXIS.</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_axis_key</span><span class="p">]:</span>
                        <span class="n">d_data</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;D2IMARR&#39;</span><span class="p">,</span> <span class="n">d_extver</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;D2IMARR&#39;</span><span class="p">,</span> <span class="n">d_extver</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_axis_key</span><span class="p">]</span>
                    <span class="n">d_header</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;D2IMARR&#39;</span><span class="p">,</span> <span class="n">d_extver</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                    <span class="n">d_crpix</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="n">d_crval</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="n">d_cdelt</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                    <span class="n">d_lookup</span> <span class="o">=</span> <span class="n">DistortionLookupTable</span><span class="p">(</span><span class="n">d_data</span><span class="p">,</span> <span class="n">d_crpix</span><span class="p">,</span>
                                                     <span class="n">d_crval</span><span class="p">,</span> <span class="n">d_cdelt</span><span class="p">)</span>
                    <span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_lookup</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Polynomial distortion is not implemented.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">AstropyUserWarning</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_read_d2im_old_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">axiscorr</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The use of ``AXISCORR`` for D2IM correction has been deprecated.&quot;</span>
            <span class="s2">&quot;`~astropy.wcs` will read in files with ``AXISCORR`` but ``to_fits()`` will write &quot;</span>
            <span class="s2">&quot;out files without it.&quot;</span><span class="p">,</span>
            <span class="n">AstropyDeprecationWarning</span><span class="p">)</span>
        <span class="n">cpdis</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">crpix</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">crval</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">cdelt</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d2im_data</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[(</span><span class="s1">&#39;D2IMARR&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">d2im_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d2im_data</span><span class="p">])</span>
        <span class="n">d2im_hdr</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[(</span><span class="s1">&#39;D2IMARR&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">naxis</span> <span class="o">=</span> <span class="n">d2im_hdr</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">crpix</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2im_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRPIX&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">crval</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2im_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">cdelt</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2im_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CDELT&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">cpdis</span> <span class="o">=</span> <span class="n">DistortionLookupTable</span><span class="p">(</span><span class="n">d2im_data</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">crval</span><span class="p">,</span> <span class="n">cdelt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axiscorr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">cpdis</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axiscorr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">cpdis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Expected AXISCORR to be 1 or 2&quot;</span><span class="p">,</span> <span class="n">AstropyUserWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_det2im</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdulist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a `distortion paper`_ type lookup table to the given</span>
<span class="sd">        `~astropy.io.fits.HDUList`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2im1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2im2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;D2IMDIS&#39;</span>
        <span class="n">d_kw</span> <span class="o">=</span> <span class="s1">&#39;D2IM&#39;</span>

        <span class="k">def</span> <span class="nf">write_d2i</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">det2im</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">det2im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dist</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;LOOKUP&#39;</span><span class="p">,</span> <span class="s1">&#39;Detector to image correction type&#39;</span><span class="p">)</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.EXTVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;Version number of WCSDVARR extension&#39;</span><span class="p">)</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.NAXES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;Number of independent variables in D2IM function&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">jth</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;1st&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;2nd&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;3rd&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">th&#39;</span><span class="p">)</span>
                <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.AXIS.</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Axis number of the </span><span class="si">{</span><span class="n">jth</span><span class="si">}</span><span class="s1"> variable in a D2IM function&#39;</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;D2IMARR&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span>

            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s1">&#39;Coordinate system reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s1">&#39;Coordinate system reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">crval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s1">&#39;Coordinate system value at reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">crval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s1">&#39;Coordinate system value at reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s1">&#39;Coordinate increment along axis&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">det2im</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s1">&#39;Coordinate increment along axis&#39;</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.EXTVER&#39;</span><span class="p">])</span>
            <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">write_d2i</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2im1</span><span class="p">)</span>
        <span class="n">write_d2i</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2im2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_distortion_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;CPDIS&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads `distortion paper`_ table-lookup keywords and data, and</span>
<span class="sd">        returns a 2-tuple of `~astropy.wcs.DistortionLookupTable`</span>
<span class="sd">        objects.</span>

<span class="sd">        If no `distortion paper`_ keywords are found, ``(None, None)``</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;CPDIS&#39;</span><span class="p">:</span>
            <span class="n">d_kw</span> <span class="o">=</span> <span class="s1">&#39;DP&#39;</span>
            <span class="n">err_kw</span> <span class="o">=</span> <span class="s1">&#39;CPERR&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_kw</span> <span class="o">=</span> <span class="s1">&#39;DQ&#39;</span>
            <span class="n">err_kw</span> <span class="o">=</span> <span class="s1">&#39;CQERR&#39;</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">d_error_key</span> <span class="o">=</span> <span class="n">err_kw</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d_error_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">d_error</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">d_error_key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">d_error_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_error</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">d_error</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="n">distortion</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distortion</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">dis</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">distortion</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">distortion</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dis</span> <span class="o">==</span> <span class="s1">&#39;lookup&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;an astropy.io.fits.HDUList is &#39;</span>
                                         <span class="s1">&#39;required for Lookup table distortion.&#39;</span><span class="p">)</span>
                    <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_kw</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">dp_extver_key</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">+</span> <span class="s1">&#39;.EXTVER&#39;</span>
                    <span class="k">if</span> <span class="n">dp_extver_key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                        <span class="n">d_extver</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_extver_key</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_extver_key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_extver</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">dp_axis_key</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;.AXIS.</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_axis_key</span><span class="p">]:</span>
                        <span class="n">d_data</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;WCSDVARR&#39;</span><span class="p">,</span> <span class="n">d_extver</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;WCSDVARR&#39;</span><span class="p">,</span> <span class="n">d_extver</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">dp_axis_key</span><span class="p">]</span>
                    <span class="n">d_header</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;WCSDVARR&#39;</span><span class="p">,</span> <span class="n">d_extver</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                    <span class="n">d_crpix</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                               <span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="n">d_crval</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                               <span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                    <span class="n">d_cdelt</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                               <span class="n">d_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
                    <span class="n">d_lookup</span> <span class="o">=</span> <span class="n">DistortionLookupTable</span><span class="p">(</span><span class="n">d_data</span><span class="p">,</span> <span class="n">d_crpix</span><span class="p">,</span> <span class="n">d_crval</span><span class="p">,</span> <span class="n">d_cdelt</span><span class="p">)</span>
                    <span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_lookup</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Polynomial distortion is not implemented.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">AstropyUserWarning</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_write_distortion_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdulist</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;CPDIS&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out `distortion paper`_ keywords to the given</span>
<span class="sd">        `~astropy.io.fits.HDUList`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpdis1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpdis2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;CPDIS&#39;</span><span class="p">:</span>
            <span class="n">d_kw</span> <span class="o">=</span> <span class="s1">&#39;DP&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_kw</span> <span class="o">=</span> <span class="s1">&#39;DQ&#39;</span>

        <span class="k">def</span> <span class="nf">write_dist</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">cpdis</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cpdis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dist</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;LOOKUP&#39;</span><span class="p">,</span> <span class="s1">&#39;Prior distortion function type&#39;</span><span class="p">)</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.EXTVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;Version number of WCSDVARR extension&#39;</span><span class="p">)</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.NAXES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Number of independent variables in </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s1"> function&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">jth</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;1st&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;2nd&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;3rd&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">th&#39;</span><span class="p">)</span>
                <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.AXIS.</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;Axis number of the </span><span class="si">{</span><span class="n">jth</span><span class="si">}</span><span class="s1"> variable in a </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s1"> function&#39;</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;WCSDVARR&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span>

            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Coordinate system reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Coordinate system reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">crval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Coordinate system value at reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">crval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Coordinate system value at reference pixel&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Coordinate increment along axis&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpdis</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Coordinate increment along axis&#39;</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d_kw</span><span class="si">}{</span><span class="n">num</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">.EXTVER&#39;</span><span class="p">])</span>
            <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="n">write_dist</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpdis1</span><span class="p">)</span>
        <span class="n">write_dist</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpdis2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_sip_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove SIP information from a header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Never pass SIP coefficients to wcslib</span>
        <span class="c1"># CTYPE must be passed with -SIP to wcslib</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">SIP_KW</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
                       <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_read_sip_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">wcskey</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads `SIP`_ header keywords and returns a `~astropy.wcs.Sip`</span>
<span class="sd">        object.</span>

<span class="sd">        If no `SIP`_ header keywords are found, ``None`` is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="c1"># TODO: Parse SIP from a string without pyfits around</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;A_ORDER&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;A_ORDER&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;B_ORDER&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;A_ORDER provided without corresponding B_ORDER &quot;</span>
                    <span class="s2">&quot;keyword for SIP distortion&quot;</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;A_ORDER&quot;</span><span class="p">])</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;B_ORDER&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;B_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;A_ORDER&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;B_ORDER&#39;</span><span class="p">]</span>

            <span class="n">ctype</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;CTYPE</span><span class="si">{</span><span class="n">nax</span><span class="si">}{</span><span class="n">wcskey</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">nax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">ctyp</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-SIP&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctyp</span> <span class="ow">in</span> <span class="n">ctype</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                Inconsistent SIP distortion information is present in the FITS header and the WCS object:</span>
<span class="s2">                SIP coefficients were detected, but CTYPE is missing a &quot;-SIP&quot; suffix.</span>
<span class="s2">                astropy.wcs is using the SIP distortion coefficients,</span>
<span class="s2">                therefore the coordinates calculated here might be incorrect.</span>

<span class="s2">                If you do not want to apply the SIP distortion coefficients,</span>
<span class="s2">                please remove the SIP coefficients from the FITS header or the</span>
<span class="s2">                WCS object.  As an example, if the image is already distortion-corrected</span>
<span class="s2">                (e.g., drizzled) then distortion components should not apply and the SIP</span>
<span class="s2">                coefficients should be removed.</span>

<span class="s2">                While the SIP distortion coefficients are being applied here, if that was indeed the intent,</span>
<span class="s2">                for consistency please append &quot;-SIP&quot; to the CTYPE in the FITS header or the WCS object.</span>

<span class="s2">                &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;B_ORDER&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;B_ORDER&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;B_ORDER provided without corresponding A_ORDER &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;keyword for SIP distortion&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;AP_ORDER&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;AP_ORDER&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;BP_ORDER&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;AP_ORDER provided without corresponding BP_ORDER &quot;</span>
                    <span class="s2">&quot;keyword for SIP distortion&quot;</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;AP_ORDER&quot;</span><span class="p">])</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AP_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                        <span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;BP_ORDER&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BP_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                            <span class="n">bp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ap</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">bp</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;AP_ORDER&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BP_ORDER&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;BP_ORDER&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BP_ORDER&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;BP_ORDER provided without corresponding AP_ORDER &quot;</span>
                <span class="s2">&quot;keyword for SIP distortion&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;CRPIX1</span><span class="si">{</span><span class="n">wcskey</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;CRPIX2</span><span class="si">{</span><span class="n">wcskey</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Header has SIP keywords without CRPIX keywords&quot;</span><span class="p">)</span>

        <span class="n">crpix1</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRPIX1</span><span class="si">{</span><span class="n">wcskey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">crpix2</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRPIX2</span><span class="si">{</span><span class="n">wcskey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Sip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">crpix1</span><span class="p">,</span> <span class="n">crpix2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_write_sip_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out SIP keywords.  Returns a dictionary of key-value</span>
<span class="sd">        pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trdir</span> <span class="o">=</span> <span class="s1">&#39;sky to detector&#39;</span> <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="k">else</span> <span class="s1">&#39;detector to sky&#39;</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SIP polynomial order, axis </span><span class="si">{:d}</span><span class="s1">, </span><span class="si">{:s}</span><span class="s1">&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">),</span> <span class="n">trdir</span><span class="p">))</span>
            <span class="n">keywords</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ORDER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">comment</span>

            <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;SIP distortion coefficient&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">keywords</span><span class="p">[</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">comment</span>

        <span class="n">write_array</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="n">write_array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="n">write_array</span><span class="p">(</span><span class="s1">&#39;AP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">ap</span><span class="p">)</span>
        <span class="n">write_array</span><span class="p">(</span><span class="s1">&#39;BP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">bp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">keywords</span>

    <span class="k">def</span> <span class="nf">_denormalize_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sky</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lngtyp</span> <span class="o">!=</span> <span class="s1">&#39;RA&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;WCS does not have longitude type of &#39;RA&#39;, therefore &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;(ra, dec) data can not be used as input&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lattyp</span> <span class="o">!=</span> <span class="s1">&#39;DEC&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;WCS does not have longitude type of &#39;DEC&#39;, therefore &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;(ra, dec) data can not be used as input&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sky</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Reverse the order of the columns</span>
                <span class="k">return</span> <span class="n">sky</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;WCS does not have longitude and latitude celestial &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;axes, therefore (ra, dec) data can not be used as input&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;WCS does not have both longitude and latitude &quot;</span>
                    <span class="s2">&quot;celestial axes, therefore (ra, dec) data can not be &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;used as input&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sky</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_normalize_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sky</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lngtyp</span> <span class="o">!=</span> <span class="s1">&#39;RA&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;WCS does not have longitude type of &#39;RA&#39;, therefore &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;(ra, dec) data can not be returned&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lattyp</span> <span class="o">!=</span> <span class="s1">&#39;DEC&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;WCS does not have longitude type of &#39;DEC&#39;, therefore &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;(ra, dec) data can not be returned&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sky</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Reverse the order of the columns</span>
                <span class="k">return</span> <span class="n">sky</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;WCS does not have longitude and latitude celestial &quot;</span>
                    <span class="s2">&quot;axes, therefore (ra, dec) data can not be returned&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;WCS does not have both longitude and latitude celestial &quot;</span>
                    <span class="s2">&quot;axes, therefore (ra, dec) data can not be returned&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">sky</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_array_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">sky</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ra_dec_order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function to support reading either a pair of arrays</span>
<span class="sd">        or a single Nx2 array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_return_list_of_arrays</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">axes</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">axes</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Coordinate arrays are not broadcastable to each other&quot;</span><span class="p">)</span>

            <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">ra_dec_order</span> <span class="ow">and</span> <span class="n">sky</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
                <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_sky</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ra_dec_order</span> <span class="ow">and</span> <span class="n">sky</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_sky</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">output</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                        <span class="n">output</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="k">def</span> <span class="nf">_return_single_array</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;When providing two arguments, the array must be &quot;</span>
                    <span class="s2">&quot;of shape (N, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">))</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">xy</span>
            <span class="k">if</span> <span class="n">ra_dec_order</span> <span class="ow">and</span> <span class="n">sky</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
                <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_sky</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ra_dec_order</span> <span class="ow">and</span> <span class="n">sky</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_sky</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xy</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;When providing two arguments, they must be &quot;</span>
                    <span class="s2">&quot;(coords[N][</span><span class="si">{}</span><span class="s2">], origin)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_return_list_of_arrays</span><span class="p">([</span><span class="n">xy</span><span class="p">],</span> <span class="n">origin</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_return_single_array</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;When providing more than two arguments, they must be &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;a 1-D array for each axis, followed by an origin.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_return_list_of_arrays</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;WCS projection has </span><span class="si">{0}</span><span class="s2"> dimensions, so expected 2 (an Nx</span><span class="si">{0}</span><span class="s2"> array &quot;</span>
            <span class="s2">&quot;and the origin argument) or </span><span class="si">{1}</span><span class="s2"> arguments (the position in each &quot;</span>
            <span class="s2">&quot;dimension, and the origin argument). Instead, </span><span class="si">{2}</span><span class="s2"> arguments were &quot;</span>
            <span class="s2">&quot;given.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

<div class="viewcode-block" id="WCS.all_pix2world"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.all_pix2world">[docs]</a>    <span class="k">def</span> <span class="nf">all_pix2world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_pix2world</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">all_pix2world</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Transforms pixel coordinates to world coordinates.</span>

<span class="s2">        Performs all of the following in series:</span>

<span class="s2">            - Detector to image plane correction (if present in the</span>
<span class="s2">              FITS file)</span>

<span class="s2">            - `SIP`_ distortion correction (if present in the FITS</span>
<span class="s2">              file)</span>

<span class="s2">            - `distortion paper`_ table-lookup correction (if present</span>
<span class="s2">              in the FITS file)</span>

<span class="s2">            - `wcslib`_ &quot;core&quot; WCS transformation</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>
<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">            For a transformation that is not two-dimensional, the</span>
<span class="s2">            two-argument form must be used.</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Notes</span>
<span class="s2">        -----</span>
<span class="s2">        The order of the axes for the result is determined by the</span>
<span class="s2">        ``CTYPEia`` keywords in the FITS header, therefore it may not</span>
<span class="s2">        always be of the form (*ra*, *dec*).  The</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lat`, `~astropy.wcs.Wcsprm.lng`,</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lattyp` and `~astropy.wcs.Wcsprm.lngtyp`</span>
<span class="s2">        members can be used to determine the order of the axes.</span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        SingularMatrixError</span>
<span class="s2">            Linear transformation matrix is singular.</span>

<span class="s2">        InconsistentAxisTypesError</span>
<span class="s2">            Inconsistent or unrecognized coordinate axis types.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid parameter value.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        ValueError</span>
<span class="s2">            x- and y-coordinate arrays are not the same size.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Ill-conditioned coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;naxis&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RA_DEC_ORDER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;sky coordinates, in degrees&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.wcs_pix2world"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.wcs_pix2world">[docs]</a>    <span class="k">def</span> <span class="nf">wcs_pix2world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No basic WCS settings were created.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">xy</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">p2s</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">o</span><span class="p">)[</span><span class="s1">&#39;world&#39;</span><span class="p">],</span>
            <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">wcs_pix2world</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Transforms pixel coordinates to world coordinates by doing</span>
<span class="s2">        only the basic `wcslib`_ transformation.</span>

<span class="s2">        No `SIP`_ or `distortion paper`_ table lookup correction is</span>
<span class="s2">        applied.  To perform distortion correction, see</span>
<span class="s2">        `~astropy.wcs.WCS.all_pix2world`,</span>
<span class="s2">        `~astropy.wcs.WCS.sip_pix2foc`, `~astropy.wcs.WCS.p4_pix2foc`,</span>
<span class="s2">        or `~astropy.wcs.WCS.pix2foc`.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>
<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">            For a transformation that is not two-dimensional, the</span>
<span class="s2">            two-argument form must be used.</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        SingularMatrixError</span>
<span class="s2">            Linear transformation matrix is singular.</span>

<span class="s2">        InconsistentAxisTypesError</span>
<span class="s2">            Inconsistent or unrecognized coordinate axis types.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid parameter value.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        ValueError</span>
<span class="s2">            x- and y-coordinate arrays are not the same size.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Ill-conditioned coordinate transformation parameters.</span>

<span class="s2">        Notes</span>
<span class="s2">        -----</span>
<span class="s2">        The order of the axes for the result is determined by the</span>
<span class="s2">        ``CTYPEia`` keywords in the FITS header, therefore it may not</span>
<span class="s2">        always be of the form (*ra*, *dec*).  The</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lat`, `~astropy.wcs.Wcsprm.lng`,</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lattyp` and `~astropy.wcs.Wcsprm.lngtyp`</span>
<span class="s2">        members can be used to determine the order of the axes.</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;naxis&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RA_DEC_ORDER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;world coordinates, in degrees&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_all_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">,</span>
                       <span class="n">detect_divergence</span><span class="p">,</span> <span class="n">quiet</span><span class="p">):</span>
        <span class="c1"># ############################################################</span>
        <span class="c1"># #          DESCRIPTION OF THE NUMERICAL METHOD            ##</span>
        <span class="c1"># ############################################################</span>
        <span class="c1"># In this section I will outline the method of solving</span>
        <span class="c1"># the inverse problem of converting world coordinates to</span>
        <span class="c1"># pixel coordinates (*inverse* of the direct transformation</span>
        <span class="c1"># `all_pix2world`) and I will summarize some of the aspects</span>
        <span class="c1"># of the method proposed here and some of the issues of the</span>
        <span class="c1"># original `all_world2pix` (in relation to this method)</span>
        <span class="c1"># discussed in https://github.com/astropy/astropy/issues/1977</span>
        <span class="c1"># A more detailed discussion can be found here:</span>
        <span class="c1"># https://github.com/astropy/astropy/pull/2373</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                  ### Background ###</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># I will refer here to the [SIP Paper]</span>
        <span class="c1"># (http://fits.gsfc.nasa.gov/registry/sip/SIP_distortion_v1_0.pdf).</span>
        <span class="c1"># According to this paper, the effect of distortions as</span>
        <span class="c1"># described in *their* equation (1) is:</span>
        <span class="c1">#</span>
        <span class="c1"># (1)   x = CD*(u+f(u)),</span>
        <span class="c1">#</span>
        <span class="c1"># where `x` is a *vector* of &quot;intermediate spherical</span>
        <span class="c1"># coordinates&quot; (equivalent to (x,y) in the paper) and `u`</span>
        <span class="c1"># is a *vector* of &quot;pixel coordinates&quot;, and `f` is a vector</span>
        <span class="c1"># function describing geometrical distortions</span>
        <span class="c1"># (see equations 2 and 3 in SIP Paper.</span>
        <span class="c1"># However, I prefer to use `w` for &quot;intermediate world</span>
        <span class="c1"># coordinates&quot;, `x` for pixel coordinates, and assume that</span>
        <span class="c1"># transformation `W` performs the **linear**</span>
        <span class="c1"># (CD matrix + projection onto celestial sphere) part of the</span>
        <span class="c1"># conversion from pixel coordinates to world coordinates.</span>
        <span class="c1"># Then we can re-write (1) as:</span>
        <span class="c1">#</span>
        <span class="c1"># (2)   w = W*(x+f(x)) = T(x)</span>
        <span class="c1">#</span>
        <span class="c1"># In `astropy.wcs.WCS` transformation `W` is represented by</span>
        <span class="c1"># the `wcs_pix2world` member, while the combined (&quot;total&quot;)</span>
        <span class="c1"># transformation (linear part + distortions) is performed by</span>
        <span class="c1"># `all_pix2world`. Below I summarize the notations and their</span>
        <span class="c1"># equivalents in `astropy.wcs.WCS`:</span>
        <span class="c1">#</span>
        <span class="c1"># | Equation term | astropy.WCS/meaning          |</span>
        <span class="c1"># | ------------- | ---------------------------- |</span>
        <span class="c1"># | `x`           | pixel coordinates            |</span>
        <span class="c1"># | `w`           | world coordinates            |</span>
        <span class="c1"># | `W`           | `wcs_pix2world()`            |</span>
        <span class="c1"># | `W^{-1}`      | `wcs_world2pix()`            |</span>
        <span class="c1"># | `T`           | `all_pix2world()`            |</span>
        <span class="c1"># | `x+f(x)`      | `pix2foc()`                  |</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#      ### Direct Solving of Equation (2)  ###</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># In order to find the pixel coordinates that correspond to</span>
        <span class="c1"># given world coordinates `w`, it is necessary to invert</span>
        <span class="c1"># equation (2): `x=T^{-1}(w)`, or solve equation `w==T(x)`</span>
        <span class="c1"># for `x`. However, this approach has the following</span>
        <span class="c1"># disadvantages:</span>
        <span class="c1">#    1. It requires unnecessary transformations (see next</span>
        <span class="c1">#       section).</span>
        <span class="c1">#    2. It is prone to &quot;RA wrapping&quot; issues as described in</span>
        <span class="c1"># https://github.com/astropy/astropy/issues/1977</span>
        <span class="c1"># (essentially because `all_pix2world` may return points with</span>
        <span class="c1"># a different phase than user&#39;s input `w`).</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#      ### Description of the Method Used here ###</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># By applying inverse linear WCS transformation (`W^{-1}`)</span>
        <span class="c1"># to both sides of equation (2) and introducing notation `x&#39;`</span>
        <span class="c1"># (prime) for the pixels coordinates obtained from the world</span>
        <span class="c1"># coordinates by applying inverse *linear* WCS transformation</span>
        <span class="c1"># (&quot;focal plane coordinates&quot;):</span>
        <span class="c1">#</span>
        <span class="c1"># (3)   x&#39; = W^{-1}(w)</span>
        <span class="c1">#</span>
        <span class="c1"># we obtain the following equation:</span>
        <span class="c1">#</span>
        <span class="c1"># (4)   x&#39; = x+f(x),</span>
        <span class="c1">#</span>
        <span class="c1"># or,</span>
        <span class="c1">#</span>
        <span class="c1"># (5)   x = x&#39;-f(x)</span>
        <span class="c1">#</span>
        <span class="c1"># This equation is well suited for solving using the method</span>
        <span class="c1"># of fixed-point iterations</span>
        <span class="c1"># (http://en.wikipedia.org/wiki/Fixed-point_iteration):</span>
        <span class="c1">#</span>
        <span class="c1"># (6)   x_{i+1} = x&#39;-f(x_i)</span>
        <span class="c1">#</span>
        <span class="c1"># As an initial value of the pixel coordinate `x_0` we take</span>
        <span class="c1"># &quot;focal plane coordinate&quot; `x&#39;=W^{-1}(w)=wcs_world2pix(w)`.</span>
        <span class="c1"># We stop iterations when `|x_{i+1}-x_i|&lt;tolerance`. We also</span>
        <span class="c1"># consider the process to be diverging if</span>
        <span class="c1"># `|x_{i+1}-x_i|&gt;|x_i-x_{i-1}|`</span>
        <span class="c1"># **when** `|x_{i+1}-x_i|&gt;=tolerance` (when current</span>
        <span class="c1"># approximation is close to the true solution,</span>
        <span class="c1"># `|x_{i+1}-x_i|&gt;|x_i-x_{i-1}|` may be due to rounding errors</span>
        <span class="c1"># and we ignore such &quot;divergences&quot; when</span>
        <span class="c1"># `|x_{i+1}-x_i|&lt;tolerance`). It may appear that checking for</span>
        <span class="c1"># `|x_{i+1}-x_i|&lt;tolerance` in order to ignore divergence is</span>
        <span class="c1"># unnecessary since the iterative process should stop anyway,</span>
        <span class="c1"># however, the proposed implementation of this iterative</span>
        <span class="c1"># process is completely vectorized and, therefore, we may</span>
        <span class="c1"># continue iterating over *some* points even though they have</span>
        <span class="c1"># converged to within a specified tolerance (while iterating</span>
        <span class="c1"># over other points that have not yet converged to</span>
        <span class="c1"># a solution).</span>
        <span class="c1">#</span>
        <span class="c1"># In order to efficiently implement iterative process (6)</span>
        <span class="c1"># using available methods in `astropy.wcs.WCS`, we add and</span>
        <span class="c1"># subtract `x_i` from the right side of equation (6):</span>
        <span class="c1">#</span>
        <span class="c1"># (7)   x_{i+1} = x&#39;-(x_i+f(x_i))+x_i = x&#39;-pix2foc(x_i)+x_i,</span>
        <span class="c1">#</span>
        <span class="c1"># where `x&#39;=wcs_world2pix(w)` and it is computed only *once*</span>
        <span class="c1"># before the beginning of the iterative process (and we also</span>
        <span class="c1"># set `x_0=x&#39;`). By using `pix2foc` at each iteration instead</span>
        <span class="c1"># of `all_pix2world` we get about 25% increase in performance</span>
        <span class="c1"># (by not performing the linear `W` transformation at each</span>
        <span class="c1"># step) and we also avoid the &quot;RA wrapping&quot; issue described</span>
        <span class="c1"># above (by working in focal plane coordinates and avoiding</span>
        <span class="c1"># pix-&gt;world transformations).</span>
        <span class="c1">#</span>
        <span class="c1"># As an added benefit, the process converges to the correct</span>
        <span class="c1"># solution in just one iteration when distortions are not</span>
        <span class="c1"># present (compare to</span>
        <span class="c1"># https://github.com/astropy/astropy/issues/1977 and</span>
        <span class="c1"># https://github.com/astropy/astropy/pull/2294): in this case</span>
        <span class="c1"># `pix2foc` is the identical transformation</span>
        <span class="c1"># `x_i=pix2foc(x_i)` and from equation (7) we get:</span>
        <span class="c1">#</span>
        <span class="c1"># x&#39; = x_0 = wcs_world2pix(w)</span>
        <span class="c1"># x_1 = x&#39; - pix2foc(x_0) + x_0 = x&#39; - pix2foc(x&#39;) + x&#39; = x&#39;</span>
        <span class="c1">#     = wcs_world2pix(w) = x_0</span>
        <span class="c1"># =&gt;</span>
        <span class="c1"># |x_1-x_0| = 0 &lt; tolerance (with tolerance &gt; 0)</span>
        <span class="c1">#</span>
        <span class="c1"># However, for performance reasons, it is still better to</span>
        <span class="c1"># avoid iterations altogether and return the exact linear</span>
        <span class="c1"># solution (`wcs_world2pix`) right-away when non-linear</span>
        <span class="c1"># distortions are not present by checking that attributes</span>
        <span class="c1"># `sip`, `cpdis1`, `cpdis2`, `det2im1`, and `det2im2` are</span>
        <span class="c1"># *all* `None`.</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#         ### Outline of the Algorithm ###</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># While the proposed code is relatively long (considering</span>
        <span class="c1"># the simplicity of the algorithm), this is due to: 1)</span>
        <span class="c1"># checking if iterative solution is necessary at all; 2)</span>
        <span class="c1"># checking for divergence; 3) re-implementation of the</span>
        <span class="c1"># completely vectorized algorithm as an &quot;adaptive&quot; vectorized</span>
        <span class="c1"># algorithm (for cases when some points diverge for which we</span>
        <span class="c1"># want to stop iterations). In my tests, the adaptive version</span>
        <span class="c1"># of the algorithm is about 50% slower than non-adaptive</span>
        <span class="c1"># version for all HST images.</span>
        <span class="c1">#</span>
        <span class="c1"># The essential part of the vectorized non-adaptive algorithm</span>
        <span class="c1"># (without divergence and other checks) can be described</span>
        <span class="c1"># as follows:</span>
        <span class="c1">#</span>
        <span class="c1">#     pix0 = self.wcs_world2pix(world, origin)</span>
        <span class="c1">#     pix  = pix0.copy() # 0-order solution</span>
        <span class="c1">#</span>
        <span class="c1">#     for k in range(maxiter):</span>
        <span class="c1">#         # find correction to the previous solution:</span>
        <span class="c1">#         dpix = self.pix2foc(pix, origin) - pix0</span>
        <span class="c1">#</span>
        <span class="c1">#         # compute norm (L2) of the correction:</span>
        <span class="c1">#         dn = np.linalg.norm(dpix, axis=1)</span>
        <span class="c1">#</span>
        <span class="c1">#         # apply correction:</span>
        <span class="c1">#         pix -= dpix</span>
        <span class="c1">#</span>
        <span class="c1">#         # check convergence:</span>
        <span class="c1">#         if np.max(dn) &lt; tolerance:</span>
        <span class="c1">#             break</span>
        <span class="c1">#</span>
        <span class="c1">#    return pix</span>
        <span class="c1">#</span>
        <span class="c1"># Here, the input parameter `world` can be a `MxN` array</span>
        <span class="c1"># where `M` is the number of coordinate axes in WCS and `N`</span>
        <span class="c1"># is the number of points to be converted simultaneously to</span>
        <span class="c1"># image coordinates.</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#                ###  IMPORTANT NOTE:  ###</span>
        <span class="c1">#</span>
        <span class="c1"># If, in the future releases of the `~astropy.wcs`,</span>
        <span class="c1"># `pix2foc` will not apply all the required distortion</span>
        <span class="c1"># corrections then in the code below, calls to `pix2foc` will</span>
        <span class="c1"># have to be replaced with</span>
        <span class="c1"># wcs_world2pix(all_pix2world(pix_list, origin), origin)</span>
        <span class="c1">#</span>

        <span class="c1"># ############################################################</span>
        <span class="c1"># #            INITIALIZE ITERATIVE PROCESS:                ##</span>
        <span class="c1"># ############################################################</span>

        <span class="c1"># initial approximation (linear WCS based only)</span>
        <span class="n">pix0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>

        <span class="c1"># Check that an iterative solution is required at all</span>
        <span class="c1"># (when any of the non-CD-matrix-based corrections are</span>
        <span class="c1"># present). If not required return the initial</span>
        <span class="c1"># approximation (pix0).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_distortion</span><span class="p">:</span>
            <span class="c1"># No non-WCS corrections detected so</span>
            <span class="c1"># simply return initial approximation:</span>
            <span class="k">return</span> <span class="n">pix0</span>

        <span class="n">pix</span> <span class="o">=</span> <span class="n">pix0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 0-order solution</span>

        <span class="c1"># initial correction:</span>
        <span class="n">dpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2foc</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="o">-</span> <span class="n">pix0</span>

        <span class="c1"># Update initial solution:</span>
        <span class="n">pix</span> <span class="o">-=</span> <span class="n">dpix</span>

        <span class="c1"># Norm (L2) squared of the correction:</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dpix</span><span class="o">*</span><span class="n">dpix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dnprev</span> <span class="o">=</span> <span class="n">dn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># if adaptive else dn</span>
        <span class="n">tol2</span> <span class="o">=</span> <span class="n">tolerance</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Prepare for iterative process</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inddiv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Turn off numpy runtime warnings for &#39;invalid&#39; and &#39;over&#39;:</span>
        <span class="n">old_invalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geterr</span><span class="p">()[</span><span class="s1">&#39;invalid&#39;</span><span class="p">]</span>
        <span class="n">old_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geterr</span><span class="p">()[</span><span class="s1">&#39;over&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="c1"># ############################################################</span>
        <span class="c1"># #                NON-ADAPTIVE ITERATIONS:                 ##</span>
        <span class="c1"># ############################################################</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">adaptive</span><span class="p">:</span>
            <span class="c1"># Fixed-point iterations:</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">tol2</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">maxiter</span><span class="p">):</span>
                <span class="c1"># Find correction to the previous solution:</span>
                <span class="n">dpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2foc</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="o">-</span> <span class="n">pix0</span>

                <span class="c1"># Compute norm (L2) squared of the correction:</span>
                <span class="n">dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dpix</span><span class="o">*</span><span class="n">dpix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Check for divergence (we do this in two stages</span>
                <span class="c1"># to optimize performance for the most common</span>
                <span class="c1"># scenario when successive approximations converge):</span>
                <span class="k">if</span> <span class="n">detect_divergence</span><span class="p">:</span>
                    <span class="n">divergent</span> <span class="o">=</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&gt;=</span> <span class="n">dnprev</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">divergent</span><span class="p">):</span>
                        <span class="c1"># Find solutions that have not yet converged:</span>
                        <span class="n">slowconv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&gt;=</span> <span class="n">tol2</span><span class="p">)</span>
                        <span class="n">inddiv</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">divergent</span> <span class="o">&amp;</span> <span class="n">slowconv</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">inddiv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Update indices of elements that</span>
                            <span class="c1"># still need correction:</span>
                            <span class="n">conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&lt;</span> <span class="n">dnprev</span><span class="p">)</span>
                            <span class="n">iconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>

                            <span class="c1"># Apply correction:</span>
                            <span class="n">dpixgood</span> <span class="o">=</span> <span class="n">dpix</span><span class="p">[</span><span class="n">iconv</span><span class="p">]</span>
                            <span class="n">pix</span><span class="p">[</span><span class="n">iconv</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dpixgood</span>
                            <span class="n">dpix</span><span class="p">[</span><span class="n">iconv</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpixgood</span>

                            <span class="c1"># For the next iteration choose</span>
                            <span class="c1"># non-divergent points that have not yet</span>
                            <span class="c1"># converged to the requested accuracy:</span>
                            <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">slowconv</span> <span class="o">&amp;</span> <span class="n">conv</span><span class="p">)</span>
                            <span class="n">pix0</span> <span class="o">=</span> <span class="n">pix0</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                            <span class="n">dnprev</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="c1"># Switch to adaptive iterations:</span>
                            <span class="n">adaptive</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="c1"># Save current correction magnitudes for later:</span>
                    <span class="n">dnprev</span> <span class="o">=</span> <span class="n">dn</span>

                <span class="c1"># Apply correction:</span>
                <span class="n">pix</span> <span class="o">-=</span> <span class="n">dpix</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># ############################################################</span>
        <span class="c1"># #                  ADAPTIVE ITERATIONS:                   ##</span>
        <span class="c1"># ############################################################</span>
        <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pix</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">pix0</span> <span class="o">=</span> <span class="n">pix0</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

            <span class="c1"># &quot;Adaptive&quot; fixed-point iterations:</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">maxiter</span><span class="p">):</span>
                <span class="c1"># Find correction to the previous solution:</span>
                <span class="n">dpixnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2foc</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">origin</span><span class="p">)</span> <span class="o">-</span> <span class="n">pix0</span>

                <span class="c1"># Compute norm (L2) of the correction:</span>
                <span class="n">dnnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dpixnew</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Bookkeeping of corrections:</span>
                <span class="n">dnprev</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnnew</span>

                <span class="k">if</span> <span class="n">detect_divergence</span><span class="p">:</span>
                    <span class="c1"># Find indices of pixels that are converging:</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dnnew</span> <span class="o">&lt;</span> <span class="n">dnprev</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                    <span class="n">iconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
                    <span class="n">iiconv</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">iconv</span><span class="p">]</span>

                    <span class="c1"># Apply correction:</span>
                    <span class="n">dpixgood</span> <span class="o">=</span> <span class="n">dpixnew</span><span class="p">[</span><span class="n">iconv</span><span class="p">]</span>
                    <span class="n">pix</span><span class="p">[</span><span class="n">iiconv</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dpixgood</span>
                    <span class="n">dpix</span><span class="p">[</span><span class="n">iiconv</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpixgood</span>

                    <span class="c1"># Find indices of solutions that have not yet</span>
                    <span class="c1"># converged to the requested accuracy</span>
                    <span class="c1"># AND that do not diverge:</span>
                    <span class="n">subind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dnnew</span> <span class="o">&gt;=</span> <span class="n">tol2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">conv</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Apply correction:</span>
                    <span class="n">pix</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dpixnew</span>
                    <span class="n">dpix</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpixnew</span>

                    <span class="c1"># Find indices of solutions that have not yet</span>
                    <span class="c1"># converged to the requested accuracy:</span>
                    <span class="n">subind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dnnew</span> <span class="o">&gt;=</span> <span class="n">tol2</span><span class="p">)</span>

                <span class="c1"># Choose solutions that need more iterations:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">subind</span><span class="p">]</span>
                <span class="n">pix0</span> <span class="o">=</span> <span class="n">pix0</span><span class="p">[</span><span class="n">subind</span><span class="p">]</span>

                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># ############################################################</span>
        <span class="c1"># #         FINAL DETECTION OF INVALID, DIVERGING,          ##</span>
        <span class="c1"># #         AND FAILED-TO-CONVERGE POINTS                   ##</span>
        <span class="c1"># ############################################################</span>
        <span class="c1"># Identify diverging and/or invalid points:</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="p">((</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">world</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># When detect_divergence==False, dnprev is outdated</span>
        <span class="c1"># (it is the norm of the very first correction).</span>
        <span class="c1"># Still better than nothing...</span>
        <span class="n">inddiv</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">dn</span> <span class="o">&gt;=</span> <span class="n">tol2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&gt;=</span> <span class="n">dnprev</span><span class="p">))</span> <span class="o">|</span> <span class="n">invalid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inddiv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">inddiv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Identify points that did not converge within &#39;maxiter&#39;</span>
        <span class="c1"># iterations:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dn</span> <span class="o">&gt;=</span> <span class="n">tol2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&lt;</span> <span class="n">dnprev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">invalid</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Restore previous numpy error settings:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="n">old_invalid</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="n">old_over</span><span class="p">)</span>

        <span class="c1"># ############################################################</span>
        <span class="c1"># #  RAISE EXCEPTION IF DIVERGING OR TOO SLOWLY CONVERGING  ##</span>
        <span class="c1"># #  DATA POINTS HAVE BEEN DETECTED:                        ##</span>
        <span class="c1"># ############################################################</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">inddiv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inddiv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoConvergence</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;WCS.all_world2pix&#39; failed to &quot;</span>
                    <span class="s2">&quot;converge to the requested accuracy after </span><span class="si">{:d}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;iterations.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">best_solution</span><span class="o">=</span><span class="n">pix</span><span class="p">,</span>
                    <span class="n">accuracy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dpix</span><span class="p">),</span> <span class="n">niter</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                    <span class="n">slow_conv</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">divergent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoConvergence</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;WCS.all_world2pix&#39; failed to &quot;</span>
                    <span class="s2">&quot;converge to the requested accuracy.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;After </span><span class="si">{:d}</span><span class="s2"> iterations, the solution is diverging &quot;</span>
                    <span class="s2">&quot;at least for one input point.&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">best_solution</span><span class="o">=</span><span class="n">pix</span><span class="p">,</span>
                    <span class="n">accuracy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dpix</span><span class="p">),</span> <span class="n">niter</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                    <span class="n">slow_conv</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">divergent</span><span class="o">=</span><span class="n">inddiv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pix</span>

<div class="viewcode-block" id="WCS.all_world2pix"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.all_world2pix">[docs]</a>    <span class="nd">@deprecated_renamed_argument</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;tolerance&#39;</span><span class="p">,</span> <span class="s1">&#39;4.3&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">all_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">adaptive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">detect_divergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No basic WCS settings were created.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_world2pix</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                <span class="n">adaptive</span><span class="o">=</span><span class="n">adaptive</span><span class="p">,</span> <span class="n">detect_divergence</span><span class="o">=</span><span class="n">detect_divergence</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">),</span>
            <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

    <span class="n">all_world2pix</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        all_world2pix(*arg, tolerance=1.0e-4, maxiter=20,</span>
<span class="s2">        adaptive=False, detect_divergence=True, quiet=False)</span>

<span class="s2">        Transforms world coordinates to pixel coordinates, using</span>
<span class="s2">        numerical iteration to invert the full forward transformation</span>
<span class="s2">        `~astropy.wcs.WCS.all_pix2world` with complete</span>
<span class="s2">        distortion model.</span>


<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>
<span class="s2">        </span><span class="si">{0}</span><span class="s2"></span>

<span class="s2">            For a transformation that is not two-dimensional, the</span>
<span class="s2">            two-argument form must be used.</span>

<span class="s2">        </span><span class="si">{1}</span><span class="s2"></span>

<span class="s2">        tolerance : float, optional (default = 1.0e-4)</span>
<span class="s2">            Tolerance of solution. Iteration terminates when the</span>
<span class="s2">            iterative solver estimates that the &quot;true solution&quot; is</span>
<span class="s2">            within this many pixels current estimate, more</span>
<span class="s2">            specifically, when the correction to the solution found</span>
<span class="s2">            during the previous iteration is smaller</span>
<span class="s2">            (in the sense of the L2 norm) than ``tolerance``.</span>

<span class="s2">        maxiter : int, optional (default = 20)</span>
<span class="s2">            Maximum number of iterations allowed to reach a solution.</span>

<span class="s2">        quiet : bool, optional (default = False)</span>
<span class="s2">            Do not throw :py:class:`NoConvergence` exceptions when</span>
<span class="s2">            the method does not converge to a solution with the</span>
<span class="s2">            required accuracy within a specified number of maximum</span>
<span class="s2">            iterations set by ``maxiter`` parameter. Instead,</span>
<span class="s2">            simply return the found solution.</span>

<span class="s2">        Other Parameters</span>
<span class="s2">        ----------------</span>
<span class="s2">        adaptive : bool, optional (default = False)</span>
<span class="s2">            Specifies whether to adaptively select only points that</span>
<span class="s2">            did not converge to a solution within the required</span>
<span class="s2">            accuracy for the next iteration. Default is recommended</span>
<span class="s2">            for HST as well as most other instruments.</span>

<span class="s2">            .. note::</span>
<span class="s2">               The :py:meth:`all_world2pix` uses a vectorized</span>
<span class="s2">               implementation of the method of consecutive</span>
<span class="s2">               approximations (see ``Notes`` section below) in which it</span>
<span class="s2">               iterates over *all* input points *regardless* until</span>
<span class="s2">               the required accuracy has been reached for *all* input</span>
<span class="s2">               points. In some cases it may be possible that</span>
<span class="s2">               *almost all* points have reached the required accuracy</span>
<span class="s2">               but there are only a few of input data points for</span>
<span class="s2">               which additional iterations may be needed (this</span>
<span class="s2">               depends mostly on the characteristics of the geometric</span>
<span class="s2">               distortions for a given instrument). In this situation</span>
<span class="s2">               it may be advantageous to set ``adaptive`` = `True` in</span>
<span class="s2">               which case :py:meth:`all_world2pix` will continue</span>
<span class="s2">               iterating *only* over the points that have not yet</span>
<span class="s2">               converged to the required accuracy. However, for the</span>
<span class="s2">               HST&#39;s ACS/WFC detector, which has the strongest</span>
<span class="s2">               distortions of all HST instruments, testing has</span>
<span class="s2">               shown that enabling this option would lead to a about</span>
<span class="s2">               50-100% penalty in computational time (depending on</span>
<span class="s2">               specifics of the image, geometric distortions, and</span>
<span class="s2">               number of input points to be converted). Therefore,</span>
<span class="s2">               for HST and possibly instruments, it is recommended</span>
<span class="s2">               to set ``adaptive`` = `False`. The only danger in</span>
<span class="s2">               getting this setting wrong will be a performance</span>
<span class="s2">               penalty.</span>

<span class="s2">            .. note::</span>
<span class="s2">               When ``detect_divergence`` is `True`,</span>
<span class="s2">               :py:meth:`all_world2pix` will automatically switch</span>
<span class="s2">               to the adaptive algorithm once divergence has been</span>
<span class="s2">               detected.</span>

<span class="s2">        detect_divergence : bool, optional (default = True)</span>
<span class="s2">            Specifies whether to perform a more detailed analysis</span>
<span class="s2">            of the convergence to a solution. Normally</span>
<span class="s2">            :py:meth:`all_world2pix` may not achieve the required</span>
<span class="s2">            accuracy if either the ``tolerance`` or ``maxiter`` arguments</span>
<span class="s2">            are too low. However, it may happen that for some</span>
<span class="s2">            geometric distortions the conditions of convergence for</span>
<span class="s2">            the the method of consecutive approximations used by</span>
<span class="s2">            :py:meth:`all_world2pix` may not be satisfied, in which</span>
<span class="s2">            case consecutive approximations to the solution will</span>
<span class="s2">            diverge regardless of the ``tolerance`` or ``maxiter``</span>
<span class="s2">            settings.</span>

<span class="s2">            When ``detect_divergence`` is `False`, these divergent</span>
<span class="s2">            points will be detected as not having achieved the</span>
<span class="s2">            required accuracy (without further details). In addition,</span>
<span class="s2">            if ``adaptive`` is `False` then the algorithm will not</span>
<span class="s2">            know that the solution (for specific points) is diverging</span>
<span class="s2">            and will continue iterating and trying to &quot;improve&quot;</span>
<span class="s2">            diverging solutions. This may result in ``NaN`` or</span>
<span class="s2">            ``Inf`` values in the return results (in addition to a</span>
<span class="s2">            performance penalties). Even when ``detect_divergence``</span>
<span class="s2">            is `False`, :py:meth:`all_world2pix`, at the end of the</span>
<span class="s2">            iterative process, will identify invalid results</span>
<span class="s2">            (``NaN`` or ``Inf``) as &quot;diverging&quot; solutions and will</span>
<span class="s2">            raise :py:class:`NoConvergence` unless the ``quiet``</span>
<span class="s2">            parameter is set to `True`.</span>

<span class="s2">            When ``detect_divergence`` is `True`,</span>
<span class="s2">            :py:meth:`all_world2pix` will detect points for which</span>
<span class="s2">            current correction to the coordinates is larger than</span>
<span class="s2">            the correction applied during the previous iteration</span>
<span class="s2">            **if** the requested accuracy **has not yet been</span>
<span class="s2">            achieved**. In this case, if ``adaptive`` is `True`,</span>
<span class="s2">            these points will be excluded from further iterations and</span>
<span class="s2">            if ``adaptive`` is `False`, :py:meth:`all_world2pix` will</span>
<span class="s2">            automatically switch to the adaptive algorithm. Thus, the</span>
<span class="s2">            reported divergent solution will be the latest converging</span>
<span class="s2">            solution computed immediately *before* divergence</span>
<span class="s2">            has been detected.</span>

<span class="s2">            .. note::</span>
<span class="s2">               When accuracy has been achieved, small increases in</span>
<span class="s2">               current corrections may be possible due to rounding</span>
<span class="s2">               errors (when ``adaptive`` is `False`) and such</span>
<span class="s2">               increases will be ignored.</span>

<span class="s2">            .. note::</span>
<span class="s2">               Based on our testing using HST ACS/WFC images, setting</span>
<span class="s2">               ``detect_divergence`` to `True` will incur about 5-20%</span>
<span class="s2">               performance penalty with the larger penalty</span>
<span class="s2">               corresponding to ``adaptive`` set to `True`.</span>
<span class="s2">               Because the benefits of enabling this</span>
<span class="s2">               feature outweigh the small performance penalty,</span>
<span class="s2">               especially when ``adaptive`` = `False`, it is</span>
<span class="s2">               recommended to set ``detect_divergence`` to `True`,</span>
<span class="s2">               unless extensive testing of the distortion models for</span>
<span class="s2">               images from specific instruments show a good stability</span>
<span class="s2">               of the numerical method for a wide range of</span>
<span class="s2">               coordinates (even outside the image itself).</span>

<span class="s2">            .. note::</span>
<span class="s2">               Indices of the diverging inverse solutions will be</span>
<span class="s2">               reported in the ``divergent`` attribute of the</span>
<span class="s2">               raised :py:class:`NoConvergence` exception object.</span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{2}</span><span class="s2"></span>

<span class="s2">        Notes</span>
<span class="s2">        -----</span>
<span class="s2">        The order of the axes for the input world array is determined by</span>
<span class="s2">        the ``CTYPEia`` keywords in the FITS header, therefore it may</span>
<span class="s2">        not always be of the form (*ra*, *dec*).  The</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lat`, `~astropy.wcs.Wcsprm.lng`,</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lattyp`, and</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lngtyp`</span>
<span class="s2">        members can be used to determine the order of the axes.</span>

<span class="s2">        Using the method of fixed-point iterations approximations we</span>
<span class="s2">        iterate starting with the initial approximation, which is</span>
<span class="s2">        computed using the non-distortion-aware</span>
<span class="s2">        :py:meth:`wcs_world2pix` (or equivalent).</span>

<span class="s2">        The :py:meth:`all_world2pix` function uses a vectorized</span>
<span class="s2">        implementation of the method of consecutive approximations and</span>
<span class="s2">        therefore it is highly efficient (&gt;30x) when *all* data points</span>
<span class="s2">        that need to be converted from sky coordinates to image</span>
<span class="s2">        coordinates are passed at *once*. Therefore, it is advisable,</span>
<span class="s2">        whenever possible, to pass as input a long array of all points</span>
<span class="s2">        that need to be converted to :py:meth:`all_world2pix` instead</span>
<span class="s2">        of calling :py:meth:`all_world2pix` for each data point. Also</span>
<span class="s2">        see the note to the ``adaptive`` parameter.</span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        NoConvergence</span>
<span class="s2">            The method did not converge to a</span>
<span class="s2">            solution to the required accuracy within a specified</span>
<span class="s2">            number of maximum iterations set by the ``maxiter``</span>
<span class="s2">            parameter. To turn off this exception, set ``quiet`` to</span>
<span class="s2">            `True`. Indices of the points for which the requested</span>
<span class="s2">            accuracy was not achieved (if any) will be listed in the</span>
<span class="s2">            ``slow_conv`` attribute of the</span>
<span class="s2">            raised :py:class:`NoConvergence` exception object.</span>

<span class="s2">            See :py:class:`NoConvergence` documentation for</span>
<span class="s2">            more details.</span>

<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        SingularMatrixError</span>
<span class="s2">            Linear transformation matrix is singular.</span>

<span class="s2">        InconsistentAxisTypesError</span>
<span class="s2">            Inconsistent or unrecognized coordinate axis types.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid parameter value.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        ValueError</span>
<span class="s2">            x- and y-coordinate arrays are not the same size.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Ill-conditioned coordinate transformation parameters.</span>

<span class="s2">        Examples</span>
<span class="s2">        --------</span>
<span class="s2">        &gt;&gt;&gt; import astropy.io.fits as fits</span>
<span class="s2">        &gt;&gt;&gt; import astropy.wcs as wcs</span>
<span class="s2">        &gt;&gt;&gt; import numpy as np</span>
<span class="s2">        &gt;&gt;&gt; import os</span>

<span class="s2">        &gt;&gt;&gt; filename = os.path.join(wcs.__path__[0], &#39;tests/data/j94f05bgq_flt.fits&#39;)</span>
<span class="s2">        &gt;&gt;&gt; hdulist = fits.open(filename)</span>
<span class="s2">        &gt;&gt;&gt; w = wcs.WCS(hdulist[(&#39;sci&#39;,1)].header, hdulist)</span>
<span class="s2">        &gt;&gt;&gt; hdulist.close()</span>

<span class="s2">        &gt;&gt;&gt; ra, dec = w.all_pix2world([1,2,3], [1,1,1], 1)</span>
<span class="s2">        &gt;&gt;&gt; print(ra)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [ 5.52645627  5.52649663  5.52653698]</span>
<span class="s2">        &gt;&gt;&gt; print(dec)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [-72.05171757 -72.05171276 -72.05170795]</span>
<span class="s2">        &gt;&gt;&gt; radec = w.all_pix2world([[1,1], [2,1], [3,1]], 1)</span>
<span class="s2">        &gt;&gt;&gt; print(radec)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [[  5.52645627 -72.05171757]</span>
<span class="s2">         [  5.52649663 -72.05171276]</span>
<span class="s2">         [  5.52653698 -72.05170795]]</span>
<span class="s2">        &gt;&gt;&gt; x, y = w.all_world2pix(ra, dec, 1)</span>
<span class="s2">        &gt;&gt;&gt; print(x)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [ 1.00000238  2.00000237  3.00000236]</span>
<span class="s2">        &gt;&gt;&gt; print(y)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [ 0.99999996  0.99999997  0.99999997]</span>
<span class="s2">        &gt;&gt;&gt; xy = w.all_world2pix(radec, 1)</span>
<span class="s2">        &gt;&gt;&gt; print(xy)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [[ 1.00000238  0.99999996]</span>
<span class="s2">         [ 2.00000237  0.99999997]</span>
<span class="s2">         [ 3.00000236  0.99999997]]</span>
<span class="s2">        &gt;&gt;&gt; xy = w.all_world2pix(radec, 1, maxiter=3,</span>
<span class="s2">        ...                      tolerance=1.0e-10, quiet=False)</span>
<span class="s2">        Traceback (most recent call last):</span>
<span class="s2">        ...</span>
<span class="s2">        NoConvergence: &#39;WCS.all_world2pix&#39; failed to converge to the</span>
<span class="s2">        requested accuracy. After 3 iterations, the solution is</span>
<span class="s2">        diverging at least for one input point.</span>

<span class="s2">        &gt;&gt;&gt; # Now try to use some diverging data:</span>
<span class="s2">        &gt;&gt;&gt; divradec = w.all_pix2world([[1.0, 1.0],</span>
<span class="s2">        ...                             [10000.0, 50000.0],</span>
<span class="s2">        ...                             [3.0, 1.0]], 1)</span>
<span class="s2">        &gt;&gt;&gt; print(divradec)  # doctest: +FLOAT_CMP</span>
<span class="s2">        [[  5.52645627 -72.05171757]</span>
<span class="s2">         [  7.15976932 -70.8140779 ]</span>
<span class="s2">         [  5.52653698 -72.05170795]]</span>

<span class="s2">        &gt;&gt;&gt; # First, turn detect_divergence on:</span>
<span class="s2">        &gt;&gt;&gt; try:  # doctest: +FLOAT_CMP</span>
<span class="s2">        ...   xy = w.all_world2pix(divradec, 1, maxiter=20,</span>
<span class="s2">        ...                        tolerance=1.0e-4, adaptive=False,</span>
<span class="s2">        ...                        detect_divergence=True,</span>
<span class="s2">        ...                        quiet=False)</span>
<span class="s2">        ... except wcs.wcs.NoConvergence as e:</span>
<span class="s2">        ...   print(&quot;Indices of diverging points: {{0}}&quot;</span>
<span class="s2">        ...         .format(e.divergent))</span>
<span class="s2">        ...   print(&quot;Indices of poorly converging points: {{0}}&quot;</span>
<span class="s2">        ...         .format(e.slow_conv))</span>
<span class="s2">        ...   print(&quot;Best solution:</span><span class="se">\\</span><span class="s2">n{{0}}&quot;.format(e.best_solution))</span>
<span class="s2">        ...   print(&quot;Achieved accuracy:</span><span class="se">\\</span><span class="s2">n{{0}}&quot;.format(e.accuracy))</span>
<span class="s2">        Indices of diverging points: [1]</span>
<span class="s2">        Indices of poorly converging points: None</span>
<span class="s2">        Best solution:</span>
<span class="s2">        [[  1.00000238e+00   9.99999965e-01]</span>
<span class="s2">         [ -1.99441636e+06   1.44309097e+06]</span>
<span class="s2">         [  3.00000236e+00   9.99999966e-01]]</span>
<span class="s2">        Achieved accuracy:</span>
<span class="s2">        [[  6.13968380e-05   8.59638593e-07]</span>
<span class="s2">         [  8.59526812e+11   6.61713548e+11]</span>
<span class="s2">         [  6.09398446e-05   8.38759724e-07]]</span>
<span class="s2">        &gt;&gt;&gt; raise e</span>
<span class="s2">        Traceback (most recent call last):</span>
<span class="s2">        ...</span>
<span class="s2">        NoConvergence: &#39;WCS.all_world2pix&#39; failed to converge to the</span>
<span class="s2">        requested accuracy.  After 5 iterations, the solution is</span>
<span class="s2">        diverging at least for one input point.</span>

<span class="s2">        &gt;&gt;&gt; # This time turn detect_divergence off:</span>
<span class="s2">        &gt;&gt;&gt; try:  # doctest: +FLOAT_CMP</span>
<span class="s2">        ...   xy = w.all_world2pix(divradec, 1, maxiter=20,</span>
<span class="s2">        ...                        tolerance=1.0e-4, adaptive=False,</span>
<span class="s2">        ...                        detect_divergence=False,</span>
<span class="s2">        ...                        quiet=False)</span>
<span class="s2">        ... except wcs.wcs.NoConvergence as e:</span>
<span class="s2">        ...   print(&quot;Indices of diverging points: {{0}}&quot;</span>
<span class="s2">        ...         .format(e.divergent))</span>
<span class="s2">        ...   print(&quot;Indices of poorly converging points: {{0}}&quot;</span>
<span class="s2">        ...         .format(e.slow_conv))</span>
<span class="s2">        ...   print(&quot;Best solution:</span><span class="se">\\</span><span class="s2">n{{0}}&quot;.format(e.best_solution))</span>
<span class="s2">        ...   print(&quot;Achieved accuracy:</span><span class="se">\\</span><span class="s2">n{{0}}&quot;.format(e.accuracy))</span>
<span class="s2">        Indices of diverging points: [1]</span>
<span class="s2">        Indices of poorly converging points: None</span>
<span class="s2">        Best solution:</span>
<span class="s2">        [[ 1.00000009  1.        ]</span>
<span class="s2">         [        nan         nan]</span>
<span class="s2">         [ 3.00000009  1.        ]]</span>
<span class="s2">        Achieved accuracy:</span>
<span class="s2">        [[  2.29417358e-06   3.21222995e-08]</span>
<span class="s2">         [             nan              nan]</span>
<span class="s2">         [  2.27407877e-06   3.13005639e-08]]</span>
<span class="s2">        &gt;&gt;&gt; raise e</span>
<span class="s2">        Traceback (most recent call last):</span>
<span class="s2">        ...</span>
<span class="s2">        NoConvergence: &#39;WCS.all_world2pix&#39; failed to converge to the</span>
<span class="s2">        requested accuracy.  After 6 iterations, the solution is</span>
<span class="s2">        diverging at least for one input point.</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;naxis&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RA_DEC_ORDER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;pixel coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.wcs_world2pix"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.wcs_world2pix">[docs]</a>    <span class="k">def</span> <span class="nf">wcs_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No basic WCS settings were created.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">xy</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">s2p</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">o</span><span class="p">)[</span><span class="s1">&#39;pixcrd&#39;</span><span class="p">],</span>
            <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">wcs_world2pix</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Transforms world coordinates to pixel coordinates, using only</span>
<span class="s2">        the basic `wcslib`_ WCS transformation.  No `SIP`_ or</span>
<span class="s2">        `distortion paper`_ table lookup transformation is applied.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>
<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">            For a transformation that is not two-dimensional, the</span>
<span class="s2">            two-argument form must be used.</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Notes</span>
<span class="s2">        -----</span>
<span class="s2">        The order of the axes for the input world array is determined by</span>
<span class="s2">        the ``CTYPEia`` keywords in the FITS header, therefore it may</span>
<span class="s2">        not always be of the form (*ra*, *dec*).  The</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lat`, `~astropy.wcs.Wcsprm.lng`,</span>
<span class="s2">        `~astropy.wcs.Wcsprm.lattyp` and `~astropy.wcs.Wcsprm.lngtyp`</span>
<span class="s2">        members can be used to determine the order of the axes.</span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        SingularMatrixError</span>
<span class="s2">            Linear transformation matrix is singular.</span>

<span class="s2">        InconsistentAxisTypesError</span>
<span class="s2">            Inconsistent or unrecognized coordinate axis types.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid parameter value.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        ValueError</span>
<span class="s2">            x- and y-coordinate arrays are not the same size.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>

<span class="s2">        InvalidTransformError</span>
<span class="s2">            Ill-conditioned coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;naxis&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RA_DEC_ORDER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;pixel coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.pix2foc"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.pix2foc">[docs]</a>    <span class="k">def</span> <span class="nf">pix2foc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pix2foc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>
    <span class="n">pix2foc</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Convert pixel coordinates to focal plane coordinates using the</span>
<span class="s2">        `SIP`_ polynomial distortion convention and `distortion</span>
<span class="s2">        paper`_ table-lookup correction.</span>

<span class="s2">        The output is in absolute pixel coordinates, not relative to</span>
<span class="s2">        ``CRPIX``.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;focal coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.p4_pix2foc"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.p4_pix2foc">[docs]</a>    <span class="k">def</span> <span class="nf">p4_pix2foc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p4_pix2foc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>
    <span class="n">p4_pix2foc</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Convert pixel coordinates to focal plane coordinates using</span>
<span class="s2">        `distortion paper`_ table-lookup correction.</span>

<span class="s2">        The output is in absolute pixel coordinates, not relative to</span>
<span class="s2">        ``CRPIX``.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;focal coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.det2im"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.det2im">[docs]</a>    <span class="k">def</span> <span class="nf">det2im</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det2im</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>
    <span class="n">det2im</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Convert detector coordinates to image plane coordinates using</span>
<span class="s2">        `distortion paper`_ table-lookup correction.</span>

<span class="s2">        The output is in absolute pixel coordinates, not relative to</span>
<span class="s2">        ``CRPIX``.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;pixel coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.sip_pix2foc"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.sip_pix2foc">[docs]</a>    <span class="k">def</span> <span class="nf">sip_pix2foc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong number of arguments&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">pix2foc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>
    <span class="n">sip_pix2foc</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Convert pixel coordinates to focal plane coordinates using the</span>
<span class="s2">        `SIP`_ polynomial distortion convention.</span>

<span class="s2">        The output is in pixel coordinates, relative to ``CRPIX``.</span>

<span class="s2">        FITS WCS `distortion paper`_ table lookup correction is not</span>
<span class="s2">        applied, even if that information existed in the FITS file</span>
<span class="s2">        that initialized this :class:`~astropy.wcs.WCS` object.  To</span>
<span class="s2">        correct for that, use `~astropy.wcs.WCS.pix2foc` or</span>
<span class="s2">        `~astropy.wcs.WCS.p4_pix2foc`.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;focal coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.sip_foc2pix"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.sip_foc2pix">[docs]</a>    <span class="k">def</span> <span class="nf">sip_foc2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong number of arguments&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">foc2pix</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>
    <span class="n">sip_foc2pix</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Convert focal plane coordinates to pixel coordinates using the</span>
<span class="s2">        `SIP`_ polynomial distortion convention.</span>

<span class="s2">        FITS WCS `distortion paper`_ table lookup distortion</span>
<span class="s2">        correction is not applied, even if that information existed in</span>
<span class="s2">        the FITS file that initialized this `~astropy.wcs.WCS` object.</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>

<span class="s2">        </span><span class="si">{}</span><span class="s2"></span>

<span class="s2">        Raises</span>
<span class="s2">        ------</span>
<span class="s2">        MemoryError</span>
<span class="s2">            Memory allocation failed.</span>

<span class="s2">        ValueError</span>
<span class="s2">            Invalid coordinate transformation parameters.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">TWO_OR_MORE_ARGS</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">docstrings</span><span class="o">.</span><span class="n">RETURNS</span><span class="p">(</span><span class="s1">&#39;pixel coordinates&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<div class="viewcode-block" id="WCS.proj_plane_pixel_scales"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.proj_plane_pixel_scales">[docs]</a>    <span class="k">def</span> <span class="nf">proj_plane_pixel_scales</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate pixel scales along each axis of the image pixel at</span>
<span class="sd">        the ``CRPIX`` location once it is projected onto the</span>
<span class="sd">        &quot;plane of intermediate world coordinates&quot; as defined in</span>
<span class="sd">        `Greisen &amp; Calabretta 2002, A&amp;A, 395, 1061 &lt;https://ui.adsabs.harvard.edu/abs/2002A%26A...395.1061G&gt;`_.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method is concerned **only** about the transformation</span>
<span class="sd">            &quot;image plane&quot;-&gt;&quot;projection plane&quot; and **not** about the</span>
<span class="sd">            transformation &quot;celestial sphere&quot;-&gt;&quot;projection plane&quot;-&gt;&quot;image plane&quot;.</span>
<span class="sd">            Therefore, this function ignores distortions arising due to</span>
<span class="sd">            non-linear nature of most projections.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method only returns sensible answers if the WCS contains</span>
<span class="sd">            celestial axes, i.e., the `~astropy.wcs.WCS.celestial` WCS object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scale : list of `~astropy.units.Quantity`</span>
<span class="sd">            A vector of projection plane increments corresponding to each</span>
<span class="sd">            pixel side (axis).</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        astropy.wcs.utils.proj_plane_pixel_scales</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">proj_plane_pixel_scales</span>  <span class="c1"># Avoid circular import</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">proj_plane_pixel_scales</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">value</span> <span class="o">*</span> <span class="n">unit</span> <span class="k">for</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">)]</span>  <span class="c1"># Can have different units</span></div>

<div class="viewcode-block" id="WCS.proj_plane_pixel_area"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.proj_plane_pixel_area">[docs]</a>    <span class="k">def</span> <span class="nf">proj_plane_pixel_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a **celestial** WCS (see `astropy.wcs.WCS.celestial`), returns pixel</span>
<span class="sd">        area of the image pixel at the ``CRPIX`` location once it is projected</span>
<span class="sd">        onto the &quot;plane of intermediate world coordinates&quot; as defined in</span>
<span class="sd">        `Greisen &amp; Calabretta 2002, A&amp;A, 395, 1061 &lt;https://ui.adsabs.harvard.edu/abs/2002A%26A...395.1061G&gt;`_.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This function is concerned **only** about the transformation</span>
<span class="sd">            &quot;image plane&quot;-&gt;&quot;projection plane&quot; and **not** about the</span>
<span class="sd">            transformation &quot;celestial sphere&quot;-&gt;&quot;projection plane&quot;-&gt;&quot;image plane&quot;.</span>
<span class="sd">            Therefore, this function ignores distortions arising due to</span>
<span class="sd">            non-linear nature of most projections.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method only returns sensible answers if the WCS contains</span>
<span class="sd">            celestial axes, i.e., the `~astropy.wcs.WCS.celestial` WCS object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        area : `~astropy.units.Quantity`</span>
<span class="sd">            Area (in the projection plane) of the pixel at ``CRPIX`` location.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Pixel area is defined only for 2D pixels. Most likely the</span>
<span class="sd">            `~astropy.wcs.Wcsprm.cd` matrix of the `~astropy.wcs.WCS.celestial`</span>
<span class="sd">            WCS is not a square matrix of second order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Depending on the application, square root of the pixel area can be used to</span>
<span class="sd">        represent a single pixel scale of an equivalent square pixel</span>
<span class="sd">        whose area is equal to the area of a generally non-square pixel.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        astropy.wcs.utils.proj_plane_pixel_area</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">proj_plane_pixel_area</span>  <span class="c1"># Avoid circular import</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">proj_plane_pixel_area</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 2D only</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">*</span> <span class="n">unit</span></div>

<div class="viewcode-block" id="WCS.to_fits"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.to_fits">[docs]</a>    <span class="k">def</span> <span class="nf">to_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an `~astropy.io.fits.HDUList` object with all of the</span>
<span class="sd">        information stored in this object.  This should be logically identical</span>
<span class="sd">        to the input FITS file, but it will be normalized in a number of ways.</span>

<span class="sd">        See `to_header` for some warnings about the output produced.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        relax : bool or int, optional</span>
<span class="sd">            Degree of permissiveness:</span>

<span class="sd">            - `False` (default): Write all extensions that are</span>
<span class="sd">              considered to be safe and recommended.</span>

<span class="sd">            - `True`: Write all recognized informal extensions of the</span>
<span class="sd">              WCS standard.</span>

<span class="sd">            - `int`: a bit field selecting specific extensions to</span>
<span class="sd">              write.  See :ref:`astropy:relaxwrite` for details.</span>

<span class="sd">        key : str</span>
<span class="sd">            The name of a particular WCS transform to use.  This may be</span>
<span class="sd">            either ``&#39; &#39;`` or ``&#39;A&#39;``-``&#39;Z&#39;`` and corresponds to the ``&quot;a&quot;``</span>
<span class="sd">            part of the ``CTYPEia`` cards.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hdulist : `~astropy.io.fits.HDUList`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="n">relax</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_det2im</span><span class="p">(</span><span class="n">hdulist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_distortion_kw</span><span class="p">(</span><span class="n">hdulist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hdulist</span></div>

<div class="viewcode-block" id="WCS.to_header"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.to_header">[docs]</a>    <span class="k">def</span> <span class="nf">to_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate an `astropy.io.fits.Header` object with the basic WCS</span>
<span class="sd">        and SIP information stored in this object.  This should be</span>
<span class="sd">        logically identical to the input FITS file, but it will be</span>
<span class="sd">        normalized in a number of ways.</span>

<span class="sd">        .. warning::</span>

<span class="sd">          This function does not write out FITS WCS `distortion</span>
<span class="sd">          paper`_ information, since that requires multiple FITS</span>
<span class="sd">          header data units.  To get a full representation of</span>
<span class="sd">          everything in this object, use `to_fits`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        relax : bool or int, optional</span>
<span class="sd">            Degree of permissiveness:</span>

<span class="sd">            - `False` (default): Write all extensions that are</span>
<span class="sd">              considered to be safe and recommended.</span>

<span class="sd">            - `True`: Write all recognized informal extensions of the</span>
<span class="sd">              WCS standard.</span>

<span class="sd">            - `int`: a bit field selecting specific extensions to</span>
<span class="sd">              write.  See :ref:`astropy:relaxwrite` for details.</span>

<span class="sd">            If the ``relax`` keyword argument is not given and any</span>
<span class="sd">            keywords were omitted from the output, an</span>
<span class="sd">            `~astropy.utils.exceptions.AstropyWarning` is displayed.</span>
<span class="sd">            To override this, explicitly pass a value to ``relax``.</span>

<span class="sd">        key : str</span>
<span class="sd">            The name of a particular WCS transform to use.  This may be</span>
<span class="sd">            either ``&#39; &#39;`` or ``&#39;A&#39;``-``&#39;Z&#39;`` and corresponds to the ``&quot;a&quot;``</span>
<span class="sd">            part of the ``CTYPEia`` cards.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        header : `astropy.io.fits.Header`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The output header will almost certainly differ from the input in a</span>
<span class="sd">        number of respects:</span>

<span class="sd">          1. The output header only contains WCS-related keywords.  In</span>
<span class="sd">             particular, it does not contain syntactically-required</span>
<span class="sd">             keywords such as ``SIMPLE``, ``NAXIS``, ``BITPIX``, or</span>
<span class="sd">             ``END``.</span>

<span class="sd">          2. Deprecated (e.g. ``CROTAn``) or non-standard usage will</span>
<span class="sd">             be translated to standard (this is partially dependent on</span>
<span class="sd">             whether ``fix`` was applied).</span>

<span class="sd">          3. Quantities will be converted to the units used internally,</span>
<span class="sd">             basically SI with the addition of degrees.</span>

<span class="sd">          4. Floating-point quantities may be given to a different decimal</span>
<span class="sd">             precision.</span>

<span class="sd">          5. Elements of the ``PCi_j`` matrix will be written if and</span>
<span class="sd">             only if they differ from the unit matrix.  Thus, if the</span>
<span class="sd">             matrix is unity then no elements will be written.</span>

<span class="sd">          6. Additional keywords such as ``WCSAXES``, ``CUNITia``,</span>
<span class="sd">             ``LONPOLEa`` and ``LATPOLEa`` may appear.</span>

<span class="sd">          7. The original keycomments will be lost, although</span>
<span class="sd">             `to_header` tries hard to write meaningful comments.</span>

<span class="sd">          8. Keyword order may be changed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default precision for numerical WCS keywords</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="n">WCSHDO_P14</span>  <span class="c1"># Defined by C-ext  # noqa: F821</span>
        <span class="n">display_warning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">relax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">display_warning</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">relax</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">relax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">do_sip</span> <span class="o">=</span> <span class="n">relax</span> <span class="o">&amp;</span> <span class="n">WCSHDO_SIP</span>
            <span class="n">relax</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WCSHDO_SIP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_sip</span> <span class="o">=</span> <span class="n">relax</span>
            <span class="n">relax</span> <span class="o">=</span> <span class="n">WCSHDO_all</span> <span class="k">if</span> <span class="n">relax</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">WCSHDO_safe</span>  <span class="c1"># Defined by C-ext  # noqa: F821</span>

        <span class="n">relax</span> <span class="o">=</span> <span class="n">precision</span> <span class="o">|</span> <span class="n">relax</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">orig_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">header_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header_string</span><span class="p">)</span>
            <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span>
            <span class="c1"># Check if we can handle TPD distortion correctly</span>
            <span class="k">if</span> <span class="n">_WCS_TPD_WARN_LT71</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">kw</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CPDIS&#39;</span><span class="p">,</span> <span class="s1">&#39;CQDIS&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;TPD&#39;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;WCS contains a TPD distortion model in </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">. WCSLIB &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> is writing this in a format incompatible with &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;current versions - please update to 7.4 or use the bundled WCSLIB.&quot;</span><span class="p">,</span>
                            <span class="n">AstropyWarning</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_WCS_TPD_WARN_LT74</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">kw</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CPDIS&#39;</span><span class="p">,</span> <span class="s1">&#39;CQDIS&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;TPD&#39;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;WCS contains a TPD distortion model in </span><span class="si">{</span><span class="n">kw</span><span class="si">}</span><span class="s2">, which requires WCSLIB &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;7.4 or later to store in a FITS header (having </span><span class="si">{</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
                            <span class="n">AstropyWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">do_sip</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">ctyp</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-SIP&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fix_ctype</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">add_sip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_sip_kw</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">header</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_sip</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This is called when relax is not False or WCSHDO_SIP</span>
            <span class="c1"># The default case of ``relax=None`` is handled further in the code.</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_ctype</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">add_sip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display_warning</span><span class="p">:</span>
            <span class="n">full_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">full_header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">kw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">missing_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Some non-standard WCS keywords were excluded: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;Use the ``relax`` kwarg to control this.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)),</span>
                    <span class="n">AstropyWarning</span><span class="p">)</span>
            <span class="c1"># called when ``relax=None``</span>
            <span class="c1"># This is different from the case of ``relax=False``.</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_ctype</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">add_sip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Finally reset the key. This must be called after ``_fix_ctype``.</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">orig_key</span>
        <span class="k">return</span> <span class="n">header</span></div>

    <span class="k">def</span> <span class="nf">_fix_ctype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">add_sip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : `~astropy.io.fits.Header`</span>
<span class="sd">            FITS header.</span>
<span class="sd">        add_sip : bool</span>
<span class="sd">            Flag indicating whether &quot;-SIP&quot; should be added or removed from CTYPE keywords.</span>

<span class="sd">            Remove &quot;-SIP&quot; from CTYPE when writing out a header with relax=False.</span>
<span class="sd">            This needs to be done outside ``to_header`` because ``to_header`` runs</span>
<span class="sd">            twice when ``relax=False`` and the second time ``relax`` is set to ``True``</span>
<span class="sd">            to display the missing keywords.</span>

<span class="sd">            If the user requested SIP distortion to be written out add &quot;-SIP&quot; to</span>
<span class="sd">            CTYPE if it is missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_add_sip_to_ctype</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Inconsistent SIP distortion information is present in the current WCS:</span>
<span class="s2">        SIP coefficients were detected, but CTYPE is missing &quot;-SIP&quot; suffix,</span>
<span class="s2">        therefore the current WCS is internally inconsistent.</span>

<span class="s2">        Because relax has been set to True, the resulting output WCS will have</span>
<span class="s2">        &quot;-SIP&quot; appended to CTYPE in order to make the header internally consistent.</span>

<span class="s2">        However, this may produce incorrect astrometry in the output WCS, if</span>
<span class="s2">        in fact the current WCS is already distortion-corrected.</span>

<span class="s2">        Therefore, if current WCS is already distortion-corrected (eg, drizzled)</span>
<span class="s2">        then SIP distortion components should not apply. In that case, for a WCS</span>
<span class="s2">        that is already distortion-corrected, please remove the SIP coefficients</span>
<span class="s2">        from the header.</span>

<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log_message</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">add_sip</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_add_sip_to_ctype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># strip() must be called here to cover the case of alt key= &quot; &quot;</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CTYPE</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">add_sip</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;-SIP&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-SIP&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;-SIP&quot;</span><span class="p">)</span>
                <span class="n">header</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">header</span>

<div class="viewcode-block" id="WCS.to_header_string"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.to_header_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_header_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identical to `to_header`, but returns a string containing the</span>
<span class="sd">        header cards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="p">))</span></div>

<div class="viewcode-block" id="WCS.footprint_to_file"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.footprint_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">footprint_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;footprint.reg&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                          <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">coordsys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes out a `ds9`_ style regions file. It can be loaded</span>
<span class="sd">        directly by `ds9`_.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            Output file name - default is ``&#39;footprint.reg&#39;``</span>

<span class="sd">        color : str, optional</span>
<span class="sd">            Color to use when plotting the line.</span>

<span class="sd">        width : int, optional</span>
<span class="sd">            Width of the region line.</span>

<span class="sd">        coordsys : str, optional</span>
<span class="sd">            Coordinate system. If not specified (default), the ``radesys``</span>
<span class="sd">            value is used. For all possible values, see</span>
<span class="sd">            http://ds9.si.edu/doc/ref/region.html#RegionFileFormat</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;# Region file format: DS9 version 4.0 </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;# global color=green font=&quot;helvetica 12 bold &#39;</span>
                    <span class="s1">&#39;select=1 highlite=1 edit=1 move=1 delete=1 &#39;</span>
                    <span class="s1">&#39;include=1 fixed=0 source</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">coordsys</span> <span class="o">=</span> <span class="n">coordsys</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">radesys</span>

        <span class="k">if</span> <span class="n">coordsys</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PHYSICAL&#39;</span><span class="p">,</span> <span class="s1">&#39;IMAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;FK4&#39;</span><span class="p">,</span> <span class="s1">&#39;B1950&#39;</span><span class="p">,</span> <span class="s1">&#39;FK5&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;J2000&#39;</span><span class="p">,</span> <span class="s1">&#39;GALACTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;ECLIPTIC&#39;</span><span class="p">,</span> <span class="s1">&#39;ICRS&#39;</span><span class="p">,</span> <span class="s1">&#39;LINEAR&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;AMPLIFIER&#39;</span><span class="p">,</span> <span class="s1">&#39;DETECTOR&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate system &#39;</span><span class="si">{}</span><span class="s2">&#39; is not supported. A valid&quot;</span>
                             <span class="s2">&quot; one can be given with the &#39;coordsys&#39; argument.&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coordsys</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coordsys</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;polygon(&#39;</span><span class="p">)</span>
            <span class="n">ftpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_footprint</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ftpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ftpr</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;) # color=</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s1">, width=</span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_naxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_naxis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))):</span>
            <span class="k">for</span> <span class="n">naxis</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_naxis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;NAXIS</span><span class="si">{</span><span class="n">naxis</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_naxis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_naxis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">_naxis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_naxis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_naxis</span> <span class="o">=</span> <span class="n">_naxis</span>

<div class="viewcode-block" id="WCS.printwcs"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.printwcs">[docs]</a>    <span class="k">def</span> <span class="nf">printwcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a short description. Simply porting the behavior from</span>
<span class="sd">        the `printwcs()` method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WCS Keywords</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="sa">f</span><span class="s2">&quot;Number of WCS axes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">sfmt</span> <span class="o">=</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;{&quot;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;!r}  &quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">)])</span>

        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL&#39;</span><span class="p">,</span> <span class="s1">&#39;CRPIX&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="o">+</span><span class="n">sfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">sfmt</span>
                <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;CDELT&#39;</span> <span class="o">+</span> <span class="n">sfmt</span>
            <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;cd&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">naxis</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;CD&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">sfmt</span>
                <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NAXIS : </span><span class="si">{</span><span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naxis</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

<div class="viewcode-block" id="WCS.get_axis_types"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.get_axis_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_axis_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar to `self.wcsprm.axis_types &lt;astropy.wcs.Wcsprm.axis_types&gt;`</span>
<span class="sd">        but provides the information in a more Python-friendly format.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : list of dict</span>

<span class="sd">            Returns a list of dictionaries, one for each axis, each</span>
<span class="sd">            containing attributes about the type of that axis.</span>

<span class="sd">            Each dictionary has the following keys:</span>

<span class="sd">            - &#39;coordinate_type&#39;:</span>

<span class="sd">              - None: Non-specific coordinate type.</span>

<span class="sd">              - &#39;stokes&#39;: Stokes coordinate.</span>

<span class="sd">              - &#39;celestial&#39;: Celestial coordinate (including ``CUBEFACE``).</span>

<span class="sd">              - &#39;spectral&#39;: Spectral coordinate.</span>

<span class="sd">            - &#39;scale&#39;:</span>

<span class="sd">              - &#39;linear&#39;: Linear axis.</span>

<span class="sd">              - &#39;quantized&#39;: Quantized axis (``STOKES``, ``CUBEFACE``).</span>

<span class="sd">              - &#39;non-linear celestial&#39;: Non-linear celestial axis.</span>

<span class="sd">              - &#39;non-linear spectral&#39;: Non-linear spectral axis.</span>

<span class="sd">              - &#39;logarithmic&#39;: Logarithmic axis.</span>

<span class="sd">              - &#39;tabular&#39;: Tabular axis.</span>

<span class="sd">            - &#39;group&#39;</span>

<span class="sd">              - Group number, e.g. lookup table number</span>

<span class="sd">            - &#39;number&#39;</span>

<span class="sd">              - For celestial axes:</span>

<span class="sd">                - 0: Longitude coordinate.</span>

<span class="sd">                - 1: Latitude coordinate.</span>

<span class="sd">                - 2: ``CUBEFACE`` number.</span>

<span class="sd">              - For lookup tables:</span>

<span class="sd">                - the axis number in a multidimensional table.</span>

<span class="sd">            ``CTYPEia`` in ``&quot;4-3&quot;`` form with unrecognized algorithm code will</span>
<span class="sd">            generate an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;This WCS object does not have a wcsprm object.&quot;</span><span class="p">)</span>

        <span class="n">coordinate_type_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;stokes&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;celestial&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;spectral&#39;</span><span class="p">}</span>

        <span class="n">scale_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;quantized&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;non-linear celestial&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;non-linear spectral&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;logarithmic&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;tabular&#39;</span><span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">axis_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">axis_types</span><span class="p">:</span>
            <span class="n">subresult</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">coordinate_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis_type</span> <span class="o">//</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span>
            <span class="n">subresult</span><span class="p">[</span><span class="s1">&#39;coordinate_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinate_type_map</span><span class="p">[</span><span class="n">coordinate_type</span><span class="p">]</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis_type</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span>
            <span class="n">subresult</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_map</span><span class="p">[</span><span class="n">scale</span><span class="p">]</span>

            <span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis_type</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span>
            <span class="n">subresult</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>

            <span class="n">number</span> <span class="o">=</span> <span class="n">axis_type</span> <span class="o">%</span> <span class="mi">10</span>
            <span class="n">subresult</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>

            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subresult</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Support pickling of WCS objects.  This is done by serializing</span>
<span class="sd">        to an in-memory FITS file and dumping that as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hdulist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_fits</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

        <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;_alt_wcskey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">__WCS_unpickle__</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),))</span>

<div class="viewcode-block" id="WCS.dropaxis"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.dropaxis">[docs]</a>    <span class="k">def</span> <span class="nf">dropaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dropax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove an axis from the WCS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wcs : `~astropy.wcs.WCS`</span>
<span class="sd">            The WCS with naxis to be chopped to naxis-1</span>
<span class="sd">        dropax : int</span>
<span class="sd">            The index of the WCS to drop, counting from 0 (i.e., python convention,</span>
<span class="sd">            not FITS convention)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `~astropy.wcs.WCS`</span>
<span class="sd">            A new `~astropy.wcs.WCS` instance with one axis fewer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span><span class="p">))</span>
        <span class="n">inds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dropax</span><span class="p">)</span>

        <span class="c1"># axis 0 has special meaning to sub</span>
        <span class="c1"># if wcs.wcs.ctype == [&#39;RA&#39;,&#39;DEC&#39;,&#39;VLSR&#39;], you want</span>
        <span class="c1"># wcs.sub([1,2]) to get &#39;RA&#39;,&#39;DEC&#39; back</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">])</span></div>

<div class="viewcode-block" id="WCS.swapaxes"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.swapaxes">[docs]</a>    <span class="k">def</span> <span class="nf">swapaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Swap axes in a WCS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wcs : `~astropy.wcs.WCS`</span>
<span class="sd">            The WCS to have its axes swapped</span>
<span class="sd">        ax0 : int</span>
<span class="sd">        ax1 : int</span>
<span class="sd">            The indices of the WCS to be swapped, counting from 0 (i.e., python</span>
<span class="sd">            convention, not FITS convention)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `~astropy.wcs.WCS`</span>
<span class="sd">            A new `~astropy.wcs.WCS` instance with the same number of axes,</span>
<span class="sd">            but two swapped</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span><span class="p">))</span>
        <span class="n">inds</span><span class="p">[</span><span class="n">ax0</span><span class="p">],</span> <span class="n">inds</span><span class="p">[</span><span class="n">ax1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">ax1</span><span class="p">],</span> <span class="n">inds</span><span class="p">[</span><span class="n">ax0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">])</span></div>

<div class="viewcode-block" id="WCS.reorient_celestial_first"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.reorient_celestial_first">[docs]</a>    <span class="k">def</span> <span class="nf">reorient_celestial_first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reorient the WCS such that the celestial axes are first, followed by</span>
<span class="sd">        the spectral axis, followed by any others.</span>
<span class="sd">        Assumes at least celestial axes are present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="n">WCSSUB_CELESTIAL</span><span class="p">,</span> <span class="n">WCSSUB_SPECTRAL</span><span class="p">,</span> <span class="n">WCSSUB_STOKES</span><span class="p">,</span> <span class="n">WCSSUB_TIME</span><span class="p">])</span>  <span class="c1"># Defined by C-ext  # noqa: F821 E501</span></div>

<div class="viewcode-block" id="WCS.slice"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.slice">[docs]</a>    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">numpy_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice a WCS instance using a Numpy slice. The order of the slice should</span>
<span class="sd">        be reversed (as for the data) compared to the natural WCS order.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        view : tuple</span>
<span class="sd">            A tuple containing the same number of slices as the WCS system.</span>
<span class="sd">            The ``step`` method, the third argument to a slice, is not</span>
<span class="sd">            presently supported.</span>
<span class="sd">        numpy_order : bool</span>
<span class="sd">            Use numpy order, i.e. slice the WCS so that an identical slice</span>
<span class="sd">            applied to a numpy array will slice the array and WCS in the same</span>
<span class="sd">            way. If set to `False`, the WCS will be sliced in FITS order,</span>
<span class="sd">            meaning the first slice will be applied to the *last* numpy index</span>
<span class="sd">            but the *first* WCS axis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wcs_new : `~astropy.wcs.WCS`</span>
<span class="sd">            A new resampled WCS axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have # of slices &lt;= # of WCS axes&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>  <span class="c1"># view MUST be an iterable</span>
            <span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">view</span><span class="p">):</span>
            <span class="c1"># We need to drop some dimensions, but this may not always be</span>
            <span class="c1"># possible with .sub due to correlated axes, so instead we use the</span>
            <span class="c1"># generalized slicing infrastructure from astropy.wcs.wcsapi.</span>
            <span class="k">return</span> <span class="n">SlicedFITSWCS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>

        <span class="c1"># NOTE: we could in principle use SlicedFITSWCS as above for all slicing,</span>
        <span class="c1"># but in the simple case where there are no axes dropped, we can just</span>
        <span class="c1"># create a full WCS object with updated WCS parameters which is faster</span>
        <span class="c1"># for this specific case and also backward-compatible.</span>

        <span class="n">wcs_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wcs_new</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sip_crpix</span> <span class="o">=</span> <span class="n">wcs_new</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">crpix</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iview</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">iview</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iview</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Reversing an axis is not &quot;</span>
                                          <span class="s2">&quot;implemented.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">numpy_order</span><span class="p">:</span>
                <span class="n">wcs_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wcs_index</span> <span class="o">=</span> <span class="n">i</span>

            <span class="k">if</span> <span class="n">iview</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iview</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Slice from &quot;None&quot; is equivalent to slice from 0 (but one</span>
                <span class="c1"># might want to downsample, so allow slices with</span>
                <span class="c1"># None,None,step or None,stop,step)</span>
                <span class="n">iview</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iview</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">iview</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">iview</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iview</span><span class="o">.</span><span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">crpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span>
                    <span class="n">cdelt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span>
                    <span class="c1"># equivalently (keep this comment so you can compare eqns):</span>
                    <span class="c1"># wcs_new.wcs.crpix[wcs_index] =</span>
                    <span class="c1"># (crpix - iview.start)*iview.step + 0.5 - iview.step/2.</span>
                    <span class="n">crp</span> <span class="o">=</span> <span class="p">((</span><span class="n">crpix</span> <span class="o">-</span> <span class="n">iview</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">iview</span><span class="o">.</span><span class="n">step</span>
                           <span class="o">+</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">iview</span><span class="o">.</span><span class="n">step</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
                    <span class="n">wcs_new</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp</span>
                    <span class="k">if</span> <span class="n">wcs_new</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sip_crpix</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">crp</span>
                    <span class="n">wcs_new</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdelt</span> <span class="o">*</span> <span class="n">iview</span><span class="o">.</span><span class="n">step</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wcs_new</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span> <span class="o">-=</span> <span class="n">iview</span><span class="o">.</span><span class="n">start</span>
                    <span class="k">if</span> <span class="n">wcs_new</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sip_crpix</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span> <span class="o">-=</span> <span class="n">iview</span><span class="o">.</span><span class="n">start</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># range requires integers but the other attributes can also</span>
                <span class="c1"># handle arbitrary values, so this needs to be in a try/except.</span>
                <span class="n">nitems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">builtins</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naxis</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">])[</span><span class="n">iview</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;indices must be integers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                    <span class="k">raise</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;NAXIS</span><span class="si">{}</span><span class="s2"> attribute is not updated because at &quot;</span>
                              <span class="s2">&quot;least one index (&#39;</span><span class="si">{}</span><span class="s2">&#39;) is no integer.&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wcs_index</span><span class="p">,</span> <span class="n">iview</span><span class="p">),</span> <span class="n">AstropyUserWarning</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wcs_new</span><span class="o">.</span><span class="n">_naxis</span><span class="p">[</span><span class="n">wcs_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nitems</span>

        <span class="k">if</span> <span class="n">wcs_new</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wcs_new</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">Sip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">ap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">bp</span><span class="p">,</span>
                              <span class="n">sip_crpix</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wcs_new</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># &quot;getitem&quot; is a shortcut for self.slice; it is very limited</span>
        <span class="c1"># there is no obvious and unambiguous interpretation of wcs[1,2,3]</span>
        <span class="c1"># We COULD allow wcs[1] to link to wcs.sub([2])</span>
        <span class="c1"># (wcs[i] -&gt; wcs.sub([i+1])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Having __getitem__ makes Python think WCS is iterable. However,</span>
        <span class="c1"># Python first checks whether __iter__ is present, so we can raise an</span>
        <span class="c1"># exception here.</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; object is not iterable&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axis_type_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        World names for each coordinate axis</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            A list of names along each axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cname</span><span class="p">)</span>
        <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">celestial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A copy of the current WCS with only the celestial axes included</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="n">WCSSUB_CELESTIAL</span><span class="p">])</span>  <span class="c1"># Defined by C-ext  # noqa: F821</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_celestial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_celestial</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_celestial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lng</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="n">InconsistentAxisTypesError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A copy of the current WCS with only the spectral axes included</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="n">WCSSUB_SPECTRAL</span><span class="p">])</span>  <span class="c1"># Defined by C-ext  # noqa: F821</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_spectral</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">spec</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="n">InconsistentAxisTypesError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temporal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A copy of the current WCS with only the time axes included</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_WCSSUB_TIME_SUPPORT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Support for &#39;temporal&#39; axis requires WCSLIB version 7.8 or &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;greater but linked WCSLIB version is </span><span class="si">{</span><span class="n">_wcs</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="n">WCSSUB_TIME</span><span class="p">])</span>  <span class="c1"># Defined by C-ext  # noqa: F821</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_temporal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_temporal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_temporal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">//</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">axis_types</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns `True` if any distortion terms are present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpdis1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpdis2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">det2im1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2im2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_scale_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cdelt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_cdelt</span><span class="p">())</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_pc</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">InconsistentAxisTypesError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># for non-celestial axes, get_cdelt doesn&#39;t work</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                        <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;cdelt will be ignored since cd is present&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                    <span class="n">cdelt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">cdelt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pc</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">pccd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cdelt</span><span class="p">,</span> <span class="n">pc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pccd</span>

<div class="viewcode-block" id="WCS.footprint_contains"><a class="viewcode-back" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS.footprint_contains">[docs]</a>    <span class="k">def</span> <span class="nf">footprint_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if a given SkyCoord is contained in the wcs footprint.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coord : `~astropy.coordinates.SkyCoord`</span>
<span class="sd">            The coordinate to check if it is within the wcs coordinate.</span>
<span class="sd">        **kwargs :</span>
<span class="sd">           Additional arguments to pass to `~astropy.coordinates.SkyCoord.to_pixel`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : bool</span>
<span class="sd">           True means the WCS footprint contains the coordinate, False means it does not.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">coord</span><span class="o">.</span><span class="n">contained_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">__WCS_unpickle__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">fits_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unpickles a WCS object from a serialized FITS string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">fits_data</span><span class="p">)</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

    <span class="n">naxis</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;naxis&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">naxis</span><span class="p">:</span>
        <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;naxis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">naxis</span>
        <span class="n">naxes</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_naxis&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">naxes</span><span class="p">):</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;naxis</span><span class="si">{</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">na</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_init_kwargs&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>

    <span class="n">wcskey</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_alt_wcskey&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">WCS</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">hdulist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">wcskey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pixel_bounds</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_pixel_bounds&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="find_all_wcs"><a class="viewcode-back" href="../../../api/astropy.wcs.find_all_wcs.html#astropy.wcs.find_all_wcs">[docs]</a><span class="k">def</span> <span class="nf">find_all_wcs</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keysel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">translate_units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">_do_set</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all the WCS transformations in the given header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : str or `~astropy.io.fits.Header` object.</span>

<span class="sd">    relax : bool or int, optional</span>
<span class="sd">        Degree of permissiveness:</span>

<span class="sd">        - `True` (default): Admit all recognized informal extensions of the</span>
<span class="sd">          WCS standard.</span>

<span class="sd">        - `False`: Recognize only FITS keywords defined by the</span>
<span class="sd">          published WCS standard.</span>

<span class="sd">        - `int`: a bit field selecting specific extensions to accept.</span>
<span class="sd">          See :ref:`astropy:relaxread` for details.</span>

<span class="sd">    keysel : sequence of str, optional</span>
<span class="sd">        A list of flags used to select the keyword types considered by</span>
<span class="sd">        wcslib.  When ``None``, only the standard image header</span>
<span class="sd">        keywords are considered (and the underlying wcspih() C</span>
<span class="sd">        function is called).  To use binary table image array or pixel</span>
<span class="sd">        list keywords, *keysel* must be set.</span>

<span class="sd">        Each element in the list should be one of the following strings:</span>

<span class="sd">            - &#39;image&#39;: Image header keywords</span>

<span class="sd">            - &#39;binary&#39;: Binary table image array keywords</span>

<span class="sd">            - &#39;pixel&#39;: Pixel list keywords</span>

<span class="sd">        Keywords such as ``EQUIna`` or ``RFRQna`` that are common to</span>
<span class="sd">        binary table image arrays and pixel lists (including</span>
<span class="sd">        ``WCSNna`` and ``TWCSna``) are selected by both &#39;binary&#39; and</span>
<span class="sd">        &#39;pixel&#39;.</span>

<span class="sd">    fix : bool, optional</span>
<span class="sd">        When `True` (default), call `~astropy.wcs.Wcsprm.fix` on</span>
<span class="sd">        the resulting objects to fix any non-standard uses in the</span>
<span class="sd">        header.  `FITSFixedWarning` warnings will be emitted if any</span>
<span class="sd">        changes were made.</span>

<span class="sd">    translate_units : str, optional</span>
<span class="sd">        Specify which potentially unsafe translations of non-standard</span>
<span class="sd">        unit strings to perform.  By default, performs none.  See</span>
<span class="sd">        `WCS.fix` for more information about this parameter.  Only</span>
<span class="sd">        effective when ``fix`` is `True`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wcses : list of `WCS`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="n">header_string</span> <span class="o">=</span> <span class="n">header</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
        <span class="n">header_string</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;header must be a string or astropy.io.fits.Header object&quot;</span><span class="p">)</span>

    <span class="n">keysel_flags</span> <span class="o">=</span> <span class="n">_parse_keysel</span><span class="p">(</span><span class="n">keysel</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header_bytes</span> <span class="o">=</span> <span class="n">header_string</span>

    <span class="n">wcsprms</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">find_all_wcs</span><span class="p">(</span><span class="n">header_bytes</span><span class="p">,</span> <span class="n">relax</span><span class="p">,</span> <span class="n">keysel_flags</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">wcsprm</span> <span class="ow">in</span> <span class="n">wcsprms</span><span class="p">:</span>
        <span class="n">subresult</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_do_set</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subresult</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">wcsprm</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subresult</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
            <span class="n">subresult</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">translate_units</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_do_set</span><span class="p">:</span>
            <span class="n">subresult</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="validate"><a class="viewcode-back" href="../../../api/astropy.wcs.validate.html#astropy.wcs.validate">[docs]</a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints a WCS validation report for the given FITS file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : str or file-like or `~astropy.io.fits.HDUList`</span>
<span class="sd">        The FITS file to validate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results : list subclass instance</span>
<span class="sd">        The result is returned as nested lists.  The first level</span>
<span class="sd">        corresponds to the HDUs in the given file.  The next level has</span>
<span class="sd">        an entry for each WCS found in that header.  The special</span>
<span class="sd">        subclass of list will pretty-print the results as a table when</span>
<span class="sd">        printed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">_WcsValidateWcsResult</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;  WCS key &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">or</span> <span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">initial_indent</span> <span class="o">=</span> <span class="s1">&#39;    - &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">initial_indent</span> <span class="o">=</span> <span class="s1">&#39;      &#39;</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                            <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span>
                                <span class="n">line</span><span class="p">,</span>
                                <span class="n">initial_indent</span><span class="o">=</span><span class="n">initial_indent</span><span class="p">,</span>
                                <span class="n">subsequent_indent</span><span class="o">=</span><span class="s1">&#39;      &#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    No issues.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">_WcsValidateHduResult</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu_index</span><span class="p">,</span> <span class="n">hdu_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hdu_index</span> <span class="o">=</span> <span class="n">hdu_index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hdu_name</span> <span class="o">=</span> <span class="n">hdu_name</span>
            <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdu_name</span><span class="p">:</span>
                    <span class="n">hdu_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdu_name</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hdu_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;HDU </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdu_index</span><span class="si">}{</span><span class="n">hdu_name</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">wcs</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">wcs</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">class</span> <span class="nc">_WcsValidateResults</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">__warningregistry__</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">):</span>
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">source</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">_WcsValidateResults</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdulist</span><span class="p">):</span>
        <span class="n">hdu_results</span> <span class="o">=</span> <span class="n">_WcsValidateHduResult</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hdu</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_results</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_lines</span><span class="p">:</span>
            <span class="n">wcses</span> <span class="o">=</span> <span class="n">find_all_wcs</span><span class="p">(</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="n">_wcs</span><span class="o">.</span><span class="n">WCSHDR_reject</span><span class="p">,</span>
                <span class="n">fix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_do_set</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">wcs</span> <span class="ow">in</span> <span class="n">wcses</span><span class="p">:</span>
            <span class="n">wcs_results</span> <span class="o">=</span> <span class="n">_WcsValidateWcsResult</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span><span class="p">)</span>
            <span class="n">hdu_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wcs_results</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">__warningregistry__</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_lines</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span>
                    <span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="n">FITSFixedWarning</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">alt</span> <span class="ow">or</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
                        <span class="n">relax</span><span class="o">=</span><span class="n">_wcs</span><span class="o">.</span><span class="n">WCSHDR_reject</span><span class="p">,</span>
                        <span class="n">fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_do_set</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">WcsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">wcs_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="n">wcs_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">warning_lines</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">results</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011–2022, The Astropy Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.5.4. &nbsp;
    Last built 09 May 2022. <br/>
  </p>
</footer>
  </body>
</html>