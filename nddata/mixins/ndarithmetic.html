


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NDData Arithmetic &#8212; Astropy v5.2.dev94+gb1133d712.d20220509</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="I/O Mixin" href="ndio.html" />
    <link rel="prev" title="Slicing and Indexing NDData" href="ndslicing.html" />
  
  <meta name="robots" content="noindex, nofollow">
  
  
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>


  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="ndio.html" title="I/O Mixin">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="ndslicing.html" title="Slicing and Indexing NDData">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../index.html">Astropy v5.2.dev94+gb1133d712.d20220509</a>
	 &#187;
      </li>
      <li><a href="../index.html" >N-Dimensional Datasets (<code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.nddata</span></code>)</a> &#187;</li>
      <li><a href="index.html" accesskey="U">Mixins for Added Functionality</a> &#187;</li>
      
      <li>NDData Arithmetic</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="nddata-arithmetic">
<span id="id1"></span><h1>NDData Arithmetic<a class="headerlink" href="#nddata-arithmetic" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../../api/astropy.nddata.NDDataRef.html#astropy.nddata.NDDataRef" title="astropy.nddata.NDDataRef"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDDataRef</span></code></a> implements the following arithmetic operations:</p>
<ul class="simple">
<li><p>Addition: <a class="reference internal" href="../../api/astropy.nddata.NDArithmeticMixin.html#astropy.nddata.NDArithmeticMixin.add" title="astropy.nddata.NDArithmeticMixin.add"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add()</span></code></a></p></li>
<li><p>Subtraction: <a class="reference internal" href="../../api/astropy.nddata.NDArithmeticMixin.html#astropy.nddata.NDArithmeticMixin.subtract" title="astropy.nddata.NDArithmeticMixin.subtract"><code class="xref py py-meth docutils literal notranslate"><span class="pre">subtract()</span></code></a></p></li>
<li><p>Multiplication: <a class="reference internal" href="../../api/astropy.nddata.NDArithmeticMixin.html#astropy.nddata.NDArithmeticMixin.multiply" title="astropy.nddata.NDArithmeticMixin.multiply"><code class="xref py py-meth docutils literal notranslate"><span class="pre">multiply()</span></code></a></p></li>
<li><p>Division: <a class="reference internal" href="../../api/astropy.nddata.NDArithmeticMixin.html#astropy.nddata.NDArithmeticMixin.divide" title="astropy.nddata.NDArithmeticMixin.divide"><code class="xref py py-meth docutils literal notranslate"><span class="pre">divide()</span></code></a></p></li>
</ul>
</div>
<div class="section" id="using-basic-arithmetic-methods">
<h2>Using Basic Arithmetic Methods<a class="headerlink" href="#using-basic-arithmetic-methods" title="Permalink to this headline">¶</a></h2>
<p>Using the standard arithmetic methods requires that the first operand
is an <a class="reference internal" href="../../api/astropy.nddata.NDDataRef.html#astropy.nddata.NDDataRef" title="astropy.nddata.NDDataRef"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDDataRef</span></code></a> instance:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">NDDataRef</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
<p>While the requirement for the second operand is that it must be convertible
to the first operand. It can be a number:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">NDDataRef([4, 5, 6, 7])</span>
</pre></div>
</div>
<p>Or a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">list</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="go">NDDataRef([0, 1, 2, 3])</span>
</pre></div>
</div>
<p>Or a <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="go">NDDataRef([ 4, 10, 18, 28])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>  <span class="c1"># a 3 x 4 numpy array  </span>
<span class="go">NDDataRef([[1.        , 1.        , 1.        , 1.        ],</span>
<span class="go">           [0.2       , 0.33333333, 0.42857143, 0.5       ],</span>
<span class="go">           [0.11111111, 0.2       , 0.27272727, 0.33333333]])</span>
</pre></div>
</div>
<p>Here, broadcasting takes care of the different dimensions. Several other
classes are also possible.</p>
</div>
<div class="section" id="using-arithmetic-classmethods">
<h2>Using Arithmetic Classmethods<a class="headerlink" href="#using-arithmetic-classmethods" title="Permalink to this headline">¶</a></h2>
<p>Here both operands do not need to be <a class="reference internal" href="../../api/astropy.nddata.NDDataRef.html#astropy.nddata.NDDataRef" title="astropy.nddata.NDDataRef"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDDataRef</span></code></a>-like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">NDDataRef</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="go">NDDataRef(4)</span>
</pre></div>
</div>
<p>To wrap the result of an arithmetic operation between two Quantities:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="o">.</span><span class="n">multiply</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span>  
<span class="go">NDDataRef([10., 40.], unit=&#39;cm m&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">unit</span>
<span class="go">Unit(&quot;cm m&quot;)</span>
</pre></div>
</div>
<p>Or take the inverse of an <a class="reference internal" href="../../api/astropy.nddata.NDDataRef.html#astropy.nddata.NDDataRef" title="astropy.nddata.NDDataRef"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDDataRef</span></code></a> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">NDDataRef</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndd1</span><span class="p">)</span>  
<span class="go">NDDataRef([1.        , 0.5       , 0.33333333, 0.25      ])</span>
</pre></div>
</div>
<div class="section" id="possible-operands">
<h3>Possible Operands<a class="headerlink" href="#possible-operands" title="Permalink to this headline">¶</a></h3>
<p>The possible types of input for operands are:</p>
<ul class="simple">
<li><p>Scalars of any type</p></li>
<li><p>Lists containing numbers (or nested lists)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> masked arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy</span></code> quantities</p></li>
<li><p>Other <code class="docutils literal notranslate"><span class="pre">nddata</span></code> classes or subclasses</p></li>
</ul>
</div>
</div>
<div class="section" id="advanced-options">
<h2>Advanced Options<a class="headerlink" href="#advanced-options" title="Permalink to this headline">¶</a></h2>
<p>The normal Python operators <code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code>, etc. are not implemented because
the methods provide several options on how to proceed with the additional
attributes.</p>
<div class="section" id="data-and-unit">
<h3>Data and Unit<a class="headerlink" href="#data-and-unit" title="Permalink to this headline">¶</a></h3>
<p>For <code class="docutils literal notranslate"><span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">unit</span></code> there are no parameters. Every arithmetic
operation lets the <a class="reference internal" href="../../api/astropy.units.Quantity.html#astropy.units.Quantity" title="astropy.units.Quantity"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.units.Quantity</span></code></a>-framework evaluate the result
or fail and abort the operation.</p>
<p>Adding two <a class="reference internal" href="../../api/astropy.nddata.NDData.html#astropy.nddata.NDData" title="astropy.nddata.NDData"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDData</span></code></a> objects with the same unit works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">500</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span> <span class="o">=</span> <span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">data</span>  
<span class="go">array([101., 152., 203.,  54., 505.])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">unit</span>
<span class="go">Unit(&quot;m&quot;)</span>
</pre></div>
</div>
<p>Adding two <a class="reference internal" href="../../api/astropy.nddata.NDData.html#astropy.nddata.NDData" title="astropy.nddata.NDData"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDData</span></code></a> objects with compatible units also works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="n">ndd1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;pc&#39;</span><span class="p">)</span>
<span class="go">INFO: overwriting NDData&#39;s current unit with specified unit. [astropy.nddata.nddata]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;lyr&#39;</span><span class="p">)</span>
<span class="go">INFO: overwriting NDData&#39;s current unit with specified unit. [astropy.nddata.nddata]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span> <span class="o">=</span> <span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">data</span>  
<span class="go">array([ -29.66013938,  -43.99020907,  -58.32027876,  -11.33006969,</span>
<span class="go">       -148.30069689])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">unit</span>
<span class="go">Unit(&quot;pc&quot;)</span>
</pre></div>
</div>
<p>This will keep by default the unit of the first operand. However, units will
not be decomposed during division:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span> <span class="o">=</span> <span class="n">ndd2</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ndd1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">data</span>  
<span class="go">array([100.        ,  75.        ,  66.66666667,  12.5       , 100.        ])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd</span><span class="o">.</span><span class="n">unit</span>
<span class="go">Unit(&quot;lyr / pc&quot;)</span>
</pre></div>
</div>
</div>
<div class="section" id="mask">
<h3>Mask<a class="headerlink" href="#mask" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">handle_mask</span></code> parameter for the arithmetic operations implements what the
resulting mask will be. There are several options.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code>, the result will have no <code class="docutils literal notranslate"><span class="pre">mask</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;first_found&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;ff&quot;</span></code>, the result will have the <code class="docutils literal notranslate"><span class="pre">mask</span></code> of the first
operand or if that is <code class="docutils literal notranslate"><span class="pre">None</span></code>, the <code class="docutils literal notranslate"><span class="pre">mask</span></code> of the second operand:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_mask</span><span class="o">=</span><span class="s2">&quot;first_found&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd3</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_mask</span><span class="o">=</span><span class="s2">&quot;first_found&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">False</span>
</pre></div>
</div>
</li>
<li><p>A function (or an arbitrary callable) that takes at least two arguments.
For example, <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.logical_or.html#numpy.logical_or" title="(in NumPy v1.22)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.logical_or</span></code></a> is the default:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">array([ True, False,  True,  True]...)</span>
</pre></div>
</div>
<p>This defaults to <code class="docutils literal notranslate"><span class="pre">&quot;first_found&quot;</span></code> in case only one <code class="docutils literal notranslate"><span class="pre">mask</span></code> is not None:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">array([ True, False, False,  True]...)</span>
</pre></div>
</div>
<p>Custom functions are also possible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">take_alternating_values</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mask1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">result</span><span class="p">[</span><span class="n">start</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask1</span><span class="p">[</span><span class="n">start</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">result</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask2</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>This function is nonsense, but we can still see how it performs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_mask</span><span class="o">=</span><span class="n">take_alternating_values</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">array([ True, False,  True,  True]...)</span>
</pre></div>
</div>
<p>Additional parameters can be given by prefixing them with <code class="docutils literal notranslate"><span class="pre">mask_</span></code>
(which will be stripped before passing it to the function):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_mask</span><span class="o">=</span><span class="n">take_alternating_values</span><span class="p">,</span> <span class="n">mask_start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">array([False, False, False, False]...)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_mask</span><span class="o">=</span><span class="n">take_alternating_values</span><span class="p">,</span> <span class="n">mask_start</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
<span class="go">array([False, False,  True,  True]...)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="meta">
<h3>Meta<a class="headerlink" href="#meta" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">handle_meta</span></code> parameter for the arithmetic operations implements what the
resulting <code class="docutils literal notranslate"><span class="pre">meta</span></code> will be. The options are the same as for the <code class="docutils literal notranslate"><span class="pre">mask</span></code>:</p>
<ul>
<li><p>If <code class="docutils literal notranslate"><span class="pre">None</span></code> the resulting <code class="docutils literal notranslate"><span class="pre">meta</span></code> will be an empty <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.OrderedDict" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">collections.OrderedDict</span></code></a>.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="s1">&#39;sun&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="s1">&#39;moon&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_meta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span>
<span class="go">OrderedDict()</span>
</pre></div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">meta</span></code> this is the default so you do not need to pass it in this case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span>
<span class="go">OrderedDict()</span>
</pre></div>
</div>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">&quot;first_found&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;ff&quot;</span></code>, the resulting <code class="docutils literal notranslate"><span class="pre">meta</span></code> will be the <code class="docutils literal notranslate"><span class="pre">meta</span></code>
of the first operand or if that contains no keys, the <code class="docutils literal notranslate"><span class="pre">meta</span></code> of the second
operand is taken.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="s1">&#39;sun&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="s1">&#39;moon&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_meta</span><span class="o">=</span><span class="s1">&#39;ff&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span>
<span class="go">{&#39;object&#39;: &#39;sun&#39;}</span>
</pre></div>
</div>
</li>
<li><p>If it is a <code class="docutils literal notranslate"><span class="pre">callable</span></code> it must take at least two arguments. Both <code class="docutils literal notranslate"><span class="pre">meta</span></code>
attributes will be passed to this function (even if one or both of them are
empty) and the callable evaluates the result’s <code class="docutils literal notranslate"><span class="pre">meta</span></code>. For example, a
function that merges these two:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># It&#39;s expected with arithmetics that the result is not a reference,</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># so we need to copy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">combine_meta</span><span class="p">(</span><span class="n">meta1</span><span class="p">,</span> <span class="n">meta2</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">meta1</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">meta2</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">elif</span> <span class="ow">not</span> <span class="n">meta2</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">meta1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">meta_final</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">meta1</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">meta_final</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta2</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">meta_final</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;today&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="s1">&#39;moon&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">handle_meta</span><span class="o">=</span><span class="n">combine_meta</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span> 
<span class="go">{&#39;object&#39;: &#39;moon&#39;, &#39;time&#39;: &#39;today&#39;}</span>
</pre></div>
</div>
<p>Here again additional arguments for the function can be passed in using
the prefix <code class="docutils literal notranslate"><span class="pre">meta_</span></code> (which will be stripped away before passing it to this
function). See the description for the mask-attribute for further details.</p>
</li>
</ul>
<div class="section" id="world-coordinate-system-wcs">
<h4>World Coordinate System (WCS)<a class="headerlink" href="#world-coordinate-system-wcs" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">compare_wcs</span></code> argument will determine what the result’s <code class="docutils literal notranslate"><span class="pre">wcs</span></code> will be
or if the operation should be forbidden. The possible values are identical to
<code class="docutils literal notranslate"><span class="pre">mask</span></code> and <code class="docutils literal notranslate"><span class="pre">meta</span></code>:</p>
<ul>
<li><p>If <code class="docutils literal notranslate"><span class="pre">None</span></code> the resulting <code class="docutils literal notranslate"><span class="pre">wcs</span></code> will be an empty <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">WCS</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">compare_wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
</pre></div>
</div>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">&quot;first_found&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;ff&quot;</span></code> the resulting <code class="docutils literal notranslate"><span class="pre">wcs</span></code> will be the <code class="docutils literal notranslate"><span class="pre">wcs</span></code> of
the first operand or if that is <code class="docutils literal notranslate"><span class="pre">None</span></code>, the <code class="docutils literal notranslate"><span class="pre">meta</span></code> of the second operand
is taken.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">compare_wcs</span><span class="o">=</span><span class="s1">&#39;ff&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</li>
<li><p>If it is a <code class="docutils literal notranslate"><span class="pre">callable</span></code> it must take at least two arguments. Both <code class="docutils literal notranslate"><span class="pre">wcs</span></code>
attributes will be passed to this function (even if one or both of them are
<code class="docutils literal notranslate"><span class="pre">None</span></code>) and the callable should return <code class="docutils literal notranslate"><span class="pre">True</span></code> if these <code class="docutils literal notranslate"><span class="pre">wcs</span></code> are
identical (enough) to allow the arithmetic operation or <code class="docutils literal notranslate"><span class="pre">False</span></code> if the
arithmetic operation should be aborted with a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>. If <code class="docutils literal notranslate"><span class="pre">True</span></code> the
<code class="docutils literal notranslate"><span class="pre">wcs</span></code> are identical and the first one is used for the result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">compare_wcs_scalar</span><span class="p">(</span><span class="n">wcs1</span><span class="p">,</span> <span class="n">wcs2</span><span class="p">,</span> <span class="n">allowed_deviation</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">wcs1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wcs2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># both have no WCS so they are identical</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">wcs1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">wcs2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># one has WCS, the other doesn&#39;t not possible</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c1"># Consider wcs close if centers are close enough</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wcs1</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">-</span> <span class="n">wcs2</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">allowed_deviation</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">compare_wcs</span><span class="o">=</span><span class="n">compare_wcs_scalar</span><span class="p">)</span><span class="o">.</span><span class="n">wcs</span>
</pre></div>
</div>
<p>Additional arguments can be passed in prefixing them with <code class="docutils literal notranslate"><span class="pre">wcs_</span></code> (this
prefix will be stripped away before passing it to the function):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">WCS</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">WCS</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">compare_wcs</span><span class="o">=</span><span class="n">compare_wcs_scalar</span><span class="p">,</span> <span class="n">wcs_allowed_deviation</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span>
<span class="go">array([1., 1.])</span>
</pre></div>
</div>
<p>If you are using <a class="reference internal" href="../../api/astropy.wcs.WCS.html#astropy.wcs.WCS" title="astropy.wcs.WCS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">WCS</span></code></a> objects, a very handy function to use
might be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">wcs_compare</span><span class="p">(</span><span class="n">wcs1</span><span class="p">,</span> <span class="n">wcs2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">wcs1</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">wcs2</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="../../api/astropy.wcs.Wcsprm.html#astropy.wcs.Wcsprm.compare" title="astropy.wcs.Wcsprm.compare"><code class="xref py py-meth docutils literal notranslate"><span class="pre">astropy.wcs.Wcsprm.compare()</span></code></a> for the arguments this comparison
allows.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="uncertainty">
<h3>Uncertainty<a class="headerlink" href="#uncertainty" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">propagate_uncertainties</span></code> argument can be used to turn the propagation
of uncertainties on or off.</p>
<ul>
<li><p>If <code class="docutils literal notranslate"><span class="pre">None</span></code> the result will have no uncertainty:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">propagate_uncertainties</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
</pre></div>
</div>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">False</span></code> the result will have the first found uncertainty.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Setting <code class="docutils literal notranslate"><span class="pre">propagate_uncertainties=False</span></code> is generally not
recommended.</p>
</div>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">True</span></code> both uncertainties must be <code class="docutils literal notranslate"><span class="pre">NDUncertainty</span></code> subclasses that
implement propagation. This is possible for
<a class="reference internal" href="../../api/astropy.nddata.StdDevUncertainty.html#astropy.nddata.StdDevUncertainty" title="astropy.nddata.StdDevUncertainty"><code class="xref py py-obj docutils literal notranslate"><span class="pre">StdDevUncertainty</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">10</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">10</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">propagate_uncertainties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">uncertainty</span>  
<span class="go">StdDevUncertainty([14.14213562])</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="uncertainty-with-correlation">
<h3>Uncertainty with Correlation<a class="headerlink" href="#uncertainty-with-correlation" title="Permalink to this headline">¶</a></h3>
<p>If <code class="docutils literal notranslate"><span class="pre">propagate_uncertainties</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code> you can also give an argument
for <code class="docutils literal notranslate"><span class="pre">uncertainty_correlation</span></code>. <a class="reference internal" href="../../api/astropy.nddata.StdDevUncertainty.html#astropy.nddata.StdDevUncertainty" title="astropy.nddata.StdDevUncertainty"><code class="xref py py-obj docutils literal notranslate"><span class="pre">StdDevUncertainty</span></code></a> cannot
keep track of its correlations by itself, but it can evaluate the correct
resulting uncertainty if the correct <code class="docutils literal notranslate"><span class="pre">correlation</span></code> is given.</p>
<p>The default (<code class="docutils literal notranslate"><span class="pre">0</span></code>) represents uncorrelated while <code class="docutils literal notranslate"><span class="pre">1</span></code> means correlated and
<code class="docutils literal notranslate"><span class="pre">-1</span></code> anti-correlated. If given a <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> it should represent the
element-wise correlation coefficient.</p>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<p>Without correlation, subtracting an <a class="reference internal" href="../../api/astropy.nddata.NDDataRef.html#astropy.nddata.NDDataRef" title="astropy.nddata.NDDataRef"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NDDataRef</span></code></a> instance from
itself results in a non-zero uncertainty:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">10</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd1</span><span class="p">,</span> <span class="n">propagate_uncertainties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">uncertainty</span>  
<span class="go">StdDevUncertainty([14.14213562])</span>
</pre></div>
</div>
<p>Given a correlation of <code class="docutils literal notranslate"><span class="pre">1</span></code> (because they clearly correlate) gives the
correct uncertainty of <code class="docutils literal notranslate"><span class="pre">0</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">10</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd1</span><span class="p">,</span> <span class="n">propagate_uncertainties</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>              <span class="n">uncertainty_correlation</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">uncertainty</span>  
<span class="go">StdDevUncertainty([0.])</span>
</pre></div>
</div>
<p>Which would be consistent with the equivalent operation <code class="docutils literal notranslate"><span class="pre">ndd1</span> <span class="pre">*</span> <span class="pre">0</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">propagate_uncertainties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">uncertainty</span> 
<span class="go">StdDevUncertainty([0.])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The user needs to calculate or know the appropriate value or array manually
and pass it to <code class="docutils literal notranslate"><span class="pre">uncertainty_correlation</span></code>. The implementation follows
general first order error propagation formulas. See, for example:
<a class="reference external" href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty#Example_formulas">Wikipedia</a>.</p>
</div>
<p>You can also give element-wise correlations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span><span class="n">uncertainty_correlation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">uncertainty</span>  
<span class="go">StdDevUncertainty([3.        , 2.64575131, 2.23606798, 1.        ])</span>
</pre></div>
</div>
<p>The correlation <code class="docutils literal notranslate"><span class="pre">np.array([1,</span> <span class="pre">0.5,</span> <span class="pre">0,</span> <span class="pre">-1])</span></code> would indicate that the first
element is fully correlated and the second element partially correlates, while
the third element is uncorrelated, and the fourth is anti-correlated.</p>
</div>
</div>
<div class="section" id="uncertainty-with-unit">
<h3>Uncertainty with Unit<a class="headerlink" href="#uncertainty-with-unit" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../../api/astropy.nddata.StdDevUncertainty.html#astropy.nddata.StdDevUncertainty" title="astropy.nddata.StdDevUncertainty"><code class="xref py py-obj docutils literal notranslate"><span class="pre">StdDevUncertainty</span></code></a> implements correct error propagation even
if the unit of the data differs from the unit of the uncertainty:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">10</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">10</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;cm&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd2</span> <span class="o">=</span> <span class="n">NDDataRef</span><span class="p">([</span><span class="mi">20</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">([</span><span class="mi">10</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ndd1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ndd2</span><span class="p">,</span> <span class="n">propagate_uncertainties</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">uncertainty</span>  
<span class="go">StdDevUncertainty([10.00049999])</span>
</pre></div>
</div>
<p>But it needs to be convertible to the unit for the data.</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">NDData Arithmetic</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#using-basic-arithmetic-methods">Using Basic Arithmetic Methods</a></li>
<li><a class="reference internal" href="#using-arithmetic-classmethods">Using Arithmetic Classmethods</a><ul>
<li><a class="reference internal" href="#possible-operands">Possible Operands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-options">Advanced Options</a><ul>
<li><a class="reference internal" href="#data-and-unit">Data and Unit</a></li>
<li><a class="reference internal" href="#mask">Mask</a></li>
<li><a class="reference internal" href="#meta">Meta</a><ul>
<li><a class="reference internal" href="#world-coordinate-system-wcs">World Coordinate System (WCS)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#uncertainty">Uncertainty</a></li>
<li><a class="reference internal" href="#uncertainty-with-correlation">Uncertainty with Correlation</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#uncertainty-with-unit">Uncertainty with Unit</a></li>
</ul>
</li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../_sources/nddata/mixins/ndarithmetic.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011–2022, The Astropy Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.5.4. &nbsp;
    Last built 08 May 2022. <br/>
  </p>
</footer>
  </body>
</html>