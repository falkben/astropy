


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Obtaining subsets from cloud-hosted FITS files &#8212; Astropy v5.2.dev96+g04a0cf8bb</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="astropy.io.fits FAQ" href="../appendix/faq.html" />
    <link rel="prev" title="Miscellaneous Features" href="misc.html" />
  
  <meta name="robots" content="noindex, nofollow">
  
  
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>


  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="../appendix/faq.html" title="astropy.io.fits FAQ">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="misc.html" title="Miscellaneous Features">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../../index.html">Astropy v5.2.dev96+g04a0cf8bb</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">FITS File Handling (<code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.io.fits</span></code>)</a> &#187;</li>
      
      <li>Obtaining subsets from cloud-hosted FITS files</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="obtaining-subsets-from-cloud-hosted-fits-files">
<span id="fits-io-cloud"></span><h1>Obtaining subsets from cloud-hosted FITS files<a class="headerlink" href="#obtaining-subsets-from-cloud-hosted-fits-files" title="Permalink to this headline">¶</a></h1>
<p>Astropy offers support for extracting data from FITS files stored in the cloud.
Specifically, the <a class="reference internal" href="../api/files.html#astropy.io.fits.open" title="astropy.io.fits.open"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.io.fits.open</span></code></a> function accepts the <code class="docutils literal notranslate"><span class="pre">use_fsspec</span></code>
and <code class="docutils literal notranslate"><span class="pre">fsspec_kwargs</span></code> parameters, which allow remote files to be accessed in an
efficient way using the <a class="reference external" href="https://filesystem-spec.readthedocs.io">fsspec</a>
package.</p>
<p><code class="docutils literal notranslate"><span class="pre">fsspec</span></code> is an optional dependency of Astropy which supports reading
files from a range of remote and distributed storage backends, such as Amazon
and Google Cloud Storage.  This chapter explains its use.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The examples in this chapter require <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> which is an optional
dependency of Astropy.  See <a class="reference internal" href="../../../install.html#installing-astropy"><span class="std std-ref">Installing astropy</span></a> for details on
installing optional dependencies.</p>
</div>
<div class="section" id="subsetting-fits-files-hosted-on-an-http-web-server">
<h2>Subsetting FITS files hosted on an HTTP web server<a class="headerlink" href="#subsetting-fits-files-hosted-on-an-http-web-server" title="Permalink to this headline">¶</a></h2>
<p>A common use case for <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> is to read subsets of FITS data from a web
server which supports serving partial files via the
<a class="reference external" href="https://en.wikipedia.org/wiki/Byte_serving">Range Requests</a> feature of the
HTTP protocol.  Most web servers support serving portions of files in this way.</p>
<p>For example, let’s assume you want to retrieve data from a large image obtained
by the Hubble Space Telescope available at the following url:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download link for a large Hubble archive image (213 MB)</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://mast.stsci.edu/api/v0.1/Download/file/?uri=mast:HST/product/j8pu0y010_drc.fits&quot;</span>
</pre></div>
</div>
<p>This file can be opened by passing the url to <a class="reference internal" href="../api/files.html#astropy.io.fits.open" title="astropy.io.fits.open"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.io.fits.open</span></code></a>.
By default, Astropy will download the entire file to local disc before opening
it.  This works fine for small files but tends to require a lot of time and
memory for large files.</p>
<p>You can improve the performance for large files by passing the parameters
<code class="docutils literal notranslate"><span class="pre">use_fsspec=True</span></code> and <code class="docutils literal notranslate"><span class="pre">lazy_load_hdus=True</span></code> to <a class="reference internal" href="../api/files.html#astropy.io.fits.open" title="astropy.io.fits.open"><code class="xref py py-obj docutils literal notranslate"><span class="pre">open</span></code></a>.  This will make
Astropy use <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> to download only the necessary parts of the FITS file.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="c1"># `fits.open` will download the primary header</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">use_fsspec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lazy_load_hdus</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>

    <span class="c1"># Download a single header</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="c1"># Download a single data array</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Download a 10-by-20 pixel cutout by using .section</span>
    <span class="n">cutout</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span>
</pre></div>
</div>
<p>The example above requires less time and memory than would be required to
download the entire file. This is because <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> is able to leverage
two <em>lazy data loading</em> features available in Astropy:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">lazy_load_hdus</span></code> parameter takes care of loading HDU header and data
attributes on demand rather than reading all HDUs at once.  This parameter
is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> by default. You do not need to pass it explicitely,
unless you changed its default value in the <a class="reference internal" href="../../../config/index.html#astropy-config"><span class="std std-ref">Configuration System (astropy.config)</span></a>.</p></li>
<li><p>The <a class="reference internal" href="../api/images.html#astropy.io.fits.ImageHDU.section" title="astropy.io.fits.ImageHDU.section"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ImageHDU.section</span></code></a> property enables a subset of a data array to be
read into memory without downloading the entire image or cube. See the
<a class="reference internal" href="image.html#data-sections"><span class="std std-ref">Data Sections</span></a> part of the documentation for more details.</p></li>
</ol>
<p>Additional tips for achieving good performance when working with remote files
are provided in the <a class="reference internal" href="#optimizing-fsspec"><span class="std std-ref">Performance improvement tips for subsetting remote FITS files</span></a> section further down
this page.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference internal" href="../api/images.html#astropy.io.fits.ImageHDU.section" title="astropy.io.fits.ImageHDU.section"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ImageHDU.section</span></code></a> feature is only available for uncompressed FITS
image extensions.  Attempting to use <code class="docutils literal notranslate"><span class="pre">.section</span></code> on a compressed image
will yield an <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#AttributeError" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">AttributeError</span></code></a>.</p>
</div>
</div>
<div class="section" id="subsetting-fits-files-hosted-in-amazon-s3-cloud-storage">
<h2>Subsetting FITS files hosted in Amazon S3 cloud storage<a class="headerlink" href="#subsetting-fits-files-hosted-in-amazon-s3-cloud-storage" title="Permalink to this headline">¶</a></h2>
<p>The FITS file used in the example above also happens to be available via
Amazon cloud storage, where it is stored in a
<a class="reference external" href="https://registry.opendata.aws/hst/">public S3 bucket</a> at the following
location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s3_uri</span> <span class="o">=</span> <span class="s2">&quot;s3://stpubdata/hst/public/j8pu/j8pu0y010/j8pu0y010_drc.fits&quot;</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">use_fsspec</span></code> enabled, you can obtain a small cutout from a file stored
in Amazon S3 cloud storage in the same way as above.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download a small 10-by-20 pixel cutout from a FITS file stored in Amazon S3</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">,</span> <span class="n">use_fsspec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fsspec_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;anon&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">cutout</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To open paths with prefix <code class="docutils literal notranslate"><span class="pre">s3://</span></code>, fsspec requires an optional dependency called
<code class="docutils literal notranslate"><span class="pre">s3fs</span></code>.  A <code class="docutils literal notranslate"><span class="pre">ModuleNotFoundError</span></code> will be raised if this dependency is
missing. See <a class="reference internal" href="../../../install.html#installing-astropy"><span class="std std-ref">Installing astropy</span></a> for details on installing optional
dependencies.</p>
</div>
<div class="section" id="working-with-amazon-s3-access-credentials">
<h3>Working with Amazon S3 access credentials<a class="headerlink" href="#working-with-amazon-s3-access-credentials" title="Permalink to this headline">¶</a></h3>
<p>Note that we used the <code class="docutils literal notranslate"><span class="pre">fsspec_kwargs</span></code> parameter in the example above to pass
extra arguments to the <a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/api.html#fsspec.open" title="(in fsspec v2022.3.0+15.gc18902b.dirty)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">fsspec.open</span></code></a> function.  Specifically, we passed the
<code class="docutils literal notranslate"><span class="pre">anon=True</span></code> parameter to indicate that we want to retrieve data in an
anonymous way without providing Amazon cloud access credentials.
For convenience, Astropy will pass <code class="docutils literal notranslate"><span class="pre">anon=True</span></code> by default if a path starts
with <code class="docutils literal notranslate"><span class="pre">s3://</span></code> and <code class="docutils literal notranslate"><span class="pre">fsspec_kwargs</span></code> is unspecified.</p>
<p>In some cases you may want to access data stored in an Amazon S3 data bucket
that is private or uses the “Requester Pays” feature. You will have to provide
a secret access key in this case. You can use the <code class="docutils literal notranslate"><span class="pre">fsspec_kwargs</span></code> parameter
to provide your key as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fsspec_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;YOUR-SECRET-KEY-ID&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;secret&quot;</span><span class="p">:</span> <span class="s2">&quot;YOUR-SECRET-KEY&quot;</span><span class="p">}</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">,</span> <span class="n">use_fsspec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fsspec_kwargs</span><span class="o">=</span><span class="n">fsspec_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">cutout</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Including secret access keys inside Python code is dangerous because you
may accidentally end up revealing your keys when you share your code with
others. A better practice is to store your access keys via a configuration
file or environment variables. See the <code class="docutils literal notranslate"><span class="pre">s3fs</span></code> documentation for guidance.</p>
</div>
</div>
</div>
<div class="section" id="using-cutout2d-with-cloud-hosted-fits-files">
<h2>Using <a class="reference internal" href="../../../api/astropy.nddata.Cutout2D.html#astropy.nddata.Cutout2D" title="astropy.nddata.Cutout2D"><code class="xref py py-class docutils literal notranslate"><span class="pre">Cutout2D</span></code></a> with cloud-hosted FITS files<a class="headerlink" href="#using-cutout2d-with-cloud-hosted-fits-files" title="Permalink to this headline">¶</a></h2>
<p>The examples above used the <a class="reference internal" href="../api/images.html#astropy.io.fits.ImageHDU.section" title="astropy.io.fits.ImageHDU.section"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ImageHDU.section</span></code></a> feature to download
small cutouts given a set of pixel coordinates. For astronomical images it is
often more convenient to obtain cutouts based on a sky position and angular
size rather than array coordinates. For this reason, Astropy provides the
<a class="reference internal" href="../../../api/astropy.nddata.Cutout2D.html#astropy.nddata.Cutout2D" title="astropy.nddata.Cutout2D"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.nddata.Cutout2D</span></code></a> tool which makes it easy to obtain cutouts informed
by an image’s World Coordinate System (<a class="reference internal" href="../../../api/astropy.wcs.WCS.html#astropy.wcs.WCS" title="astropy.wcs.WCS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">WCS</span></code></a>).</p>
<p>This cutout tool can be used in combination with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> and <a class="reference internal" href="../api/hdus.html#astropy.io.fits.PrimaryHDU.section" title="astropy.io.fits.PrimaryHDU.section"><code class="xref py py-obj docutils literal notranslate"><span class="pre">section</span></code></a>.
For example, assume you happen to know that the image we opened above contains
a nice edge-on galaxy at the following position:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Approximate location of an edge-on galaxy</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;10h01m41.13s 02d25m20.58s&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We also know that the radius of the galaxy is approximately 5 arcseconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Approximate size of the galaxy</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
</pre></div>
</div>
<p>Given this sky position and radius, we can use <a class="reference internal" href="../../../api/astropy.nddata.Cutout2D.html#astropy.nddata.Cutout2D" title="astropy.nddata.Cutout2D"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Cutout2D</span></code></a>
in combination with <code class="docutils literal notranslate"><span class="pre">use_fsspec=True</span></code> and <a class="reference internal" href="../api/hdus.html#astropy.io.fits.PrimaryHDU.section" title="astropy.io.fits.PrimaryHDU.section"><code class="xref py py-obj docutils literal notranslate"><span class="pre">section</span></code></a> as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">,</span> <span class="n">use_fsspec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">cutout</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">,</span>  <span class="c1"># use `.section` rather than `.data`!</span>
                      <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                      <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                      <span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
</pre></div>
</div>
<p>As a final step, you can plot the cutout using Matplotlib as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">astropy_mpl_style</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">astropy_mpl_style</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cutout</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="../../../nddata/utils.html#cutout-images"><span class="std std-ref">2D Cutout Images</span></a> for more details on this feature.</p>
</div>
<div class="section" id="performance-improvement-tips-for-subsetting-remote-fits-files">
<span id="optimizing-fsspec"></span><h2>Performance improvement tips for subsetting remote FITS files<a class="headerlink" href="#performance-improvement-tips-for-subsetting-remote-fits-files" title="Permalink to this headline">¶</a></h2>
<p>In the examples above we explained that it is important to use the
<code class="docutils literal notranslate"><span class="pre">use_fsspec=True</span></code> feature in combination with the <code class="docutils literal notranslate"><span class="pre">lazy_load_hdus=True</span></code>
parameter and the <code class="docutils literal notranslate"><span class="pre">ImageHDU.section</span></code> feature to obtain good performance.</p>
<p>There are two additional factors which significantly impact the performance
you will encounter, namely: (i) the structure of the FITS file, and (ii) the caching
and block size configuration of <code class="docutils literal notranslate"><span class="pre">fsspec</span></code>.  The remainder of this section
briefly explains these two factors.</p>
<div class="section" id="matching-the-fits-file-structure-to-the-data-slicing-patterns">
<h3>Matching the FITS file structure to the data slicing patterns<a class="headerlink" href="#matching-the-fits-file-structure-to-the-data-slicing-patterns" title="Permalink to this headline">¶</a></h3>
<p>The order in which multi-dimensional data is organized inside FITS files plays
a major role in the subsetting performance.</p>
<p>Astropy uses the row-major order for indexing FITS data. This means that the
right-most axis is the one that varies the fastest inside the file.
Put differently, the data for the right-most dimension tends to be located in
contiguous regions of the file and is therefore the easiest to extract.</p>
<p>For example, in the case of a 2D image, the slice <code class="docutils literal notranslate"><span class="pre">.section[0,</span> <span class="pre">:]</span></code> can be
obtained by downloading one contiguous region of bytes from the file.
In contrast, the slice <code class="docutils literal notranslate"><span class="pre">.section[:,</span> <span class="pre">0]</span></code> requires accessing bytes spread
across the entire image array. The same is true for higher dimensions,
for example, obtaining the slice <code class="docutils literal notranslate"><span class="pre">.section[0,</span> <span class="pre">:,</span> <span class="pre">:]</span></code> from a 3D cube
will tend to be much faster than requesting <code class="docutils literal notranslate"><span class="pre">.section[:,</span> <span class="pre">:,</span> <span class="pre">0]</span></code>.</p>
<p>Obtaining slices of data that are well matched to the internal layout of
the FITS file generally yields the best performance.
If subsetting performance is important to you, you may have to consider
modifying your FITS files to ensure that the ordering of the dimensions
is well-matched to your data slicing patterns.</p>
</div>
<div class="section" id="configuring-the-fsspec-block-size-and-download-strategy">
<h3>Configuring the <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> block size and download strategy<a class="headerlink" href="#configuring-the-fsspec-block-size-and-download-strategy" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> package supports different data reading and caching strategies
which aim to minimize the number of network requests.  In general, fsspec
will attempt to download data in large contiguous blocks, similar to the
<em>read ahead</em> strategy that is employed by operating systems when they load
local files.</p>
<p>You can tune the performance of fsspec’s download strategy by passing custom
<code class="docutils literal notranslate"><span class="pre">block_size</span></code> and <code class="docutils literal notranslate"><span class="pre">cache_type</span></code> parameters to <a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/api.html#fsspec.open" title="(in fsspec v2022.3.0+15.gc18902b.dirty)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">fsspec.open</span></code></a>.  You can pass
these parameters via the <code class="docutils literal notranslate"><span class="pre">fsspec_kwargs</span></code> argument of <a class="reference internal" href="../api/files.html#astropy.io.fits.open" title="astropy.io.fits.open"><code class="xref py py-obj docutils literal notranslate"><span class="pre">astropy.io.fits.open</span></code></a>.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access remote data using HTTP requests at least 1 MB or more in size</span>
<span class="n">fsspec_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;block_size&quot;</span><span class="p">:</span> <span class="mi">1_000_000</span><span class="p">,</span> <span class="s2">&quot;cache_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bytes&quot;</span><span class="p">}</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">use_fsspec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fsspec_kwargs</span><span class="o">=</span><span class="n">fsspec_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
    <span class="n">cutout</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span>
</pre></div>
</div>
<p>See the <a class="reference external" href="https://filesystem-spec.readthedocs.io">fsspec documentation</a>
for more information on its options.</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Obtaining subsets from cloud-hosted FITS files</a><ul>
<li><a class="reference internal" href="#subsetting-fits-files-hosted-on-an-http-web-server">Subsetting FITS files hosted on an HTTP web server</a></li>
<li><a class="reference internal" href="#subsetting-fits-files-hosted-in-amazon-s3-cloud-storage">Subsetting FITS files hosted in Amazon S3 cloud storage</a><ul>
<li><a class="reference internal" href="#working-with-amazon-s3-access-credentials">Working with Amazon S3 access credentials</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-cutout2d-with-cloud-hosted-fits-files">Using <code class="xref py py-class docutils literal notranslate"><span class="pre">Cutout2D</span></code> with cloud-hosted FITS files</a></li>
<li><a class="reference internal" href="#performance-improvement-tips-for-subsetting-remote-fits-files">Performance improvement tips for subsetting remote FITS files</a><ul>
<li><a class="reference internal" href="#matching-the-fits-file-structure-to-the-data-slicing-patterns">Matching the FITS file structure to the data slicing patterns</a></li>
<li><a class="reference internal" href="#configuring-the-fsspec-block-size-and-download-strategy">Configuring the <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> block size and download strategy</a></li>
</ul>
</li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../../_sources/io/fits/usage/cloud.rst.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011–2022, The Astropy Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.5.4. &nbsp;
    Last built 09 May 2022. <br/>
  </p>
</footer>
  </body>
</html>